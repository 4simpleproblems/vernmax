<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vern Max Browser</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" type="image/x-icon" href="logo.png" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet" />

    <style id="custom-styles">
        /* Base Elements */
        :root {
            --bg-color: #1a1a1a;
            --text-color: #fff;
            --navbar-bg: rgba(15, 15, 15, 1);
            --navbar-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            --button-bg: rgba(10, 10, 10, 0.8);
            --button-hover-bg: rgba(15, 15, 15, 0.9);
            --input-bg: rgba(10, 10, 10, 0.8);
            --input-focus-bg: rgba(45, 45, 45, 0.9);
            --input-focus-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3); /* Changed to 2px for consistency */
            --iframe-bg: #202020;
            --footer-text-color: #fff;
            --font-family-main: 'Roboto Mono', monospace;
            --tab-bg: rgba(25, 25, 25, 0.8);
            --tab-active-bg: rgba(45, 45, 45, 0.9);
            --tab-border: rgba(60, 60, 60, 0.5);
            --tab-hover-bg: rgba(35, 35, 35, 0.9);
            --sidebar-width: 280px;
            --sidebar-bg: rgba(10, 10, 10, 0.95);
            --sidebar-item-hover-bg: rgba(30, 30, 30, 0.9);
            --sidebar-border-color: rgba(255, 255, 255, 0.15); /* Unified border color */
            --sidebar-outline-color: rgba(255, 255, 255, 0.25); /* For pill outlines */
            --button-text-color: #fff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Existing Themes */
        body.theme-light {
            --bg-color: #f4f4f4;
            --text-color: #333;
            --navbar-bg: #ffffff;
            --navbar-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            --button-bg: #e0e0e0;
            --button-hover-bg: #d0d0d0;
            --input-bg: #ffffff;
            --input-focus-bg: #f0f0f0;
            --input-focus-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
            --iframe-bg: #ffffff;
            --footer-text-color: #555;
            --tab-bg: #e9e9e9;
            --tab-active-bg: #ffffff;
            --tab-border: #cccccc;
            --tab-hover-bg: #f5f5f5;
            --sidebar-bg: #f8f9fa;
            --sidebar-item-hover-bg: #e9ecef;
            --sidebar-border-color: #dee2e6;
            --sidebar-outline-color: #ced4da;
            --button-text-color: #333;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Blue Theme */
        body.theme-blue {
            --bg-color: #0d1b2a;
            --text-color: #e0e1dd;
            --navbar-bg: #1b263b;
            --navbar-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
            --button-bg: #415a77;
            --button-hover-bg: #778da9;
            --input-bg: #1b263b;
            --input-focus-bg: #415a77;
            --input-focus-shadow: 0 0 0 2px rgba(120, 150, 255, 0.4);
            --iframe-bg: #0d1b2a;
            --footer-text-color: #e0e1dd;
            --tab-bg: #2a3b4e;
            --tab-active-bg: #415a77;
            --tab-border: #566f8e;
            --tab-hover-bg: #3a4f66;
            --sidebar-bg: #101B27;
            --sidebar-item-hover-bg: #1b263b;
            --sidebar-border-color: rgba(255, 255, 255, 0.2);
            --sidebar-outline-color: rgba(255, 255, 255, 0.3);
            --button-text-color: #e0e1dd;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Orange Theme */
        body.theme-orange {
            --bg-color: #2c1a00;
            --text-color: #ffe8cc;
            --navbar-bg: #4d2d00;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.3);
            --button-bg: #e67e22;
            --button-hover-bg: #d35400;
            --input-bg: #4d2d00;
            --input-focus-bg: #663d00;
            --input-focus-shadow: 0 0 0 2px rgba(230, 126, 34, 0.5);
            --iframe-bg: #2c1a00;
            --footer-text-color: #ffe8cc;
            --tab-bg: #663d00;
            --tab-active-bg: #e67e22;
            --tab-border: #804c00;
            --tab-hover-bg: #805715;
            --sidebar-bg: #332000;
            --sidebar-item-hover-bg: #4d2d00;
            --sidebar-border-color: rgba(255, 232, 204, 0.2);
            --sidebar-outline-color: rgba(255, 232, 204, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Galaxy Theme */
        body.theme-galaxy {
            --bg-color: #0c0a1d;
            --text-color: #e6e0ff;
            --navbar-bg: #1c183c;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #7b68ee;
            --button-hover-bg: #6a5acd;
            --input-bg: #1c183c;
            --input-focus-bg: #2c284c;
            --input-focus-shadow: 0 0 0 2px rgba(123, 104, 238, 0.5);
            --iframe-bg: #0c0a1d;
            --footer-text-color: #e6e0ff;
            --tab-bg: #2c284c;
            --tab-active-bg: #7b68ee;
            --tab-border: #3c385c;
            --tab-hover-bg: #383464;
            --sidebar-bg: #120f2d;
            --sidebar-item-hover-bg: #1c183c;
            --sidebar-border-color: rgba(230, 224, 255, 0.2);
            --sidebar-outline-color: rgba(230, 224, 255, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Mint Green Theme */
        body.theme-mint {
            --bg-color: #e6fff5;
            --text-color: #004d33;
            --navbar-bg: #ccece6;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.1);
            --button-bg: #58d68d;
            --button-hover-bg: #48c97d;
            --input-bg: #ccece6;
            --input-focus-bg: #b3e0d9;
            --input-focus-shadow: 0 0 0 2px rgba(88, 214, 141, 0.4);
            --iframe-bg: #e6fff5;
            --footer-text-color: #004d33;
            --tab-bg: #b3e0d9;
            --tab-active-bg: #58d68d;
            --tab-border: #a3d9ce;
            --tab-hover-bg: #f5f5f5; /* Adjusted hover to be lighter */
            --sidebar-bg: #d9f7ef;
            --sidebar-item-hover-bg: #ccece6;
            --sidebar-border-color: #a3d9ce;
            --sidebar-outline-color: #7bc4b4;
            --button-text-color: #003322;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }


        /* Crimson Red Theme */
        body.theme-crimson {
            --bg-color: #2c0b0e;
            --text-color: #fde8e9;
            --navbar-bg: #4e1218;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #dc143c;
            --button-hover-bg: #c21034;
            --input-bg: #4e1218;
            --input-focus-bg: #6f1a24;
            --input-focus-shadow: 0 0 0 2px rgba(220, 20, 60, 0.5);
            --iframe-bg: #2c0b0e;
            --footer-text-color: #fde8e9;
            --tab-bg: #6f1a24;
            --tab-active-bg: #dc143c;
            --tab-border: #8f2a34;
            --tab-hover-bg: #8f2a34; /* Adjusted hover */
            --sidebar-bg: #3b1014;
            --sidebar-item-hover-bg: #4e1218;
            --sidebar-border-color: rgba(253, 232, 233, 0.2);
            --sidebar-outline-color: rgba(253, 232, 233, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Forest Green Theme */
        body.theme-forest {
            --bg-color: #0a1a0f;
            --text-color: #e0f0e3;
            --navbar-bg: #122f1a;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #228b22; /* Forest Green */
            --button-hover-bg: #1e721e; /* Darker Forest Green */
            --input-bg: #122f1a;
            --input-focus-bg: #1a4325;
            --input-focus-shadow: 0 0 0 2px rgba(34, 139, 34, 0.5);
            --iframe-bg: #0a1a0f;
            --footer-text-color: #e0f0e3;
            --tab-bg: #1a4325;
            --tab-active-bg: #228b22;
            --tab-border: #2a5335;
            --tab-hover-bg: #2a5335; /* Adjusted hover */
            --sidebar-bg: #0f2515;
            --sidebar-item-hover-bg: #122f1a;
            --sidebar-border-color: rgba(224, 240, 227, 0.2);
            --sidebar-outline-color: rgba(224, 240, 227, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Added Themes */
        /* Purple Theme */
        body.theme-purple {
            --bg-color: #1a0a1a;
            --text-color: #f0e0f0;
            --navbar-bg: #2f122f;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #8a2be2; /* Blue Violet */
            --button-hover-bg: #7b1eda; /* Darker Blue Violet */
            --input-bg: #2f122f;
            --input-focus-bg: #431a43;
            --input-focus-shadow: 0 0 0 2px rgba(138, 43, 226, 0.5);
            --iframe-bg: #1a0a1a;
            --footer-text-color: #f0e0f0;
            --tab-bg: #431a43;
            --tab-active-bg: #8a2be2;
            --tab-border: #532a53;
            --tab-hover-bg: #532a53;
            --sidebar-bg: #250f25;
            --sidebar-item-hover-bg: #2f122f;
            --sidebar-border-color: rgba(240, 224, 240, 0.2);
            --sidebar-outline-color: rgba(240, 224, 240, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Teal Theme */
        body.theme-teal {
            --bg-color: #0a1a1a;
            --text-color: #e0f0f0;
            --navbar-bg: #122f2f;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #008080; /* Teal */
            --button-hover-bg: #006666; /* Darker Teal */
            --input-bg: #122f2f;
            --input-focus-bg: #1a4343;
            --input-focus-shadow: 0 0 0 2px rgba(0, 128, 128, 0.5);
            --iframe-bg: #0a1a1a;
            --footer-text-color: #e0f0f0;
            --tab-bg: #1a4343;
            --tab-active-bg: #008080;
            --tab-border: #2a5353;
            --tab-hover-bg: #2a5353;
            --sidebar-bg: #0f2525;
            --sidebar-item-hover-bg: #122f2f;
            --sidebar-border-color: rgba(224, 240, 240, 0.2);
            --sidebar-outline-color: rgba(224, 240, 240, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Brown Theme */
        body.theme-brown {
            --bg-color: #1a1510;
            --text-color: #f0e8e0;
            --navbar-bg: #2f251a;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #a0522d; /* Sienna */
            --button-hover-bg: #8b4513; /* Saddle Brown */
            --input-bg: #2f251a;
            --input-focus-bg: #43382c;
            --input-focus-shadow: 0 0 0 2px rgba(160, 82, 45, 0.5);
            --iframe-bg: #1a1510;
            --footer-text-color: #f0e8e0;
            --tab-bg: #43382c;
            --tab-active-bg: #a0522d;
            --tab-border: #534a3d;
            --tab-hover-bg: #534a3d;
            --sidebar-bg: #251e14;
            --sidebar-item-hover-bg: #2f251a;
            --sidebar-border-color: rgba(240, 232, 224, 0.2);
            --sidebar-outline-color: rgba(240, 232, 224, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Pink Theme */
        body.theme-pink {
            --bg-color: #2c0b1a;
            --text-color: #fde8f0;
            --navbar-bg: #4e122f;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #ff69b4; /* Hot Pink */
            --button-hover-bg: #ff1493; /* Deep Pink */
            --input-bg: #4e122f;
            --input-focus-bg: #6f1a43;
            --input-focus-shadow: 0 0 0 2px rgba(255, 105, 180, 0.5);
            --iframe-bg: #2c0b1a;
            --footer-text-color: #fde8f0;
            --tab-bg: #6f1a43;
            --tab-active-bg: #ff69b4;
            --tab-border: #8f2a53;
            --tab-hover-bg: #8f2a53;
            --sidebar-bg: #3b1025;
            --sidebar-item-hover-bg: #4e122f;
            --sidebar-border-color: rgba(253, 232, 240, 0.2);
            --sidebar-outline-color: rgba(253, 232, 240, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Yellow Theme */
        body.theme-yellow {
            --bg-color: #1a1a0a;
            --text-color: #f0f0e0;
            --navbar-bg: #2f2f12;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #ffd700; /* Gold */
            --button-hover-bg: #ffc125; /* Goldenrod */
            --input-bg: #2f2f12;
            --input-focus-bg: #43431a;
            --input-focus-shadow: 0 0 0 2px rgba(255, 215, 0, 0.5);
            --iframe-bg: #1a1a0a;
            --footer-text-color: #f0f0e0;
            --tab-bg: #43431a;
            --tab-active-bg: #ffd700;
            --tab-border: #53532a;
            --tab-hover-bg: #53532a;
            --sidebar-bg: #25250f;
            --sidebar-item-hover-bg: #2f2f12;
            --sidebar-border-color: rgba(240, 240, 224, 0.2);
            --sidebar-outline-color: rgba(240, 240, 224, 0.3);
            --button-text-color: #333;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Gray Theme */
        body.theme-gray {
            --bg-color: #1a1a1c;
            --text-color: #e0e0e0;
            --navbar-bg: #2f2f32;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #808080; /* Gray */
            --button-hover-bg: #696969; /* Dim Gray */
            --input-bg: #2f2f32;
            --input-focus-bg: #434348;
            --input-focus-shadow: 0 0 0 2px rgba(128, 128, 128, 0.5);
            --iframe-bg: #1a1a1c;
            --footer-text-color: #e0e0e0;
            --tab-bg: #434348;
            --tab-active-bg: #808080;
            --tab-border: #535358;
            --tab-hover-bg: #535358;
            --sidebar-bg: #252528;
            --sidebar-item-hover-bg: #2f2f32;
            --sidebar-border-color: rgba(224, 224, 224, 0.2);
            --sidebar-outline-color: rgba(224, 224, 224, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Cyan Theme */
        body.theme-cyan {
            --bg-color: #0a1a1c;
            --text-color: #e0f0f0;
            --navbar-bg: #122f32;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #00ffff; /* Cyan */
            --button-hover-bg: #00ced1; /* Dark Cyan */
            --input-bg: #122f32;
            --input-focus-bg: #1a4348;
            --input-focus-shadow: 0 0 0 2px rgba(0, 255, 255, 0.5);
            --iframe-bg: #0a1a1c;
            --footer-text-color: #e0f0f0;
            --tab-bg: #1a4348;
            --tab-active-bg: #00ffff;
            --tab-border: #2a5358;
            --tab-hover-bg: #2a5358;
            --sidebar-bg: #0f2528;
            --sidebar-item-hover-bg: #122f32;
            --sidebar-border-color: rgba(224, 240, 240, 0.2);
            --sidebar-outline-color: rgba(224, 240, 240, 0.3);
            --button-text-color: #333;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Lime Theme */
        body.theme-lime {
            --bg-color: #1a1c0a;
            --text-color: #f0f0e0;
            --navbar-bg: #2f3212;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #32cd32; /* Lime Green */
            --button-hover-bg: #008000; /* Green */
            --input-bg: #2f3212;
            --input-focus-bg: #43481a;
            --input-focus-shadow: 0 0 0 2px rgba(50, 205, 50, 0.5);
            --iframe-bg: #1a1c0a;
            --footer-text-color: #f0f0e0;
            --tab-bg: #43481a;
            --tab-active-bg: #32cd32;
            --tab-border: #53582a;
            --tab-hover-bg: #53582a;
            --sidebar-bg: #25280f;
            --sidebar-item-hover-bg: #2f3212;
            --sidebar-border-color: rgba(240, 240, 224, 0.2);
            --sidebar-outline-color: rgba(240, 240, 224, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Indigo Theme */
        body.theme-indigo {
            --bg-color: #100a1a;
            --text-color: #e8e0f0;
            --navbar-bg: #1d122f;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #4b0082; /* Indigo */
            --button-hover-bg: #410072; /* Darker Indigo */
            --input-bg: #1d122f;
            --input-focus-bg: #2c1a43;
            --input-focus-shadow: 0 0 0 2px rgba(75, 0, 130, 0.5);
            --iframe-bg: #100a1a;
            --footer-text-color: #e8e0f0;
            --tab-bg: #2c1a43;
            --tab-active-bg: #4b0082;
            --tab-border: #3d2a53;
            --tab-hover-bg: #3d2a53;
            --sidebar-bg: #170f25;
            --sidebar-item-hover-bg: #1d122f;
            --sidebar-border-color: rgba(232, 224, 240, 0.2);
            --sidebar-outline-color: rgba(232, 224, 240, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Olive Theme */
        body.theme-olive {
            --bg-color: #1a1a0a;
            --text-color: #f0f0e0;
            --navbar-bg: #2f2f12;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #808000; /* Olive */
            --button-hover-bg: #6b8e23; /* Olive Drab */
            --input-bg: #2f2f12;
            --input-focus-bg: #43431a;
            --input-focus-shadow: 0 0 0 2px rgba(128, 128, 0, 0.5);
            --iframe-bg: #1a1a0a;
            --footer-text-color: #f0f0e0;
            --tab-bg: #43431a;
            --tab-active-bg: #808000;
            --tab-border: #53532a;
            --tab-hover-bg: #53532a;
            --sidebar-bg: #25250f;
            --sidebar-item-hover-bg: #2f2f12;
            --sidebar-border-color: rgba(240, 240, 224, 0.2);
            --sidebar-outline-color: rgba(240, 240, 224, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Maroon Theme */
        body.theme-maroon {
            --bg-color: #1a0a0a;
            --text-color: #f0e0e0;
            --navbar-bg: #2f1212;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #800000; /* Maroon */
            --button-hover-bg: #a52a2a; /* Brown */
            --input-bg: #2f1212;
            --input-focus-bg: #431a1a;
            --input-focus-shadow: 0 0 0 2px rgba(128, 0, 0, 0.5);
            --iframe-bg: #1a0a0a;
            --footer-text-color: #f0e0e0;
            --tab-bg: #431a1a;
            --tab-active-bg: #800000;
            --tab-border: #532a2a;
            --tab-hover-bg: #532a2a;
            --sidebar-bg: #250f0f;
            --sidebar-item-hover-bg: #2f1212;
            --sidebar-border-color: rgba(240, 224, 224, 0.2);
            --sidebar-outline-color: rgba(240, 224, 224, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Navy Theme */
        body.theme-navy {
            --bg-color: #0a0a1a;
            --text-color: #e0e0f0;
            --navbar-bg: #12122f;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #000080; /* Navy */
            --button-hover-bg: #0000cd; /* Medium Blue */
            --input-bg: #12122f;
            --input-focus-bg: #1a1a43;
            --input-focus-shadow: 0 0 0 2px rgba(0, 0, 128, 0.5);
            --iframe-bg: #0a0a1a;
            --footer-text-color: #e0e0f0;
            --tab-bg: #1a1a43;
            --tab-active-bg: #000080;
            --tab-border: #2a2a53;
            --tab-hover-bg: #2a2a53;
            --sidebar-bg: #0f0f25;
            --sidebar-item-hover-bg: #12122f;
            --sidebar-border-color: rgba(224, 224, 240, 0.2);
            --sidebar-outline-color: rgba(224, 224, 240, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Aqua Theme */
        body.theme-aqua {
            --bg-color: #0a1a1a;
            --text-color: #e0f0f0;
            --navbar-bg: #122f2f;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #00ffff; /* Aqua */
            --button-hover-bg: #00ced1; /* Dark Cyan */
            --input-bg: #122f2f;
            --input-focus-bg: #1a4343;
            --input-focus-shadow: 0 0 0 2px rgba(0, 255, 255, 0.5);
            --iframe-bg: #0a1a1a;
            --footer-text-color: #e0f0f0;
            --tab-bg: #1a4343;
            --tab-active-bg: #00ffff;
            --tab-border: #2a5353;
            --tab-hover-bg: #2a5353;
            --sidebar-bg: #0f2525;
            --sidebar-item-hover-bg: #122f2f;
            --sidebar-border-color: rgba(224, 240, 240, 0.2);
            --sidebar-outline-color: rgba(224, 240, 240, 0.3);
            --button-text-color: #333;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Gold Theme */
        body.theme-gold {
            --bg-color: #1a100a;
            --text-color: #f0e8e0;
            --navbar-bg: #2f1d12;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #ffd700; /* Gold */
            --button-hover-bg: #ffc125; /* Goldenrod */
            --input-bg: #2f1d12;
            --input-focus-bg: #432c1a;
            --input-focus-shadow: 0 0 0 2px rgba(255, 215, 0, 0.5);
            --iframe-bg: #1a100a;
            --footer-text-color: #f0e8e0;
            --tab-bg: #432c1a;
            --tab-active-bg: #ffd700;
            --tab-border: #533d2a;
            --tab-hover-bg: #533d2a;
            --sidebar-bg: #25170f;
            --sidebar-item-hover-bg: #2f1d12;
            --sidebar-border-color: rgba(240, 232, 224, 0.2);
            --sidebar-outline-color: rgba(240, 232, 224, 0.3);
            --button-text-color: #333;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Silver Theme */
        body.theme-silver {
            --bg-color: #1c1c1c;
            --text-color: #e0e0e0;
            --navbar-bg: #323232;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #c0c0c0; /* Silver */
            --button-hover-bg: #a9a9a9; /* Dark Gray */
            --input-bg: #323232;
            --input-focus-bg: #484848;
            --input-focus-shadow: 0 0 0 2px rgba(192, 192, 192, 0.5);
            --iframe-bg: #1c1c1c;
            --footer-text-color: #e0e0e0;
            --tab-bg: #484848;
            --tab-active-bg: #c0c0c0;
            --tab-border: #585858;
            --tab-hover-bg: #585858;
            --sidebar-bg: #282828;
            --sidebar-item-hover-bg: #323232;
            --sidebar-border-color: rgba(224, 224, 224, 0.2);
            --sidebar-outline-color: rgba(224, 224, 224, 0.3);
            --button-text-color: #333;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Bronze Theme */
        body.theme-bronze {
            --bg-color: #1a1510;
            --text-color: #f0e8e0;
            --navbar-bg: #2f251a;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #cd7f32; /* Bronze */
            --button-hover-bg: #b87333; /* Copper */
            --input-bg: #2f251a;
            --input-focus-bg: #43382c;
            --input-focus-shadow: 0 0 0 2px rgba(205, 127, 50, 0.5);
            --iframe-bg: #1a1510;
            --footer-text-color: #f0e8e0;
            --tab-bg: #43382c;
            --tab-active-bg: #cd7f32;
            --tab-border: #534a3d;
            --tab-hover-bg: #534a3d;
            --sidebar-bg: #251e14;
            --sidebar-item-hover-bg: #2f251a;
            --sidebar-border-color: rgba(240, 232, 224, 0.2);
            --sidebar-outline-color: rgba(240, 232, 224, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Rose Theme */
        body.theme-rose {
            --bg-color: #2c0b15;
            --text-color: #fde8ec;
            --navbar-bg: #4e1228;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #ff007f; /* Rose */
            --button-hover-bg: #dc143c; /* Crimson */
            --input-bg: #4e1228;
            --input-focus-bg: #6f1a3c;
            --input-focus-shadow: 0 0 0 2px rgba(255, 0, 127, 0.5);
            --iframe-bg: #2c0b15;
            --footer-text-color: #fde8ec;
            --tab-bg: #6f1a3c;
            --tab-active-bg: #ff007f;
            --tab-border: #8f2a4c;
            --tab-hover-bg: #8f2a4c;
            --sidebar-bg: #3b101f;
            --sidebar-item-hover-bg: #4e1228;
            --sidebar-border-color: rgba(253, 232, 236, 0.2);
            --sidebar-outline-color: rgba(253, 232, 236, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Violet Theme */
        body.theme-violet {
            --bg-color: #150a1a;
            --text-color: #ece0f0;
            --navbar-bg: #28122f;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #8a2be2; /* Blue Violet */
            --button-hover-bg: #9400d3; /* Dark Violet */
            --input-bg: #28122f;
            --input-focus-bg: #3c1a43;
            --input-focus-shadow: 0 0 0 2px rgba(138, 43, 226, 0.5);
            --iframe-bg: #150a1a;
            --footer-text-color: #ece0f0;
            --tab-bg: #3c1a43;
            --tab-active-bg: #8a2be2;
            --tab-border: #4c2a53;
            --tab-hover-bg: #4c2a53;
            --sidebar-bg: #1f0f25;
            --sidebar-item-hover-bg: #28122f;
            --sidebar-border-color: rgba(236, 224, 240, 0.2);
            --sidebar-outline-color: rgba(236, 224, 240, 0.3);
            --button-text-color: #ffffff;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Turquoise Theme */
        body.theme-turquoise {
            --bg-color: #0a1c1c;
            --text-color: #e0f0f0;
            --navbar-bg: #123232;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #40e0d0; /* Turquoise */
            --button-hover-bg: #48d1cc; /* Medium Turquoise */
            --input-bg: #123232;
            --input-focus-bg: #1a4848;
            --input-focus-shadow: 0 0 0 2px rgba(64, 224, 208, 0.5);
            --iframe-bg: #0a1c1c;
            --footer-text-color: #e0f0f0;
            --tab-bg: #1a4848;
            --tab-active-bg: #40e0d0;
            --tab-border: #2a5858;
            --tab-hover-bg: #2a5858;
            --sidebar-bg: #0f2828;
            --sidebar-item-hover-bg: #123232;
            --sidebar-border-color: rgba(224, 240, 240, 0.2);
            --sidebar-outline-color: rgba(224, 240, 240, 0.3);
            --button-text-color: #333;
            --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Adding 10 New Themes */
        /* Gold Rush Theme */
        body.theme-goldrush {
            --bg-color: #332a00;
            --text-color: #fff8e1;
            --navbar-bg: #4d3e00;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #ffc107; /* Amber */
            --button-hover-bg: #ffb300; /* Selective Yellow */
            --input-bg: #4d3e00;
            --input-focus-bg: #665200;
            --input-focus-shadow: 0 0 0 2px rgba(255, 193, 7, 0.5);
            --iframe-bg: #332a00;
            --footer-text-color: #fff8e1;
            --tab-bg: #665200;
            --tab-active-bg: #ffc107;
            --tab-border: #806b00;
            --tab-hover-bg: #806b00;
            --sidebar-bg: #292100;
            --sidebar-item-hover-bg: #332a00;
            --sidebar-border-color: rgba(255, 248, 225, 0.2);
            --sidebar-outline-color: rgba(255, 248, 225, 0.3);
            --button-text-color: #333;
             --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Emerald Theme */
        body.theme-emerald {
            --bg-color: #0a261a;
            --text-color: #e0f2f1;
            --navbar-bg: #114c2f;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #2ecc71; /* Emerald */
            --button-hover-bg: #27ae60; /* Medium Sea Green */
            --input-bg: #114c2f;
            --input-focus-bg: #1a6f4a;
            --input-focus-shadow: 0 0 0 2px rgba(46, 204, 113, 0.5);
            --iframe-bg: #0a261a;
            --footer-text-color: #e0f2f1;
            --tab-bg: #1a6f4a;
            --tab-active-bg: #2ecc71;
            --tab-border: #239b5b;
            --tab-hover-bg: #239b5b;
            --sidebar-bg: #081f14;
            --sidebar-item-hover-bg: #0a261a;
            --sidebar-border-color: rgba(224, 242, 241, 0.2);
            --sidebar-outline-color: rgba(224, 242, 241, 0.3);
            --button-text-color: #ffffff;
             --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Sunset Theme */
        body.theme-sunset {
            --bg-color: #2c1a00;
            --text-color: #ffecb3;
            --navbar-bg: #4e2c00;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #ff9800; /* Orange */
            --button-hover-bg: #f57c00; /* Dark Orange */
            --input-bg: #4e2c00;
            --input-focus-bg: #795548;
            --input-focus-shadow: 0 0 0 2px rgba(255, 152, 0, 0.5);
            --iframe-bg: #2c1a00;
            --footer-text-color: #ffecb3;
            --tab-bg: #795548;
            --tab-active-bg: #ff9800;
            --tab-border: #a1887f;
            --tab-hover-bg: #a1887f;
            --sidebar-bg: #3b2000;
            --sidebar-item-hover-bg: #4e2c00;
            --sidebar-border-color: rgba(255, 236, 179, 0.2);
            --sidebar-outline-color: rgba(255, 236, 179, 0.3);
            --button-text-color: #ffffff;
             --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Ocean Theme (Slightly different from existing Blue) */
        body.theme-ocean {
            --bg-color: #0a1a26;
            --text-color: #e3f2fd;
            --navbar-bg: #1e3a5f;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #2196f3; /* Blue */
            --button-hover-bg: #1976d2; /* Darker Blue */
            --input-bg: #1e3a5f;
            --input-focus-bg: #42a5f5;
            --input-focus-shadow: 0 0 0 2px rgba(33, 150, 243, 0.5);
            --iframe-bg: #0a1a26;
            --footer-text-color: #e3f2fd;
            --tab-bg: #42a5f5;
            --tab-active-bg: #2196f3;
            --tab-border: #64b5f6;
            --tab-hover-bg: #64b5f6;
            --sidebar-bg: #162e4c;
            --sidebar-item-hover-bg: #1e3a5f;
            --sidebar-border-color: rgba(227, 242, 253, 0.2);
            --sidebar-outline-color: rgba(227, 242, 253, 0.3);
            --button-text-color: #ffffff;
             --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Ruby Theme */
        body.theme-ruby {
            --bg-color: #260a1a;
            --text-color: #fce4ec;
            --navbar-bg: #4a1230;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #e51c23; /* Red */
            --button-hover-bg: #d01716; /* Darker Red */
            --input-bg: #4a1230;
            --input-focus-bg: #880e4f;
            --input-focus-shadow: 0 0 0 2px rgba(229, 28, 35, 0.5);
            --iframe-bg: #260a1a;
            --footer-text-color: #fce4ec;
            --tab-bg: #880e4f;
            --tab-active-bg: #e51c23;
            --tab-border: #c2185b;
            --tab-hover-bg: #c2185b;
            --sidebar-bg: #1e0814;
            --sidebar-item-hover-bg: #260a1a;
            --sidebar-border-color: rgba(252, 228, 236, 0.2);
            --sidebar-outline-color: rgba(252, 228, 236, 0.3);
            --button-text-color: #ffffff;
             --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Sandstone Theme */
        body.theme-sandstone {
            --bg-color: #2e2a1a;
            --text-color: #fff9c4;
            --navbar-bg: #5d5335;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #ffeb3b; /* Yellow */
            --button-hover-bg: #fbc02d; /* Amber */
            --input-bg: #5d5335;
            --input-focus-bg: #8d6e63;
            --input-focus-shadow: 0 0 0 2px rgba(255, 235, 59, 0.5);
            --iframe-bg: #2e2a1a;
            --footer-text-color: #fff9c4;
            --tab-bg: #8d6e63;
            --tab-active-bg: #ffeb3b;
            --tab-border: #a1887f;
            --tab-hover-bg: #a1887f;
            --sidebar-bg: #262313;
            --sidebar-item-hover-bg: #2e2a1a;
            --sidebar-border-color: rgba(255, 249, 196, 0.2);
            --sidebar-outline-color: rgba(255, 249, 196, 0.3);
            --button-text-color: #333;
             --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Amethyst Theme */
        body.theme-amethyst {
            --bg-color: #1f0a26;
            --text-color: #f3e5f5;
            --navbar-bg: #381b4d;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #9c27b0; /* Purple */
            --button-hover-bg: #8e24aa; /* Darker Purple */
            --input-bg: #381b4d;
            --input-focus-bg: #ba68c8;
            --input-focus-shadow: 0 0 0 2px rgba(156, 39, 176, 0.5);
            --iframe-bg: #1f0a26;
            --footer-text-color: #f3e5f5;
            --tab-bg: #ba68c8;
            --tab-active-bg: #9c27b0;
            --tab-border: #e1bee7;
            --tab-hover-bg: #e1bee7;
            --sidebar-bg: #18081f;
            --sidebar-item-hover-bg: #1f0a26;
            --sidebar-border-color: rgba(243, 229, 245, 0.2);
            --sidebar-outline-color: rgba(243, 229, 245, 0.3);
            --button-text-color: #ffffff;
             --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Charcoal Theme */
        body.theme-charcoal {
            --bg-color: #1f1f1f;
            --text-color: #e0e0e0;
            --navbar-bg: #333333;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.4);
            --button-bg: #616161; /* Gray 700 */
            --button-hover-bg: #424242; /* Gray 800 */
            --input-bg: #333333;
            --input-focus-bg: #424242;
            --input-focus-shadow: 0 0 0 2px rgba(97, 97, 97, 0.5);
            --iframe-bg: #1f1f1f;
            --footer-text-color: #e0e0e0;
            --tab-bg: #424242;
            --tab-active-bg: #616161;
            --tab-border: #757575;
            --tab-hover-bg: #757575;
            --sidebar-bg: #292929;
            --sidebar-item-hover-bg: #1f1f1f;
            --sidebar-border-color: rgba(224, 224, 224, 0.2);
            --sidebar-outline-color: rgba(224, 224, 224, 0.3);
            --button-text-color: #ffffff;
             --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }

        /* Pastel Pink Theme (special: subtle pulsing on inputs) */
        body.theme-pastelpink {
            --bg-color: #fff0f6;
            --text-color: #880e4f;
            --navbar-bg: #f8bbd0;
            --navbar-shadow: 0 2px 5px rgba(0,0,0,0.1);
            --button-bg: #e91e63; /* Pink */
            --button-hover-bg: #c2185b; /* Darker Pink */
            --input-bg: #fce4ec;
            --input-focus-bg: #f8bbd0;
            --input-focus-shadow: 0 0 0 2px rgba(233, 30, 99, 0.3);
            --iframe-bg: #fff0f6;
            --footer-text-color: #880e4f;
            --tab-bg: #f48fb1;
            --tab-active-bg: #e91e63;
            --tab-border: #f06292;
            --tab-hover-bg: #f06292;
            --sidebar-bg: #ffebee;
            --sidebar-item-hover-bg: #f8bbd0;
            --sidebar-border-color: #f06292;
            --sidebar-outline-color: #e91e63;
            --button-text-color: #ffffff;
             --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }
        body.theme-pastelpink .sidebar-input:focus,
        body.theme-pastelpink .custom-dropdown-header:focus {
            animation: pulse-pink 1s infinite alternate;
        }
        @keyframes pulse-pink {
            from { box-shadow: var(--input-focus-shadow); }
            to { box-shadow: 0 0 0 4px rgba(233, 30, 99, 0.5); }
        }

        /* Neon Green Theme (special: vibrant text shadow on hover) */
        body.theme-neongreen {
            --bg-color: #0a1a0a;
            --text-color: #00ff00; /* Neon Green */
            --navbar-bg: #113311;
            --navbar-shadow: 0 2px 5px rgba(0,255,0,0.3);
            --button-bg: #00cc00; /* Darker Neon */
            --button-hover-bg: #00aa00;
            --input-bg: #113311;
            --input-focus-bg: #1a4d1a;
            --input-focus-shadow: 0 0 0 2px rgba(0, 255, 0, 0.5);
            --iframe-bg: #0a1a0a;
            --footer-text-color: #00ff00;
            --tab-bg: #1a4d1a;
            --tab-active-bg: #00ff00;
            --tab-border: #00aa00;
            --tab-hover-bg: #00aa00;
            --sidebar-bg: #081408;
            --sidebar-item-hover-bg: #0a1a0a;
            --sidebar-border-color: rgba(0, 255, 0, 0.2);
            --sidebar-outline-color: rgba(0, 255, 0, 0.3);
            --button-text-color: #ffffff;
             --dropdown-bg: var(--input-bg);
            --dropdown-hover-bg: var(--input-focus-bg);
            --dropdown-item-hover-bg: var(--button-hover-bg);
            --dropdown-text-color: var(--text-color);
        }
        body.theme-neongreen li:hover .bookmark-url,
        body.theme-neongreen li:hover .history-url {
            text-shadow: 0 0 5px var(--text-color);
        }


        html, body {
            margin: 0; padding: 0; border: none; box-sizing: border-box;
            width: 100%; height: 100%; overflow: hidden;
            font-family: var(--font-family-main);
            background-color: var(--bg-color); color: var(--text-color);
            display: flex;
        }

        canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        }

        #sidebar {
            width: var(--sidebar-width); height: 100vh; background-color: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border-color); /* Lightened border */
            padding: 20px 15px; box-sizing: border-box; /* Adjusted padding */
            overflow-y: auto; transition: margin-left 0.35s ease-in-out, width 0.35s ease-in-out;
            z-index: 1001; display: flex; flex-direction: column; gap: 25px; /* Increased gap */
            font-family: var(--font-family-main); /* Ensure font */
        }
        #sidebar.hidden { margin-left: calc(-1 * var(--sidebar-width)); }
        #sidebar h3 {
            margin-top: 0; margin-bottom: 12px; font-size: 1em; /* Slightly smaller */
            border-bottom: 1px solid var(--sidebar-border-color); padding-bottom: 10px;
            font-weight: 600; /* Bolder like top bar items if needed */
            display: flex; align-items: center; gap: 8px; /* For potential icons */
        }
        #sidebar ul { list-style: none; padding: 0; margin: 0; max-height: 180px; overflow-y: auto; }
        #sidebar ul::-webkit-scrollbar { width: 5px; }
        #sidebar ul::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); border-radius: 8px; }

        #sidebar li {
            padding: 10px 18px; /* Adjusted padding */
            margin-bottom: 8px; /* Spacing */
            border-radius: 8px; /* Pill shape */
            cursor: pointer;
            font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            background-color: var(--button-bg); /* Using button bg for consistency */
            box-shadow: 0 0 0 1px var(--sidebar-outline-color); /* Light outline */
            color: var(--button-text-color);
        }
        #sidebar li:hover {
            background-color: var(--button-hover-bg);
            box-shadow: 0 0 0 1.5px var(--sidebar-outline-color); /* Slightly thicker outline on hover */
        }
        #sidebar li .bookmark-url, #sidebar li .history-url {
            font-size: 0.75em; opacity: 0.7; display: block; margin-top: 2px;
        }

        #sidebar .sidebar-input {
            width: 100%; /* Full width */
            height: 40px; /* Consistent height */
            padding: 0 18px; /* Padding like search bar */
            margin-bottom: 12px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: none; /* Remove default border */
            border-radius: 8px; /* Pill shape */
            font-family: var(--font-family-main);
            box-sizing: border-box;
            box-shadow: 0 0 0 1px var(--sidebar-outline-color); /* Light outline */
            font-size: 0.9em;
        }
        #sidebar .sidebar-input:focus {
            outline: none;
            background-color: var(--input-focus-bg);
            box-shadow: var(--input-focus-shadow); /* Use theme's focus shadow */
        }

        #sidebar .sidebar-button {
            width: 100%; /* Full width */
            height: 40px; /* Consistent height */
            padding: 0 18px; /* Horizontal padding */
            background-color: var(--button-bg);
            color: var(--button-text-color);
            border: none;
            border-radius: 8px; /* Pill shape */
            cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            font-family: var(--font-family-main);
            box-shadow: 0 0 0 1px var(--sidebar-outline-color); /* Light outline */
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9em;
            font-weight: 500;
        }
        #sidebar .sidebar-button:hover {
            background-color: var(--button-hover-bg);
            box-shadow: 0 0 0 1.5px var(--sidebar-outline-color);
        }

        /* Custom Dropdown Styles */
        .custom-dropdown {
            position: relative;
            width: 100%;
            margin-bottom: 12px;
            font-size: 0.9em;
            font-family: var(--font-family-main);
            color: var(--dropdown-text-color);
        }

        .custom-dropdown-header {
            width: 100%;
            height: 40px;
            padding: 0 18px;
            background-color: var(--dropdown-bg);
            border: none;
            border-radius: 8px;
            box-sizing: border-box;
            box-shadow: 0 0 0 1px var(--sidebar-outline-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }

        .custom-dropdown-header:hover {
             background-color: var(--dropdown-hover-bg);
             box-shadow: 0 0 0 1.5px var(--sidebar-outline-color);
        }

         .custom-dropdown-header:focus {
            outline: none;
            background-color: var(--dropdown-hover-bg);
            box-shadow: var(--input-focus-shadow);
        }

        .custom-dropdown-header .fas {
            margin-left: 10px;
            transition: transform 0.2s ease;
        }

        .custom-dropdown-header.open .fas {
            transform: rotate(180deg);
        }

        .custom-dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--dropdown-bg);
            border-radius: 8px; /* Slightly less rounded than pills */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            list-style: none;
            padding: 10px 0;
            margin: 5px 0 0 0;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .custom-dropdown-list.show {
            display: block;
        }

        .custom-dropdown-list::-webkit-scrollbar { width: 5px; }
        .custom-dropdown-list::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.2); border-radius: 8px; }


        .custom-dropdown-list-item {
            padding: 8px 18px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .custom-dropdown-list-item:hover {
            background-color: var(--dropdown-item-hover-bg);
        }

        .custom-dropdown-list-item.selected {
            font-weight: bold;
            /* Add a subtle visual cue for selected item */
            background-color: rgba(255, 255, 255, 0.1);
        }

        #main-content-wrapper {
            flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden;
        }
        #top-bar-assembly { overflow: hidden; transition: max-height 0.35s ease-in-out; }
        #top-bar-assembly.hidden { max-height: 0 !important; }

        #tab-bar {
            display: flex; background-color: var(--navbar-bg); padding: 10px 12px;
            overflow-x: auto; white-space: nowrap; scrollbar-width: thin;
            position: relative; align-items: center; gap: 8px;
        }
        #tab-bar::-webkit-scrollbar { height: 3px; }
        #tab-bar::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.3); border-radius: 8px; }
        .tab {
            display: flex; align-items: center; min-width: 160px; max-width: 200px; height: 32px;
            padding: 0 12px; background-color: var(--tab-bg); border-radius: 8px; cursor: pointer;
            transition: all 0.2s ease; overflow: hidden; position: relative; box-shadow: 0 0 0 1px var(--tab-border);
        }
        .tab.active { background-color: var(--tab-active-bg); box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3); }
        .tab:hover:not(.active) { background-color: var(--tab-hover-bg); }
        .tab-favicon { width: 16px; height: 16px; margin-right: 8px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .tab-title { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; }
        .tab-close { width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-left: 4px; flex-shrink: 0; opacity: 0.7; transition: opacity 0.2s, background-color 0.2s; }
        .tab-close:hover { opacity: 1; background-color: rgba(255, 255, 255, 0.2); }
        .new-tab-button { /* Circle */
            width: 32px; height: 32px; min-width: 32px; margin-left: 6px; border-radius: 25%;
            display: flex; align-items: center; justify-content: center; background-color: var(--button-bg);
            cursor: pointer; transition: background-color 0.2s; box-shadow: 0 0 0 1px var(--sidebar-outline-color); /* Using sidebar outline for consistency */
        }
        .new-tab-button:hover { background-color: var(--button-hover-bg); }

        #nav-bar {
            display: flex; align-items: center; padding: 10px;
            background-color: var(--navbar-bg); box-shadow: var(--navbar-shadow);
            border-bottom: 2px solid var(--sidebar-border-color); /* Using sidebar border color */
        }
        .nav-button { /* Circle */
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            margin-right: 10px; border-radius: 25%; background-color: var(--button-bg);
            cursor: pointer; color: var(--button-text-color); transition: background-color 0.2s, color 0.2s;
            box-shadow: 0 0 0 1px var(--sidebar-outline-color); /* Light outline */
        }
        .nav-button:hover { background-color: var(--button-hover-bg); }
        #search-bar { /* Pill shape */
            flex: 1; height: 40px; border-radius: 8px; border: none; background-color: var(--input-bg);
            color: var(--text-color); padding: 0 18px; font-size: 15px;
            box-shadow: 0 0 0 1px var(--sidebar-outline-color); font-family: var(--font-family-main);
        }
        #search-bar:focus { outline: none; background-color: var(--input-focus-bg); box-shadow: var(--input-focus-shadow); }

        #toggle-top-bar-button, #toggle-sidebar-button {
            position: fixed; z-index: 1002; width: 40px; height: 32px;
            background-color: var(--navbar-bg); cursor: pointer; display: flex;
            justify-content: center; align-items: center; color: var(--text-color);
            transition: top 0.35s ease-in-out, left 0.35s ease-in-out, background-color 0.2s ease-in-out, transform 0.35s ease-in-out;
            box-shadow: 0 0 0 1px var(--sidebar-outline-color); /* Light outline for toggles */
        }
        #toggle-top-bar-button:hover, #toggle-sidebar-button:hover { background-color: var(--button-hover-bg); }
        #toggle-top-bar-button .fas, #toggle-sidebar-button .fas { font-size: 14px; transition: transform 0.3s ease-in-out; }
        #toggle-top-bar-button {
            right: 2px; border-radius: 0 0 12px 12px; /* Rounded pill bottom */
        }
        #toggle-sidebar-button {
            left: 0px; bottom: 2px; border-radius: 0 12px 12px 0; /* Rounded pill right */
        }

        #tabs-container { flex: 1; position: relative; background-color: var(--iframe-bg); }
        .tab-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; border: none; }
        .tab-content.active { display: block; }
        .footer-label {
            position: fixed; bottom: 0; right: 0; margin: 1rem; font-family: var(--font-family-main);
            font-size: 0.9rem; color: var(--footer-text-color); text-decoration: none; z-index: 1000;
        }
        .sidebar-setting-label { display:block; margin-bottom:8px; font-size: 0.9em; font-weight: 500; }

    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div id="sidebar">
        <div id="sidebar-header" style="padding-bottom: 10px; border-bottom: 1px solid var(--sidebar-border-color);">
            <h2 style="text-align: center; margin-bottom: 0; font-size: 1.4em; font-weight: bold;">Vern Max</h2>
        </div>

        <div id="bookmarks-section">
            <h3><i class="fas fa-bookmark"></i> Bookmarks</h3>
            <input type="text" id="new-bookmark-name" class="sidebar-input" placeholder="Bookmark Name (optional)">
            <button id="add-current-bookmark-button" class="sidebar-button" style="margin-bottom:10px;">
                <i class="fas fa-plus" style="margin-right: 8px;"></i>Bookmark Current
            </button>
            <ul id="bookmarks-list"></ul>
        </div>

        <div id="history-section">
            <h3><i class="fas fa-history"></i> Session History</h3>
            <ul id="history-list"></ul>
        </div>

        <div id="settings-section">
            <h3><i class="fas fa-cog"></i> Settings</h3>
            <label for="theme-dropdown" class="sidebar-setting-label">Theme:</label>
            <div class="custom-dropdown" id="theme-dropdown">
                <div class="custom-dropdown-header" tabindex="0">
                    <span id="selected-theme-text">Default Dark</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <ul class="custom-dropdown-list" role="listbox">
                    <li class="custom-dropdown-list-item" data-value="default" role="option" aria-selected="true">Default Dark</li>
                    <li class="custom-dropdown-list-item" data-value="light" role="option">Light Mode</li>
                    <li class="custom-dropdown-list-item" data-value="blue" role="option">Ocean Blue</li>
                    <li class="custom-dropdown-list-item" data-value="orange" role="option">Sunset Orange</li>
                    <li class="custom-dropdown-list-item" data-value="galaxy" role="option">Cosmic Galaxy</li>
                    <li class="custom-dropdown-list-item" data-value="mint" role="option">Mint Green</li>
                    <li class="custom-dropdown-list-item" data-value="crimson" role="option">Crimson Red</li>
                    <li class="custom-dropdown-list-item" data-value="forest" role="option">Forest Green</li>
                    <li class="custom-dropdown-list-item" data-value="purple" role="option">Deep Purple</li>
                    <li class="custom-dropdown-list-item" data-value="teal" role="option">Ocean Teal</li>
                    <li class="custom-dropdown-list-item" data-value="brown" role="option">Earthy Brown</li>
                    <li class="custom-dropdown-list-item" data-value="pink" role="option">Hot Pink</li>
                    <li class="custom-dropdown-list-item" data-value="yellow" role="option">Sunny Yellow</li>
                    <li class="custom-dropdown-list-item" data-value="gray" role="option">Cool Gray</li>
                    <li class="custom-dropdown-list-item" data-value="cyan" role="option">Vibrant Cyan</li>
                    <li class="custom-dropdown-list-item" data-value="lime" role="option">Zesty Lime</li>
                    <li class="custom-dropdown-list-item" data-value="indigo" role="option">Mystic Indigo</li>
                    <li class="custom-dropdown-list-item" data-value="olive" role="option">Calm Olive</li>
                    <li class="custom-dropdown-list-item" data-value="maroon" role="option">Rich Maroon</li>
                    <li class="custom-dropdown-list-item" data-value="navy" role="option">Deep Navy</li>
                    <li class="custom-dropdown-list-item" data-value="aqua" role="option">Bright Aqua</li>
                    <li class="custom-dropdown-list-item" data-value="gold" role="option">Royal Gold</li>
                    <li class="custom-dropdown-list-item" data-value="silver" role="option">Classic Silver</li>
                    <li class="custom-dropdown-list-item" data-value="bronze" role="option">Rustic Bronze</li>
                    <li class="custom-dropdown-list-item" data-value="rose" role="option">Sweet Rose</li>
                    <li class="custom-dropdown-list-item" data-value="violet" role="option">Soft Violet</li>
                    <li class="custom-dropdown-list-item" data-value="turquoise" role="option">Peaceful Turquoise</li>
                     <li class="custom-dropdown-list-item" data-value="goldrush" role="option">Gold Rush</li>
                    <li class="custom-dropdown-list-item" data-value="emerald" role="option">Emerald Green</li>
                    <li class="custom-dropdown-list-item" data-value="sunset" role="option">Sunset Orange</li>
                    <li class="custom-dropdown-list-item" data-value="ocean" role="option">Deep Ocean Blue</li>
                    <li class="custom-dropdown-list-item" data-value="ruby" role="option">Ruby Red</li>
                    <li class="custom-dropdown-list-item" data-value="sandstone" role="option">Desert Sandstone</li>
                    <li class="custom-dropdown-list-item" data-value="amethyst" role="option">Mystic Amethyst</li>
                    <li class="custom-dropdown-list-item" data-value="charcoal" role="option">Charcoal Gray</li>
                    <li class="custom-dropdown-list-item" data-value="pastelpink" role="option">Pastel Pink (Special)</li>
                    <li class="custom-dropdown-list-item" data-value="neongreen" role="option">Neon Green (Special)</li>

                </ul>
            </div>

            <label for="search-engine-dropdown" class="sidebar-setting-label" style="margin-top: 15px;">Search Engine:</label>
             <div class="custom-dropdown" id="search-engine-dropdown">
                <div class="custom-dropdown-header" tabindex="0">
                    <span id="selected-search-engine-text">DuckDuckGo</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <ul class="custom-dropdown-list" role="listbox">
                     <li class="custom-dropdown-list-item" data-value="duckduckgo" role="option" aria-selected="true">DuckDuckGo</li>
                    <li class="custom-dropdown-list-item" data-value="google" role="option">Google</li>
                    <li class="custom-dropdown-list-item" data-value="bing" role="option">Bing</li>
                    <li class="custom-dropdown-list-item" data-value="brave" role="option">Brave Search</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="toggle-sidebar-button" title="Toggle Sidebar">
        <i id="toggle-sidebar-icon" class="fas fa-chevron-left"></i>
    </div>

    <div id="main-content-wrapper">
        <div id="top-bar-assembly">
            <div id="tab-bar">
                <div class="new-tab-button" id="new-tab-button" title="New Tab">
                    <i class="fas fa-plus"></i>
                </div>
            </div>
            <div id="nav-bar">
                <div class="nav-button" id="home-button" title="Home"> <i class="fas fa-home"></i> </div>
                <div class="nav-button" id="back-button" title="Back"> <i class="fas fa-arrow-left"></i> </div>
                <div class="nav-button" id="forward-button" title="Forward"> <i class="fas fa-arrow-right"></i> </div>
                <div class="nav-button" id="refresh-button" title="Refresh"> <i class="fas fa-redo"></i> </div>
                <input type="text" id="search-bar" placeholder="Search or type a URL">
            </div>
        </div>

        <div id="toggle-top-bar-button" title="Hide Toolbar">
            <i id="toggle-bar-icon" class="fas fa-chevron-up"></i>
        </div>

        <div id="tabs-container"></div>
    </div>

    <a href="https://4simpleproblems.github.io" target="_blank" class="footer-label">Vern Max by 4SP</a>

    <script src="uv/uv.bundle.js" defer></script>
    <script src="uv/uv.config.js" defer></script>
    <script src="register-sw.js" defer></script>
    <script src="stars.js" defer></script>

    <script>
        // --- CONFIGURATION & GLOBAL STATE ---
        let tabs = [];
        let activeTabId = null;
        let tabCounter = 0;
        let sessionHistory = [];
        const MAX_HISTORY_ITEMS = 50;

        const searchEngines = {
            'duckduckgo': { name: 'DuckDuckGo', url: 'https://duckduckgo.com/?q=%s' },
            'google': { name: 'Google', url: 'https://www.google.com/search?q=%s' },
            'bing': { name: 'Bing', url: 'https://www.bing.com/search?q=%s' },
            'brave': { name: 'Brave Search', url: 'https://search.brave.com/search?q=%s' }
        };
        let currentSearchEngineKey = 'duckduckgo'; // Default

        const themes = {
            'default': 'Default Dark',
            'light': 'Light Mode',
            'blue': 'Ocean Blue',
            'orange': 'Sunset Orange',
            'galaxy': 'Cosmic Galaxy',
            'mint': 'Mint Green',
            'crimson': 'Crimson Red',
            'forest': 'Forest Green',
            'purple': 'Deep Purple',
            'teal': 'Ocean Teal',
            'brown': 'Earthy Brown',
            'pink': 'Hot Pink',
            'yellow': 'Sunny Yellow',
            'gray': 'Cool Gray',
            'cyan': 'Vibrant Cyan',
            'lime': 'Zesty Lime',
            'indigo': 'Mystic Indigo',
            'olive': 'Calm Olive',
            'maroon': 'Rich Maroon',
            'navy': 'Deep Navy',
            'aqua': 'Bright Aqua',
            'gold': 'Royal Gold',
            'silver': 'Classic Silver',
            'bronze': 'Rustic Bronze',
            'rose': 'Sweet Rose',
            'violet': 'Soft Violet',
            'turquoise': 'Peaceful Turquoise',
            // Added Themes
            'goldrush': 'Gold Rush',
            'emerald': 'Emerald Green',
            'sunset': 'Sunset Orange',
            'ocean': 'Deep Ocean Blue',
            'ruby': 'Ruby Red',
            'sandstone': 'Desert Sandstone',
            'amethyst': 'Mystic Amethyst',
            'charcoal': 'Charcoal Gray',
            'pastelpink': 'Pastel Pink (Special)',
            'neongreen': 'Neon Green (Special)'
        };


        // --- DOM ELEMENT REFERENCES ---
        let tabBarEl, tabsContainerEl, searchBarEl, newTabButtonEl, homeButtonEl, backButtonEl, forwardButtonEl, refreshButtonEl;
        let topBarAssemblyEl, toggleTopBarButtonEl, toggleBarIconEl;
        let sidebarEl, toggleSidebarButtonEl, toggleSidebarIconEl, mainContentWrapperEl;
        let bookmarksListEl, addCurrentBookmarkButtonEl, newBookmarkNameInputEl;
        let historyListEl;
        let themeDropdownEl, searchEngineDropdownEl;
        let selectedThemeTextEl, selectedSearchEngineTextEl;

        let initialTopBarHeight = 0;
        let isTopBarHidden = false;
        let isSidebarHidden = false;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize DOM elements
            tabBarEl = document.getElementById('tab-bar');
            tabsContainerEl = document.getElementById('tabs-container');
            searchBarEl = document.getElementById('search-bar');
            newTabButtonEl = document.getElementById('new-tab-button');
            homeButtonEl = document.getElementById('home-button');
            backButtonEl = document.getElementById('back-button');
            forwardButtonEl = document.getElementById('forward-button');
            refreshButtonEl = document.getElementById('refresh-button');

            topBarAssemblyEl = document.getElementById('top-bar-assembly');
            toggleTopBarButtonEl = document.getElementById('toggle-top-bar-button');
            toggleBarIconEl = document.getElementById('toggle-bar-icon');

            sidebarEl = document.getElementById('sidebar');
            toggleSidebarButtonEl = document.getElementById('toggle-sidebar-button');
            toggleSidebarIconEl = document.getElementById('toggle-sidebar-icon');
            mainContentWrapperEl = document.getElementById('main-content-wrapper');

            bookmarksListEl = document.getElementById('bookmarks-list');
            addCurrentBookmarkButtonEl = document.getElementById('add-current-bookmark-button');
            newBookmarkNameInputEl = document.getElementById('new-bookmark-name');
            historyListEl = document.getElementById('history-list');

            themeDropdownEl = document.getElementById('theme-dropdown');
            searchEngineDropdownEl = document.getElementById('search-engine-dropdown');
            selectedThemeTextEl = document.getElementById('selected-theme-text');
            selectedSearchEngineTextEl = document.getElementById('selected-search-engine-text');


            await initUV();
            setupCustomDropdowns(); // Setup the new custom dropdowns
            loadSettings(); // Load theme and search engine

            updateInitialTopBarHeight();
            if (!isTopBarHidden) topBarAssemblyEl.style.maxHeight = initialTopBarHeight + 'px';
            else {
                topBarAssemblyEl.style.maxHeight = '0px';
                topBarAssemblyEl.classList.add('hidden');
                handleTopBarToggle(true);
            }

            if (isSidebarHidden) {
                sidebarEl.classList.add('hidden');
                toggleSidebarIconEl.className = 'fas fa-chevron-right';
                toggleSidebarButtonEl.style.left = '0px';
                toggleSidebarButtonEl.title = "Show Sidebar";
            } else {
                toggleSidebarButtonEl.style.left = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
                toggleSidebarIconEl.className = 'fas fa-chevron-left';
                toggleSidebarButtonEl.title = "Hide Sidebar";
            }

            setupEventListeners();
            loadBookmarks();

            const urlParams = new URLSearchParams(window.location.search);
            const initialUrl = urlParams.get('url');
            if (tabs.length === 0) createTab(initialUrl || 'about:blank');
            renderHistory();
            applyTheme(localStorage.getItem('vernTheme') || 'default'); // Ensure theme is applied correctly on load
             updateSelectedDropdownText('theme-dropdown', localStorage.getItem('vernTheme') || 'default');
             updateSelectedDropdownText('search-engine-dropdown', localStorage.getItem('vernSearchEngine') || 'duckduckgo');
        });

        async function initUV() {
            try {
                if (typeof registerSW !== 'function') {
                    console.warn("registerSW() function not found. UV Service Worker might not be registered.");
                    return;
                }
                await registerSW();
                console.log("Service worker registered successfully for Vern Max.");
            } catch (err) {
                console.error("Failed to register UV service worker:", err);
                alert("Error: Could not initialize proxy service. Some websites may not load correctly.");
            }
        }

        function setupCustomDropdowns() {
            // Populate Theme Dropdown
            const themeListEl = themeDropdownEl.querySelector('.custom-dropdown-list');
            themeListEl.innerHTML = ''; // Clear existing options
            for (const value in themes) {
                const li = document.createElement('li');
                li.className = 'custom-dropdown-list-item';
                li.dataset.value = value;
                li.textContent = themes[value];
                li.setAttribute('role', 'option');
                 if (value === (localStorage.getItem('vernTheme') || 'default')) {
                    li.classList.add('selected');
                     li.setAttribute('aria-selected', 'true');
                 } else {
                     li.setAttribute('aria-selected', 'false');
                 }
                themeListEl.appendChild(li);
            }

             // Populate Search Engine Dropdown
            const searchEngineListEl = searchEngineDropdownEl.querySelector('.custom-dropdown-list');
            searchEngineListEl.innerHTML = ''; // Clear existing options
            for (const value in searchEngines) {
                const li = document.createElement('li');
                li.className = 'custom-dropdown-list-item';
                li.dataset.value = value;
                li.textContent = searchEngines[value].name;
                 li.setAttribute('role', 'option');
                 if (value === (localStorage.getItem('vernSearchEngine') || 'duckduckgo')) {
                     li.classList.add('selected');
                      li.setAttribute('aria-selected', 'true');
                 } else {
                     li.setAttribute('aria-selected', 'false');
                 }
                searchEngineListEl.appendChild(li);
            }

            // Add event listeners to custom dropdowns
             document.querySelectorAll('.custom-dropdown-header').forEach(header => {
                 header.addEventListener('click', toggleDropdown);
                 header.addEventListener('keydown', handleDropdownKeyDown);
             });
            document.querySelectorAll('.custom-dropdown-list-item').forEach(item => {
                item.addEventListener('click', selectDropdownItem);
                item.addEventListener('keydown', handleDropdownItemKeyDown);
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                document.querySelectorAll('.custom-dropdown-list.show').forEach(list => {
                    if (!list.parentNode.contains(e.target)) {
                        list.classList.remove('show');
                        list.parentNode.querySelector('.custom-dropdown-header').classList.remove('open');
                    }
                });
            });
             // Close dropdowns when focus leaves
            document.addEventListener('focusin', (e) => {
                 document.querySelectorAll('.custom-dropdown-list.show').forEach(list => {
                     if (!list.parentNode.contains(e.target)) {
                         list.classList.remove('show');
                         list.parentNode.querySelector('.custom-dropdown-header').classList.remove('open');
                     }
                 });
             });
        }

         function toggleDropdown() {
            const header = this;
            const list = header.nextElementSibling;
            const isOpen = list.classList.toggle('show');
            header.classList.toggle('open', isOpen);

             // Close other open dropdowns
             document.querySelectorAll('.custom-dropdown-list.show').forEach(otherList => {
                 if (otherList !== list) {
                     otherList.classList.remove('show');
                     otherList.parentNode.querySelector('.custom-dropdown-header').classList.remove('open');
                 }
             });

            if (isOpen) {
                 // Set initial focus on the selected item or the first item
                 const selectedItem = list.querySelector('.custom-dropdown-list-item.selected') || list.querySelector('.custom-dropdown-list-item');
                 if (selectedItem) {
                     selectedItem.focus();
                 }
             }
        }

         function handleDropdownKeyDown(e) {
             const header = this;
             const list = header.nextElementSibling;
             const isOpen = list.classList.contains('show');

             if (e.key === 'Enter' || e.key === ' ') {
                 e.preventDefault();
                 toggleDropdown.call(header);
             } else if (e.key === 'ArrowDown' && !isOpen) {
                  e.preventDefault();
                 toggleDropdown.call(header);
             } else if (e.key === 'ArrowDown' && isOpen) {
                  e.preventDefault();
                  const firstItem = list.querySelector('.custom-dropdown-list-item');
                  if (firstItem) firstItem.focus();
             } else if (e.key === 'Escape' && isOpen) {
                  e.preventDefault();
                  list.classList.remove('show');
                  header.classList.remove('open');
                  header.focus(); // Return focus to the header
             }
         }

        function selectDropdownItem() {
            const item = this;
            const dropdown = item.closest('.custom-dropdown');
            const header = dropdown.querySelector('.custom-dropdown-header');
            const list = dropdown.querySelector('.custom-dropdown-list');
            const value = item.dataset.value;
            const text = item.textContent;

            // Update the header text
            dropdown.querySelector('span').textContent = text;

            // Update selected state
            list.querySelectorAll('.custom-dropdown-list-item').forEach(li => {
                li.classList.remove('selected');
                 li.setAttribute('aria-selected', 'false');
            });
            item.classList.add('selected');
             item.setAttribute('aria-selected', 'true');


            // Hide the dropdown
            list.classList.remove('show');
             header.classList.remove('open');
             header.focus(); // Return focus to the header after selection

            // Trigger the appropriate change event
            if (dropdown.id === 'theme-dropdown') {
                applyTheme(value);
            } else if (dropdown.id === 'search-engine-dropdown') {
                handleSearchEngineChange({ target: { value: value } });
            }
        }

         function handleDropdownItemKeyDown(e) {
             const item = this;
             const list = item.closest('.custom-dropdown-list');
             const items = Array.from(list.querySelectorAll('.custom-dropdown-list-item'));
             const currentIndex = items.indexOf(item);

             if (e.key === 'Enter' || e.key === ' ') {
                 e.preventDefault();
                 selectDropdownItem.call(item);
             } else if (e.key === 'ArrowDown') {
                 e.preventDefault();
                 const nextIndex = (currentIndex + 1) % items.length;
                 items[nextIndex].focus();
             } else if (e.key === 'ArrowUp') {
                 e.preventDefault();
                 const prevIndex = (currentIndex - 1 + items.length) % items.length;
                 items[prevIndex].focus();
             } else if (e.key === 'Escape') {
                 e.preventDefault();
                 const header = list.parentNode.querySelector('.custom-dropdown-header');
                 list.classList.remove('show');
                  header.classList.remove('open');
                 header.focus();
             }
         }

        function updateSelectedDropdownText(dropdownId, selectedValue) {
            const dropdownEl = document.getElementById(dropdownId);
            const selectedTextEl = dropdownEl.querySelector('span');
            const selectedItem = dropdownEl.querySelector(`.custom-dropdown-list-item[data-value="${selectedValue}"]`);
            if (selectedItem) {
                selectedTextEl.textContent = selectedItem.textContent;
                 // Also update the 'selected' class and aria-selected attribute
                 dropdownEl.querySelectorAll('.custom-dropdown-list-item').forEach(item => {
                     item.classList.remove('selected');
                     item.setAttribute('aria-selected', 'false');
                 });
                 selectedItem.classList.add('selected');
                 selectedItem.setAttribute('aria-selected', 'true');
            }
        }


        function loadSettings() {
            // Load Theme
            const savedTheme = localStorage.getItem('vernTheme') || 'default';
            applyTheme(savedTheme);
            updateSelectedDropdownText('theme-dropdown', savedTheme);

            // Load Search Engine
            const savedSearchEngine = localStorage.getItem('vernSearchEngine') || 'duckduckgo';
            if (searchEngines[savedSearchEngine]) {
                currentSearchEngineKey = savedSearchEngine;
            }
            updateSelectedDropdownText('search-engine-dropdown', currentSearchEngineKey);
        }

        // --- EVENT LISTENERS SETUP ---
        function setupEventListeners() {
            if(toggleTopBarButtonEl) toggleTopBarButtonEl.addEventListener('click', () => handleTopBarToggle());
            if(toggleSidebarButtonEl) toggleSidebarButtonEl.addEventListener('click', handleSidebarToggle);

            window.addEventListener('resize', () => {
                if (!isTopBarHidden) updateInitialTopBarHeight();
                if (!isSidebarHidden) {
                     toggleSidebarButtonEl.style.left = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
                }
            });

            if(newTabButtonEl) newTabButtonEl.addEventListener('click', () => createTab('about:blank'));
            if(tabBarEl) tabBarEl.addEventListener('click', handleTabBarClick);
            if(searchBarEl) searchBarEl.addEventListener('keydown', handleSearchEnter);

            if(homeButtonEl) homeButtonEl.addEventListener('click', () => navigateTo('about:blank'));
            if(backButtonEl) backButtonEl.addEventListener('click', () => getActiveTab()?.iframe.contentWindow.history.back());
            if(forwardButtonEl) forwardButtonEl.addEventListener('click', () => getActiveTab()?.iframe.contentWindow.history.forward());
            if(refreshButtonEl) refreshButtonEl.addEventListener('click', () => {
                const activeTab = getActiveTab();
                if (activeTab?.iframe.contentWindow) {
                    try {
                        // Forcing reload for proxied pages, direct reload for others
                        if (activeTab.iframe.src.includes(__uv$config.prefix)) {
                             activeTab.iframe.contentWindow.location.reload(true); // Force reload for proxied content
                        } else {
                            activeTab.iframe.contentWindow.location.reload();
                        }
                    } catch (e) { activeTab.iframe.src = activeTab.iframe.src; } // Fallback to re-assigning src
                }
            });

            if(addCurrentBookmarkButtonEl) addCurrentBookmarkButtonEl.addEventListener('click', handleAddCurrentBookmark);
            if(bookmarksListEl) bookmarksListEl.addEventListener('click', handleBookmarkClick);
            if(historyListEl) historyListEl.addEventListener('click', handleHistoryClick);

            // Removed event listeners for old select elements

            document.addEventListener('keydown', handleGlobalKeyDown);
            document.addEventListener('load', handleIframeLoad, true); // Use capture phase
            window.addEventListener('message', handleWindowMessage);
        }

        // --- TAB MANAGEMENT ---
        function createTab(url = null) {
            const tabId = `tab-${tabCounter++}`;
            const contentId = `content-${tabId}`;
            const tabElement = document.createElement('div');
            tabElement.className = 'tab';
            tabElement.dataset.tabId = tabId;
            tabElement.innerHTML = `<div class="tab-favicon"><i class="fas fa-globe" style="font-size: 14px;"></i></div><div class="tab-title">New Tab</div><div class="tab-close"><i class="fas fa-times"></i></div>`;
            tabBarEl.insertBefore(tabElement, newTabButtonEl);

            const iframe = document.createElement('iframe');
            iframe.id = contentId;
            iframe.className = 'tab-content';
            // Sandbox attributes: allow-scripts (for website functionality), allow-same-origin (for UV proxy interaction),
            // allow-forms, allow-popups, allow-presentation, allow-downloads.
            // allow-top-navigation-by-user-activation (might be useful but can be risky with proxies)
            iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-popups allow-presentation allow-downloads allow-popups-to-escape-sandbox';
            iframe.loading = 'eager'; // Load iframes eagerly for active tabs
            tabsContainerEl.appendChild(iframe);

            const tab = { id: tabId, contentId, element: tabElement, iframe, url: url || 'about:blank', title: 'New Tab', titleElement: tabElement.querySelector('.tab-title'), faviconElement: tabElement.querySelector('.tab-favicon'), isLoading: false };
            tabs.push(tab);
            activateTab(tabId);
            navigateTo(tab.url, tab);
            return tab;
        }

        function activateTab(tabId) {
            if (!tabId && tabs.length > 0) tabId = tabs[0].id;
            if (!tabId) return;
            tabs.forEach(t => { t.element.classList.remove('active'); t.iframe.classList.remove('active'); });
            const tab = tabs.find(t => t.id === tabId);
            if (tab) {
                tab.element.classList.add('active');
                tab.iframe.classList.add('active');
                activeTabId = tabId;
                searchBarEl.value = (tab.url && tab.url !== 'about:blank' && !tab.url.startsWith('about:error')) ? tab.url : '';
                tab.element.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
                updateDocumentTitle(tab);
            }
        }

        function closeTab(tabId) {
            const tabIndex = tabs.findIndex(t => t.id === tabId);
            if (tabIndex === -1) return;
            const tab = tabs[tabIndex];
            if (tab.titleObserver) tab.titleObserver.disconnect();
            if (tab.locationCheckIntervalId) clearInterval(tab.locationCheckIntervalId);
            tab.element.remove(); tab.iframe.remove(); tabs.splice(tabIndex, 1);
            if (activeTabId === tabId) {
                if (tabs.length > 0) activateTab(tabs[Math.max(0, tabIndex - 1)].id);
                else createTab('about:blank'); // Create a new blank tab if all are closed
            }
        }
        function getActiveTab() { return tabs.find(t => t.id === activeTabId); }

        function updateTabInfo(tab, title, faviconUrl) {
            if (!tab) return;
            const displayTitle = title || (tab.url === 'about:blank' ? 'New Tab' : (tab.url || 'Loading...'));
            tab.title = displayTitle;
            tab.titleElement.textContent = displayTitle.length > 20 ? displayTitle.substring(0,18) + '...' : displayTitle;
            tab.titleElement.title = displayTitle; // Full title on hover

            if (faviconUrl) {
                tab.faviconElement.innerHTML = `<img src="${faviconUrl}" alt="" style="width:16px;height:16px;object-fit:contain;">`;
            } else if (tab.url && tab.url !== 'about:blank' && tab.url.startsWith('http')) {
                try {
                    const siteUrl = new URL(tab.url);
                    tab.faviconElement.innerHTML = `<img src="${siteUrl.protocol}//${siteUrl.hostname}/favicon.ico" alt="" style="width:16px;height:16px;object-fit:contain;" onerror="this.parentNode.innerHTML = '<i class=\\'fas fa-globe\\' style=\\'font-size: 14px;\\'></i>';">`;
                } catch (e) { tab.faviconElement.innerHTML = `<i class="fas fa-globe" style="font-size: 14px;"></i>`; }
            } else { tab.faviconElement.innerHTML = `<i class="fas fa-globe" style="font-size: 14px;"></i>`; }
            if (tab.id === activeTabId) updateDocumentTitle(tab);
        }
        function updateDocumentTitle(tab) {
            if (!tab) tab = getActiveTab();
            document.title = `${tab ? (tab.title || 'New Tab') : 'New Tab'} - Vern Browser Pro`;
        }

        // --- NAVIGATION ---
        function formatUrlInput(input) {
            if (/^(?:[a-z]+:)?\/\//i.test(input)) {
                if(input.startsWith("//")) return "https:" + input;
                return input;
            }
            if (/^([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}(\/.*)*$/.test(input) ||
                input.startsWith("localhost:") || /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(:\d+)?(\/.*)*$/.test(input) ) { // Added localhost and IP support
                return 'https://' + input;
            }
            return null;
        }

        function navigateTo(urlInput, tab = null) {
            let currentTab = tab || getActiveTab();
            if (!currentTab) {
                currentTab = createTab(urlInput); return;
            }
            currentTab.isLoading = true;
            updateTabInfo(currentTab, "Loading...", null);

            if (!urlInput || typeof urlInput !== 'string' || urlInput.trim() === '') urlInput = 'about:blank';

            if (urlInput === 'about:blank' || urlInput.startsWith('about:')) {
                currentTab.iframe.src = urlInput;
                currentTab.url = urlInput;
                if (currentTab.id === activeTabId) searchBarEl.value = (urlInput === 'about:blank' || urlInput.startsWith('about:error')) ? '' : urlInput;
                updateTabInfo(currentTab, urlInput === 'about:blank' ? 'New Tab' : urlInput);
                if (!urlInput.startsWith('about:error')) addToHistory(urlInput === 'about:blank' ? 'New Tab' : urlInput, urlInput);
                currentTab.isLoading = false;
                return;
            }

            let targetUrl = formatUrlInput(urlInput.trim());

            if (targetUrl) {
                // URL already formatted
            } else { // It's a search query
                const searchEngine = searchEngines[currentSearchEngineKey] || searchEngines['duckduckgo'];
                targetUrl = searchEngine.url.replace('%s', encodeURIComponent(urlInput.trim()));
            }

            if (typeof __uv$config === 'undefined' || !__uv$config.prefix || typeof __uv$config.encodeUrl !== 'function') {
                console.error("UV configuration is not available.");
                const errorUrl = `about:error#uv_config_missing&url=${encodeURIComponent(targetUrl)}`;
                currentTab.iframe.src = errorUrl;
                currentTab.url = errorUrl;
                updateTabInfo(currentTab, "Error: UV Config Missing");
                currentTab.isLoading = false;
                if (currentTab.id === activeTabId) searchBarEl.value = '';
                return;
            }

            try {
                const proxiedUrl = self.location.origin + __uv$config.prefix + __uv$config.encodeUrl(targetUrl);
                currentTab.iframe.src = proxiedUrl;
                currentTab.url = targetUrl;
                if (currentTab.id === activeTabId) searchBarEl.value = targetUrl;
            } catch (err) {
                console.error("Navigation error:", err);
                const errorUrl = `about:error#navigation_failed&message=${encodeURIComponent(err.message)}&query=${encodeURIComponent(urlInput)}`;
                currentTab.iframe.src = errorUrl;
                currentTab.url = errorUrl;
                updateTabInfo(currentTab, "Navigation Error");
                currentTab.isLoading = false;
                if (currentTab.id === activeTabId) searchBarEl.value = '';
            }
        }

        // --- UI TOGGLES & RESIZE ---
        function handleTopBarToggle(forceState) {
            if (forceState !== undefined) isTopBarHidden = forceState; else isTopBarHidden = !isTopBarHidden;
            if (isTopBarHidden) {
                topBarAssemblyEl.classList.add('hidden'); topBarAssemblyEl.style.maxHeight = '0px'; toggleTopBarButtonEl.style.top = '-1px';
                toggleBarIconEl.className = 'fas fa-chevron-down'; toggleTopBarButtonEl.title = "Show Toolbar";
            } else {
                topBarAssemblyEl.classList.remove('hidden'); topBarAssemblyEl.style.maxHeight = initialTopBarHeight + 'px';
                toggleTopBarButtonEl.style.top = (initialTopBarHeight > 0 ? initialTopBarHeight -1 : 0) + 'px';
                toggleBarIconEl.className = 'fas fa-chevron-up'; toggleTopBarButtonEl.title = "Hide Toolbar";
            }
        }
        function handleSidebarToggle() {
            isSidebarHidden = !isSidebarHidden;
            const sidebarWidth = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
            if (isSidebarHidden) {
                sidebarEl.classList.add('hidden'); toggleSidebarIconEl.className = 'fas fa-chevron-right';
                toggleSidebarButtonEl.style.left = '0px'; toggleSidebarButtonEl.title = "Show Sidebar";
            } else {
                sidebarEl.classList.remove('hidden'); toggleSidebarIconEl.className = 'fas fa-chevron-left';
                toggleSidebarButtonEl.style.left = sidebarWidth; toggleSidebarButtonEl.title = "Hide Sidebar";
            }
        }
        function updateInitialTopBarHeight() {
            const wasHidden = topBarAssemblyEl.classList.contains('hidden');
            if (wasHidden) { topBarAssemblyEl.classList.remove('hidden'); topBarAssemblyEl.style.maxHeight = 'none'; } // Temporarily show to measure
            initialTopBarHeight = topBarAssemblyEl.offsetHeight;
            if (wasHidden) { topBarAssemblyEl.classList.add('hidden'); topBarAssemblyEl.style.maxHeight = '0px';} // Re-hide if it was
            else { topBarAssemblyEl.style.maxHeight = initialTopBarHeight + 'px'; } // Apply measured height
            if (!isTopBarHidden && initialTopBarHeight > 0) {
                toggleTopBarButtonEl.style.top = (initialTopBarHeight -1) + 'px'; // Adjust button position
            } else if (!isTopBarHidden && initialTopBarHeight === 0) { // Case where it might be 0 if display none initially
                 toggleTopBarButtonEl.style.top = '0px';
            }
        }

        // --- EVENT HANDLERS ---
        function handleTabBarClick(e) {
            const tabElement = e.target.closest('.tab'); const closeButton = e.target.closest('.tab-close');
            if (closeButton && tabElement) { e.stopPropagation(); closeTab(tabElement.dataset.tabId); }
            else if (tabElement) activateTab(tabElement.dataset.tabId);
        }
        function handleSearchEnter(e) { if (e.key === 'Enter') navigateTo(e.target.value); }

        function handleIframeLoad(event) {
            // Only act on iframes that are part of our tabs
            if (event.target.tagName === 'IFRAME' && event.target.classList.contains('tab-content')) {
                const iframe = event.target;
                const tab = tabs.find(t => t.iframe === iframe);
                if (tab) {
                    tab.isLoading = false;
                    let title = 'Untitled';
                    let actualUrl = tab.url; // Default to stored URL

                    try {
                        if (iframe.contentWindow && iframe.contentDocument) {
                            title = iframe.contentDocument.title || new URL(tab.url).hostname || 'Untitled';
                            // Attempt to get the "real" URL from inside the iframe (UV might change it)
                            // This might be blocked by cross-origin policies if not careful with UV setup
                            // For now, we rely on the tab.url which is the one we sent to UV
                        }
                    } catch (e) {
                        // If accessing contentDocument fails (cross-origin), fallback to hostname
                        try { title = new URL(tab.url).hostname || 'New Tab'; } catch {}
                        console.warn("Could not access iframe contentDocument for title:", e.message);
                    }

                    // Special handling for about:error pages
                    if(tab.url && tab.url.startsWith('about:error')) {
                        title = "Error Page";
                        // Potentially parse details from #hash if you added them
                    }

                    updateTabInfo(tab, title);
                    if (tab.url && !tab.url.startsWith('about:error') && !tab.url.startsWith('about:blank')) {
                         addToHistory(title, tab.url);
                    }
                    setupTitleObserver(tab); // Re-setup observer if needed
                }
            }
        }
        function handleWindowMessage(event) {
            // Example: if UV posts a message about URL change within the iframe
            if (event.data && event.data.type === 'uv_url_changed') {
                const activeTab = getActiveTab();
                if (activeTab && event.source === activeTab.iframe.contentWindow) {
                    const newUrl = event.data.url; // This would be the "real" URL from inside UV
                    // You might need to decode this if UV encodes it
                    // activeTab.url = newUrl; // Update the tab's stored URL
                    // searchBarEl.value = newUrl;
                    // updateTabInfo(activeTab, event.data.title || "Loading...");
                    // addToHistory(event.data.title || newUrl, newUrl);
                    console.log("UV URL Changed (message):", newUrl);
                }
            }
        }
        function handleGlobalKeyDown(e) {
            // Ignore if typing in an input field (search bar, sidebar inputs)
            const targetTagName = e.target.tagName.toLowerCase();
            if (targetTagName === 'input' || targetTagName === 'textarea' || targetTagName === 'select' || e.target.isContentEditable) return;

            if ((e.ctrlKey || e.metaKey) && e.key === 't') { e.preventDefault(); createTab('about:blank'); }
            if ((e.ctrlKey || e.metaKey) && e.key === 'w') { e.preventDefault(); if (activeTabId) closeTab(activeTabId); }
            if (e.ctrlKey && e.key === 'Tab') { // Cycle tabs
                e.preventDefault();
                if (tabs.length > 1) {
                    const currentIndex = tabs.findIndex(t => t.id === activeTabId);
                    const nextIndex = (currentIndex + (e.shiftKey ? -1 : 1) + tabs.length) % tabs.length;
                    activateTab(tabs[nextIndex].id);
                }
            }
            if (e.altKey && e.key === 'ArrowLeft') { e.preventDefault(); backButtonEl.click(); }
            if (e.altKey && e.key === 'ArrowRight') { e.preventDefault(); forwardButtonEl.click(); }
            if (e.key === 'F5' || ((e.ctrlKey || e.metaKey) && e.key === 'r')) { e.preventDefault(); refreshButtonEl.click(); }
            if (e.key === 'F11') { e.preventDefault(); handleTopBarToggle(); /* Or document.documentElement.requestFullscreen(); */ }
            if ((e.ctrlKey || e.metaKey) && e.key === 'l') { e.preventDefault(); searchBarEl.focus(); searchBarEl.select(); }
        }

        function setupTitleObserver(tab) {
            if (!tab || !tab.iframe.contentWindow) return;
            if (tab.titleObserver) tab.titleObserver.disconnect(); // Disconnect previous if any

            try {
                const targetNode = tab.iframe.contentDocument.querySelector('title');
                if (!targetNode) return;

                const observer = new MutationObserver(() => {
                    if (tab.iframe.contentDocument) {
                        updateTabInfo(tab, tab.iframe.contentDocument.title);
                    }
                });
                observer.observe(targetNode, { subtree: true, characterData: true, childList: true });
                tab.titleObserver = observer;
            } catch (e) {
                console.warn("Could not set up title observer for tab:", tab.id, e.message);
                // Fallback: periodically check title if observer fails (e.g., cross-origin)
                if (tab.locationCheckIntervalId) clearInterval(tab.locationCheckIntervalId);
                tab.locationCheckIntervalId = setInterval(() => {
                    try {
                        if (tab.iframe.contentDocument && tab.title !== tab.iframe.contentDocument.title) {
                             updateTabInfo(tab, tab.iframe.contentDocument.title);
                        }
                    } catch (err) {/* ignore */}
                }, 2000);
            }
        }


        // --- BOOKMARKS ---
        function loadBookmarks() { const bms = JSON.parse(localStorage.getItem('vernBookmarks') || '[]'); bookmarksListEl.innerHTML = ''; bms.forEach(bm => renderBookmarkItem(bm));}
        function saveBookmarks(bms) { localStorage.setItem('vernBookmarks', JSON.stringify(bms)); }
        function renderBookmarkItem(bm) {
            const li = document.createElement('li'); li.dataset.url = bm.url; li.title = `${bm.name}\n${bm.url}`;
            const nameSpan = document.createElement('span'); nameSpan.textContent = bm.name.length > 20 ? bm.name.substring(0,18) + '...' : bm.name;
            const urlSpan = document.createElement('span'); urlSpan.className = 'bookmark-url'; urlSpan.textContent = bm.url.length > 25 ? bm.url.substring(0, 22) + '...' : bm.url; // Adjusted length for pill
            const removeBtn = document.createElement('i'); removeBtn.className = 'fas fa-times';
            removeBtn.style.cssText = 'position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; padding: 5px; opacity: 0.7;';
            removeBtn.onmouseover = () => removeBtn.style.opacity = '1';
            removeBtn.onmouseout = () => removeBtn.style.opacity = '0.7';
            removeBtn.title = 'Remove Bookmark';
            removeBtn.onclick = (e) => { e.stopPropagation(); removeBookmark(bm.url); };
            li.appendChild(nameSpan); li.appendChild(urlSpan); li.appendChild(removeBtn);
            li.style.position = 'relative'; // For absolute positioning of remove button
            bookmarksListEl.appendChild(li);
        }
        function handleAddCurrentBookmark() {
            const activeTab = getActiveTab();
            if (!activeTab || !activeTab.url || activeTab.url === 'about:blank' || activeTab.url.startsWith('about:')) {
                alert("Cannot bookmark this page."); return;
            }
            const name = newBookmarkNameInputEl.value.trim() || activeTab.title || new URL(activeTab.url).hostname;
            const url = activeTab.url;
            let bms = JSON.parse(localStorage.getItem('vernBookmarks') || '[]');
            if (bms.some(b => b.url === url)) { alert("This page is already bookmarked."); return; }
            bms.push({ name, url }); saveBookmarks(bms); renderBookmarkItem({ name, url }); newBookmarkNameInputEl.value = '';
        }
        function removeBookmark(urlToRemove) { let bms = JSON.parse(localStorage.getItem('vernBookmarks') || '[]'); bms = bms.filter(b => b.url !== urlToRemove); saveBookmarks(bms); loadBookmarks(); }
        function handleBookmarkClick(e) {
            const li = e.target.closest('li[data-url]');
            if (li && !e.target.classList.contains('fa-times')) { // Make sure not clicking the remove button
                createTab(li.dataset.url);
                if (!isSidebarHidden && window.innerWidth < 768) handleSidebarToggle(); // Auto-hide sidebar on mobile after click
            }
        }

        // --- SESSION HISTORY ---
        function addToHistory(title, url) {
            if (!url || url === 'about:blank' || url.startsWith('about:')) return;
            // Prevent duplicate consecutive entries
            if (sessionHistory.length > 0 && sessionHistory[sessionHistory.length - 1].url === url) return;
            sessionHistory.push({ title, url, timestamp: new Date() });
            if (sessionHistory.length > MAX_HISTORY_ITEMS) sessionHistory.shift();
            renderHistory();
        }
        function renderHistory() {
            historyListEl.innerHTML = '';
            [...sessionHistory].reverse().forEach(item => {
                const li = document.createElement('li'); li.dataset.url = item.url;
                li.title = `${item.title}\n${item.url}\n${item.timestamp.toLocaleTimeString()}`;
                const titleSpan = document.createElement('span'); titleSpan.textContent = item.title.length > 22 ? item.title.substring(0,19) + '...' : item.title; // Adjusted length
                const urlSpan = document.createElement('span'); urlSpan.className = 'history-url'; urlSpan.textContent = item.url.length > 25 ? item.url.substring(0, 22) + '...' : item.url; // Adjusted length
                li.appendChild(titleSpan); li.appendChild(urlSpan); historyListEl.appendChild(li);
            });
        }
        function handleHistoryClick(e) {
            const li = e.target.closest('li[data-url]');
            if (li) {
                navigateTo(li.dataset.url); // Use navigateTo for consistency
                if (!isSidebarHidden && window.innerWidth < 768) handleSidebarToggle();
            }
        }

        // --- THEMES & SETTINGS ---
        function applyTheme(themeName) {
            document.body.className = document.body.className.replace(/\btheme-\S+/g, ''); // Remove old theme classes
            if (themeName !== 'default') document.body.classList.add(`theme-${themeName}`);
            localStorage.setItem('vernTheme', themeName);
            updateSelectedDropdownText('theme-dropdown', themeName); // Update custom dropdown text

            // After applying theme, re-calculate heights and positions if necessary
            // This is crucial if theme changes affect element sizes (padding, borders etc.)
            updateInitialTopBarHeight();
            if (!isSidebarHidden) {
                toggleSidebarButtonEl.style.left = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
            }
        }

        // Modified to work with custom dropdown
        function handleSearchEngineChange(e) {
            currentSearchEngineKey = e.target.value;
            localStorage.setItem('vernSearchEngine', currentSearchEngineKey);
            updateSelectedDropdownText('search-engine-dropdown', currentSearchEngineKey); // Update custom dropdown text
            console.log("Search engine changed to:", searchEngines[currentSearchEngineKey].name);
        }

        console.log("Vern Max Initialized with new sidebar styles, themes, and custom dropdowns.");
    </script>
</body>
</html>
