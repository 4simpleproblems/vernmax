<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>VERN MAX - BROWSER</title>
    <link rel="stylesheet" href="../css/style.css" /> <link rel="icon" type="image/x-icon" href="logo.png" id="app-favicon" />
    <style id="custom-styles">
        /* Core Theme Variables & Component Mappings - Purple & Dark Grey Theme */
        :root {
            --current-theme-bg: #23272A;
            --current-theme-text: #E0E1DD;
            --current-theme-accent: #7F5AF0;
            --current-theme-neutral: #2C2F33;
            --current-theme-button-text: #FFFFFF;
            --current-theme-shadow-rgb: 0, 0, 0;
            --current-theme-shadow-opacity-strong: 0.4;
            --current-theme-shadow-opacity-medium: 0.25;
            --current-theme-shadow-opacity-light: 0.15;
            --current-theme-focus-ring-color: var(--current-theme-accent);

            --bg-color: var(--current-theme-bg);
            --text-color: var(--current-theme-text);
            --iframe-bg: var(--current-theme-bg); /* iframe background */
            --footer-text-color: var(--current-theme-text);
            --font-family-main: 'PrimaryFont', sans-serif;

            --toolbar-bg: var(--current-theme-neutral);
            --toolbar-shadow: 0 2px 5px rgba(var(--current-theme-shadow-rgb), var(--current-theme-shadow-opacity-medium));
            --toolbar-border-color: color-mix(in srgb, var(--current-theme-neutral) 70%, var(--current-theme-text));

            --button-bg: var(--current-theme-accent);
            --button-hover-bg: color-mix(in srgb, var(--current-theme-accent) 80%, var(--current-theme-text));
            --button-text-color: var(--current-theme-button-text);
            --button-outline-color: color-mix(in srgb, var(--current-theme-accent) 60%, transparent);


            --input-bg: color-mix(in srgb, var(--current-theme-neutral) 90%, var(--current-theme-bg));
            --input-focus-bg: var(--current-theme-bg);
            --input-focus-shadow: 0 0 0 2px color-mix(in srgb, var(--current-theme-focus-ring-color) 50%, transparent);

            --menu-bg: var(--input-bg);
            --menu-item-hover-bg: var(--button-hover-bg);
            --menu-text-color: var(--text-color);
            --menu-shadow: 0 4px 12px rgba(var(--current-theme-shadow-rgb), var(--current-theme-shadow-opacity-strong));
            --menu-border-color: var(--button-outline-color);
        }

        html, body {
            margin: 0; padding: 0; border: none; box-sizing: border-box;
            width: 100%; height: 100%; overflow: hidden;
            font-family: var(--font-family-main);
            background-color: var(--bg-color); color: var(--text-color);
            display: flex;
            flex-direction: column;
        }

        canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
        }

        #toolbar {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background-color: var(--toolbar-bg);
            box-shadow: var(--toolbar-shadow);
            border-bottom: 1px solid var(--toolbar-border-color);
            z-index: 1000;
            position: relative;
        }

        .nav-button, .toolbar-button {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            margin-right: 8px; border-radius: 25%; background-color: var(--button-bg);
            cursor: pointer; color: var(--button-text-color); transition: background-color 0.2s, color 0.2s;
            box-shadow: 0 0 0 1px var(--button-outline-color); font-size: 20px;
            position: relative;
            flex-shrink: 0;
        }
        .nav-button:hover, .toolbar-button:hover { background-color: var(--button-hover-bg); }

        .nav-button .icon-img, .toolbar-button .icon-img {
            width: 20px;
            height: 20px;
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none;    /* Firefox */
            -ms-user-select: none;     /* IE10+/Edge */
            user-select: none;         /* Standard */
            pointer-events: none;      /* Prevents image itself from capturing clicks meant for button */
        }


        #search-bar {
            flex: 1; height: 36px; border-radius: 8px; border: none; background-color: var(--input-bg);
            color: var(--text-color); padding: 0 15px; font-size: 14px;
            box-shadow: 0 0 0 1px var(--button-outline-color); font-family: var(--font-family-main);
            margin-right: 8px;
        }
        #search-bar:focus { outline: none; background-color: var(--input-focus-bg); box-shadow: var(--input-focus-shadow); }

        #bookmark-button, #history-button, #fullscreen-button {
             margin-right: 8px;
        }
        #settings-button {
            margin-left: auto;
            margin-right: 0;
        }


        .mini-menu {
            position: absolute;
            top: calc(100% + 5px); /* Position below the toolbar */
            background-color: var(--menu-bg);
            border: 1px solid var(--menu-border-color);
            border-radius: 8px;
            box-shadow: var(--menu-shadow);
            z-index: 1005;
            min-width: 280px;
            max-width: 350px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            color: var(--menu-text-color);

            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px) scale(0.98);
            transition: opacity 0.25s ease-out, transform 0.25s ease-out, visibility 0s linear 0.25s;
        }
        .mini-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
            transition: opacity 0.25s ease-out, transform 0.25s ease-out, visibility 0s linear 0s;
        }

        /* Dynamic positioning via JS will override these if needed, but good for initial layout */
        /* #bookmark-menu { right: 10px; }
        #history-menu { right: 10px; } */


        .mini-menu h3 {
            margin-top: 0; margin-bottom: 10px; font-size: 1.1em;
            border-bottom: 1px solid var(--toolbar-border-color); padding-bottom: 8px;
            font-weight: 600; display: flex; align-items: center; gap: 8px;
        }
        .mini-menu h3 .icon-img { width: 1em; height: 1em; }

        .mini-menu ul { list-style: none; padding: 0; margin: 0; }
        .mini-menu ul::-webkit-scrollbar { width: 5px; }
        .mini-menu ul::-webkit-scrollbar-thumb { background-color: var(--button-outline-color); border-radius: 8px; }

        .mini-menu li {
            padding: 9px 15px; margin-bottom: 7px; border-radius: 12px;
            cursor: pointer; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            transition: background-color 0.2s ease, color 0.2s ease;
            background-color: color-mix(in srgb, var(--current-theme-neutral) 70%, var(--current-theme-bg));
            color: var(--text-color);
            position: relative;
        }
        .mini-menu li:hover {
            background-color: var(--menu-item-hover-bg);
            color: var(--button-text-color);
        }
        .mini-menu li .item-url {
            font-size: 0.75em; opacity: 0.7; display: block; margin-top: 2px;
        }
        .mini-menu .item-remove-button {
            position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer;
            padding: 5px; opacity: 0.7; display:inline-flex; align-items:center; justify-content:center;
            background: none; border: none; color: inherit;
        }
        .mini-menu .item-remove-button:hover { opacity: 1; background-color: rgba(var(--current-theme-shadow-rgb),0.1); border-radius: 50%; }
        .mini-menu .item-remove-icon { width: 12px; height: 12px; display: block; }

        .mini-menu .menu-action-bar { margin-top:15px; padding-top:10px; border-top: 1px solid var(--toolbar-border-color); }
        .mini-menu .menu-input {
            width: calc(100% - 30px); height: 38px; padding: 0 15px; margin-bottom: 10px;
            background-color: var(--input-bg); color: var(--text-color);
            border: none; border-radius: 12px; font-family: var(--font-family-main);
            box-sizing: border-box; box-shadow: 0 0 0 1px var(--button-outline-color);
            font-size: 0.9em;
        }
         .mini-menu .menu-input:focus { outline: none; background-color: var(--input-focus-bg); box-shadow: var(--input-focus-shadow); }
        .mini-menu .menu-button {
            width: 100%; height: 38px; padding: 0 15px;
            background-color: var(--button-bg); color: var(--button-text-color);
            border: none; border-radius: 12px; cursor: pointer;
            transition: background-color 0.2s ease; font-family: var(--font-family-main);
            box-shadow: 0 0 0 1px var(--button-outline-color);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9em; font-weight: 500;
        }
        .mini-menu .menu-button:hover { background-color: var(--button-hover-bg); }
        .mini-menu .menu-button .icon-img { width: 16px; height: 16px; margin-right: 8px; }
        .mini-menu .menu-button.clear-button {
            background-color: color-mix(in srgb, var(--current-theme-accent) 60%, #c0392b);
        }
        .mini-menu .menu-button.clear-button:hover {
            background-color: #c0392b;
        }


        #content-container {
            flex: 1;
            position: relative;
            background-color: var(--iframe-bg);
            overflow: hidden;
        }
        #content-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        .footer-label {
            position: fixed; bottom: 0; right: 0; margin: 0.25rem; font-family: var(--font-family-main);
            font-size: 0.75rem; color: var(--footer-text-color); text-decoration: none; z-index: 1000;
        }

        .icon-img { display: inline-block; vertical-align: middle; object-fit: contain; }

        #refresh-button .icon-img {
            transform: rotate(0deg); transition: transform 0.5s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        #refresh-button .icon-img.spinning { animation: spinRefreshIcon 0.7s linear infinite; }
        @keyframes spinRefreshIcon { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        body.app-ui-hidden #toolbar { display: none !important; }

    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <template id="bookmark-item-template">
        <li>
            <span class="item-name">Bookmark Name</span>
            <span class="item-url">bookmark.url</span>
            <button class="item-remove-button" title="Remove Bookmark">
                <img src="../images/cross-white.png" alt="Remove" class="item-remove-icon">
            </button>
        </li>
    </template>

    <template id="history-item-template">
        <li>
            <span class="item-name">History Title</span>
            <span class="item-url">history.url</span>
        </li>
    </template>

    <div id="toolbar">
        <div class="nav-button" id="home-button" title="Home"><img src="../images/home-white.png" alt="Home" class="icon-img"></div>
        <div class="nav-button" id="back-button" title="Back"><img src="../images/arrow-left-white.png" alt="Back" class="icon-img"></div>
        <div class="nav-button" id="forward-button" title="Forward"><img src="../images/arrow-right-white.png" alt="Forward" class="icon-img"></div>
        <div class="nav-button" id="refresh-button" title="Refresh"><img src="../images/refresh-white.png" alt="Refresh" class="icon-img"></div>

        <input type="text" id="search-bar" placeholder="Search or type a URL">

        <div class="toolbar-button" id="bookmark-button" title="Bookmarks">
            <img src="../images/star-white.png" alt="Bookmarks" class="icon-img">
        </div>
        <div class="toolbar-button" id="history-button" title="History">
            <img src="../images/clock-white.png" alt="History" class="icon-img">
        </div>
         <div class="toolbar-button" id="fullscreen-button" title="Toggle Fullscreen">
            <img src="../images/zoom-in-white.png" alt="Toggle Fullscreen" id="fullscreen-icon-img" class="icon-img">
        </div>
        <div class="toolbar-button" id="settings-button" title="Settings">
            <img src="../images/gear-white.png" alt="Settings" class="icon-img">
        </div>
    </div>

    <div id="bookmark-menu" class="mini-menu">
        <h3><img src="../images/star-white.png" alt="Bookmarks" class="icon-img"> Bookmarks</h3>
        <ul id="bookmarks-list-popup"></ul>
        <div class="menu-action-bar">
            <input type="text" id="new-bookmark-name-popup" class="menu-input" placeholder="Bookmark Name (optional)">
            <button id="add-current-bookmark-button-popup" class="menu-button">
                <img src="../images/plus-symbol-white.png" alt="Add" class="icon-img">Bookmark Current Page
            </button>
        </div>
    </div>

    <div id="history-menu" class="mini-menu">
        <h3><img src="../images/clock-white.png" alt="History" class="icon-img"> Session History</h3>
        <ul id="history-list-popup"></ul>
        <div class="menu-action-bar">
            <button id="clear-history-button" class="menu-button clear-button">
                <img src="../images/trash-white.png" alt="Clear" class="icon-img">Clear History
            </button>
        </div>
    </div>

    <div id="content-container">
        <iframe id="content-iframe" title="Content View" sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-presentation allow-same-origin allow-scripts allow-downloads allow-popups-to-escape-sandbox"></iframe>
    </div>

    <a href="https://4simpleproblems.github.io" target="_blank" class="footer-label">Vern Max by 4SP</a>

    <script src="uv/uv.bundle.js" defer></script>
    <script src="uv/uv.config.js" defer></script>
    <script src="register-sw.js" defer></script>
    <script src="stars.js" defer></script>
    <script>
        // Single Browse context variables
        let currentUrl = 'about:blank';
        let currentTitle = 'New Tab';
        let currentFavicon = null;
        let isLoading = false;
        let isRefreshing = false;

        let sessionHistory = [];
        const MAX_HISTORY_ITEMS = 50;

        const searchEngines = { /* ... (same as original) ... */ 'duckduckgo': { name: 'DuckDuckGo', url: 'https://duckduckgo.com/?q=%s' }, 'google': { name: 'Google', url: 'https://www.google.com/search?q=%s' }, 'bing': { name: 'Bing', url: 'https://www.bing.com/search?q=%s' }, 'brave': { name: 'Brave Search', url: 'https://search.brave.com/search?q=%s' } };
        let currentSearchEngineKey = 'duckduckgo';

        const cloakPresets = { /* ... (same as original) ... */ 'none': { displayName: "None (Show App Default)", title: "VERN MAX - BROWSER", faviconUrl: "../images/title-mini.png" }, 'google_docs': { displayName: "Google Docs", title: 'Google Docs', faviconUrl: 'https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico' }, 'google_drive': { displayName: "My Drive", title: 'My Drive', faviconUrl: 'https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png' }, 'wikipedia': { displayName: "Wikipedia", title: 'Wikipedia', faviconUrl: 'https://en.wikipedia.org/static/favicon/wikipedia.ico' }, 'new_tab': { displayName: "New Tab (Chrome Style)", title: 'New Tab', faviconUrl: '../images/new-tab-chrome.png' }, 'no_favicon_chrome': { displayName: "No Favicon - Chrome", title: ' ', faviconUrl: '../images/no-favicon-chrome.png'} };
        let currentCloakPresetKey = 'none';

        // DOM Elements
        let contentIframeEl, searchBarEl, homeButtonEl, backButtonEl, forwardButtonEl, refreshButtonEl,
            fullscreenButtonEl, settingsButtonEl, bookmarkButtonEl, historyButtonEl,
            bookmarkMenuEl, historyMenuEl, bookmarksListPopupEl, newBookmarkNameInputPopupEl,
            addCurrentBookmarkButtonPopupEl, historyListPopupEl, toolbarEl, clearHistoryButtonEl;

        // Templates
        let bookmarkItemTemplate, historyItemTemplate;


        function encodePlainTextUrlForQuery(plainUrl) { /* ... (same as original) ... */ if (!plainUrl) return ''; try { const utf8Bytes = new TextEncoder().encode(plainUrl); let binaryString = ''; utf8Bytes.forEach(byte => { binaryString += String.fromCharCode(byte); }); return btoa(binaryString); } catch (e) { console.error("Base64 encoding failed for:", plainUrl, e); return ''; } }
        function decodeEncodedUrlFromQuery(encodedUrl) { /* ... (same as original) ... */ if (!encodedUrl) return ''; try { const binaryString = atob(encodedUrl); const bytes = new Uint8Array(binaryString.length); for (let i = 0; i < binaryString.length; i++) { bytes[i] = binaryString.charCodeAt(i); } return new TextDecoder().decode(bytes); } catch (e) { console.error("Base64 decoding failed for:", encodedUrl, e); return ''; } }

        function updateBrowserAddressBar() { /* ... (same as original) ... */ const newSearchParams = new URLSearchParams(window.location.search); newSearchParams.delete('url'); if (currentUrl && currentUrl !== 'about:blank' && !currentUrl.startsWith('about:error')) { const encoded = encodePlainTextUrlForQuery(currentUrl); if (encoded) newSearchParams.set('eurl', encoded); else newSearchParams.delete('eurl'); } else { newSearchParams.delete('eurl'); } const newQueryString = newSearchParams.toString(); history.replaceState(null, '', `${window.location.pathname}${newQueryString ? '?' + newQueryString : ''}`); }

        function applyBrowserCloak() { /* ... (same as original) ... */ const appFaviconEl = document.getElementById('app-favicon'); const defaultAppTitle = cloakPresets['none'].title || "VERN MAX - BROWSER"; const defaultAppFavicon = cloakPresets['none'].faviconUrl || "../images/title-mini.png"; let selectedCloak = cloakPresets[currentCloakPresetKey]; if (currentCloakPresetKey !== 'none' && selectedCloak && selectedCloak.title !== undefined) { document.title = selectedCloak.title; if (appFaviconEl) appFaviconEl.href = selectedCloak.faviconUrl || defaultAppFavicon; } else { const nonePreset = cloakPresets['none'] || {}; document.title = nonePreset.title || defaultAppTitle; if (appFaviconEl) appFaviconEl.href = nonePreset.faviconUrl || defaultAppFavicon; } }

        function proxyUrl(urlToProxy) { /* ... (same as original) ... */ if (!urlToProxy || typeof urlToProxy !== 'string' || urlToProxy.trim() === '') return null; if (urlToProxy.startsWith('data:')) return urlToProxy; if (typeof __uv$config === 'undefined' || !__uv$config.prefix || typeof __uv$config.encodeUrl !== 'function') { console.warn("VERN MAX Debug: UV config not available for proxying URL:", urlToProxy); return urlToProxy; } try { const currentOrigin = self.location.origin; if (urlToProxy.startsWith(currentOrigin + __uv$config.prefix) || (urlToProxy.startsWith(currentOrigin) && !urlToProxy.includes(__uv$config.prefix))) return urlToProxy; return currentOrigin + __uv$config.prefix + __uv$config.encodeUrl(urlToProxy); } catch (e) { console.warn("VERN MAX Debug: Error during UV URL encoding for:", urlToProxy, e); return urlToProxy; } }
        function getDefaultFaviconForUrl(basePageUrl) { /* ... (same as original) ... */ if (!basePageUrl || typeof basePageUrl !== 'string' || (!basePageUrl.startsWith('http:') && !basePageUrl.startsWith('https:'))) return null; try { return proxyUrl(new URL('/favicon.ico', new URL(basePageUrl).origin).href); } catch (e) { console.warn("VERN MAX Debug: Error constructing or proxying default /favicon.ico URL from basePageUrl:", basePageUrl, e); return null; } }
        function getFaviconFromIframe() { /* ... (same as original, uses currentUrl and contentIframeEl) ... */ if (contentIframeEl && contentIframeEl.contentDocument && currentUrl) { try { const doc = contentIframeEl.contentDocument; const selectors = ['link[rel="icon"][type="image/svg+xml"]', 'link[rel="icon"]', 'link[rel="apple-touch-icon"]', 'link[rel="shortcut icon"]']; for (const selector of selectors) { const link = doc.querySelector(selector); if (link && link.href && link.href.trim() !== '' && link.href.trim() !== '#') return proxyUrl(link.href); } } catch (e) { console.warn("VERN MAX Debug: Error accessing iframe's document for <link> tags for URL:", currentUrl, e); } } return getDefaultFaviconForUrl(currentUrl); }


        document.addEventListener('DOMContentLoaded', async () => {
            toolbarEl = document.getElementById('toolbar');
            contentIframeEl = document.getElementById('content-iframe');
            searchBarEl = document.getElementById('search-bar');
            homeButtonEl = document.getElementById('home-button');
            backButtonEl = document.getElementById('back-button');
            forwardButtonEl = document.getElementById('forward-button');
            refreshButtonEl = document.getElementById('refresh-button');
            fullscreenButtonEl = document.getElementById('fullscreen-button');
            settingsButtonEl = document.getElementById('settings-button');
            bookmarkButtonEl = document.getElementById('bookmark-button');
            historyButtonEl = document.getElementById('history-button');
            bookmarkMenuEl = document.getElementById('bookmark-menu');
            historyMenuEl = document.getElementById('history-menu');
            bookmarksListPopupEl = document.getElementById('bookmarks-list-popup');
            newBookmarkNameInputPopupEl = document.getElementById('new-bookmark-name-popup');
            addCurrentBookmarkButtonPopupEl = document.getElementById('add-current-bookmark-button-popup');
            historyListPopupEl = document.getElementById('history-list-popup');
            clearHistoryButtonEl = document.getElementById('clear-history-button');


            bookmarkItemTemplate = document.getElementById('bookmark-item-template');
            historyItemTemplate = document.getElementById('history-item-template');

            await initUV();
            loadSettings();
            setupEventListeners();
            loadBookmarks();

            const currentUrlParams = new URLSearchParams(window.location.search);
            let initialUrlToLoad = currentUrlParams.get('url');
            const encodedUrlParam = currentUrlParams.get('eurl');
            const newSearchParamsForBar = new URLSearchParams(window.location.search);
            newSearchParamsForBar.delete('url'); newSearchParamsForBar.delete('eurl');
            if (initialUrlToLoad) { /* use it */ }
            else if (encodedUrlParam) initialUrlToLoad = decodeEncodedUrlFromQuery(encodedUrlParam);
            else initialUrlToLoad = 'about:blank';
            if (initialUrlToLoad && initialUrlToLoad !== 'about:blank' && !initialUrlToLoad.startsWith('about:error')) { const encoded = encodePlainTextUrlForQuery(initialUrlToLoad); if (encoded) newSearchParamsForBar.set('eurl', encoded); }
            history.replaceState(null, '', `${window.location.pathname}${newSearchParamsForBar.toString() ? '?' + newSearchParamsForBar.toString() : ''}`);

            navigateTo(initialUrlToLoad);
            renderHistory();
            applyBrowserCloak();
        });

        async function initUV() { /* ... (same as original) ... */ try { if (typeof registerSW !== 'function') { console.warn("registerSW() function not found."); return; } await registerSW(); } catch (err) { console.error("Failed to register UV service worker:", err); }}
        function loadSettings() { /* ... (same as original) ... */ currentSearchEngineKey = localStorage.getItem('vernSearchEngine') || 'duckduckgo'; currentCloakPresetKey = localStorage.getItem('vernCloakPreset') || 'none'; }

        function setupEventListeners() {
            fullscreenButtonEl.addEventListener('click', toggleIframeFullscreen);
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            searchBarEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') navigateTo(e.target.value); });
            homeButtonEl.addEventListener('click', () => navigateTo('about:blank'));
            backButtonEl.addEventListener('click', () => { try { contentIframeEl.contentWindow.history.back(); } catch(e) { console.warn("Back navigation failed", e); }});
            forwardButtonEl.addEventListener('click', () => { try { contentIframeEl.contentWindow.history.forward(); } catch(e) { console.warn("Forward navigation failed", e); }});
            refreshButtonEl.addEventListener('click', () => {
                if (!contentIframeEl.contentWindow) return;
                const refreshIcon = refreshButtonEl.querySelector('.icon-img');
                if (refreshIcon) refreshIcon.classList.add('spinning');
                isRefreshing = true;
                try { if (typeof __uv$config !== 'undefined' && __uv$config && contentIframeEl.src.includes(__uv$config.prefix)) { contentIframeEl.contentWindow.location.reload(true); } else { contentIframeEl.contentWindow.location.reload(); } }
                catch (e) { contentIframeEl.src = contentIframeEl.src; }
            });

            settingsButtonEl.addEventListener('click', () => { window.location.href = '../active/settings.html'; });
            bookmarkButtonEl.addEventListener('click', (e) => { e.stopPropagation(); toggleBookmarkMenu(); });
            historyButtonEl.addEventListener('click', (e) => { e.stopPropagation(); toggleHistoryMenu(); });
            clearHistoryButtonEl.addEventListener('click', handleClearHistory);


            addCurrentBookmarkButtonPopupEl.addEventListener('click', handleAddCurrentBookmark);
            bookmarksListPopupEl.addEventListener('click', handleBookmarkClick);
            historyListPopupEl.addEventListener('click', handleHistoryClick);

            document.addEventListener('keydown', handleGlobalKeyDown);
            contentIframeEl.addEventListener('load', handleIframeLoad);

            document.addEventListener('click', (event) => {
                if (bookmarkMenuEl.classList.contains('show') && !bookmarkMenuEl.contains(event.target) && event.target !== bookmarkButtonEl && !bookmarkButtonEl.contains(event.target)) {
                    bookmarkMenuEl.classList.remove('show');
                }
                if (historyMenuEl.classList.contains('show') && !historyMenuEl.contains(event.target) && event.target !== historyButtonEl && !historyButtonEl.contains(event.target)) {
                    historyMenuEl.classList.remove('show');
                }
            });
        }

        function toggleIframeFullscreen() { /* ... (same as original) ... */ if (!document.fullscreenElement) { if (contentIframeEl) contentIframeEl.requestFullscreen().catch(err => console.error("Fullscreen request failed:", err)); } else { if (document.exitFullscreen) document.exitFullscreen(); } }
        function handleFullscreenChange() { /* ... (same as original) ... */ const fsIconImg = document.getElementById('fullscreen-icon-img'); if (document.fullscreenElement) { document.body.classList.add('app-ui-hidden'); if (fsIconImg) {fsIconImg.src = '../images/zoom-out-white.png'; fsIconImg.alt = "Exit Fullscreen";} fullscreenButtonEl.title = "Exit Fullscreen"; } else { document.body.classList.remove('app-ui-hidden'); if (fsIconImg) {fsIconImg.src = '../images/zoom-in-white.png'; fsIconImg.alt = "Toggle Fullscreen";} fullscreenButtonEl.title = "Toggle Fullscreen"; } }
        function formatUrlInput(input) { /* ... (same as original) ... */ if (/^(?:[a-z]+:)?\/\//i.test(input)) { if(input.startsWith("//")) return "https:" + input; return input; } if (/^([a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}(\/.*)*$/.test(input) || input.startsWith("localhost:") || /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(:\d+)?(\/.*)*$/.test(input) ) return 'https://' + input; return null; }

        function navigateTo(urlInput) { /* ... (same as original) ... */ isLoading = true; currentTitle = "Loading..."; currentFavicon = null; applyBrowserCloak(); if (!urlInput || typeof urlInput !== 'string' || urlInput.trim() === '') urlInput = 'about:blank'; let targetDisplayUrl; if (urlInput === 'about:blank' || urlInput.startsWith('about:')) { targetDisplayUrl = urlInput; contentIframeEl.src = targetDisplayUrl; currentTitle = (targetDisplayUrl === 'about:blank' ? 'New Tab' : targetDisplayUrl); if (!targetDisplayUrl.startsWith('about:error')) addToHistory(currentTitle, targetDisplayUrl); isLoading = false; } else { let formattedInputUrl = formatUrlInput(urlInput.trim()); if (!formattedInputUrl) { const searchEngine = searchEngines[currentSearchEngineKey] || searchEngines['duckduckgo']; targetDisplayUrl = searchEngine.url.replace('%s', encodeURIComponent(urlInput.trim())); } else { targetDisplayUrl = formattedInputUrl; } if (typeof __uv$config === 'undefined' || !__uv$config.prefix || typeof __uv$config.encodeUrl !== 'function') { const errorUrl = `about:error#uv_config_missing&url=${encodeURIComponent(targetDisplayUrl)}`; contentIframeEl.src = errorUrl; targetDisplayUrl = errorUrl; currentTitle = "Error: UV Config Missing"; isLoading = false; } else { try { contentIframeEl.src = self.location.origin + __uv$config.prefix + __uv$config.encodeUrl(targetDisplayUrl); } catch (err) { const errorUrl = `about:error#navigation_failed&message=${encodeURIComponent(err.message)}&query=${encodeURIComponent(urlInput)}`; contentIframeEl.src = errorUrl; targetDisplayUrl = errorUrl; currentTitle = "Navigation Error"; isLoading = false; } } } currentUrl = targetDisplayUrl; searchBarEl.value = (currentUrl && currentUrl !== 'about:blank' && !currentUrl.startsWith('about:error')) ? currentUrl : ''; updateBrowserAddressBar(); }

        function handleIframeLoad() { /* ... (same as original) ... */ isLoading = false; const refreshIcon = refreshButtonEl.querySelector('.icon-img'); if (isRefreshing && refreshIcon) { refreshIcon.classList.remove('spinning'); isRefreshing = false; } try { if (contentIframeEl.contentWindow && contentIframeEl.contentDocument) { currentTitle = contentIframeEl.contentDocument.title || new URL(currentUrl).hostname || 'Untitled'; currentFavicon = getFaviconFromIframe(); } } catch (e) { try { currentTitle = new URL(currentUrl).hostname || 'New Tab'; } catch {} currentFavicon = getDefaultFaviconForUrl(currentUrl); console.warn("VERN MAX Debug: Error accessing iframe content on load for URL:", currentUrl, e); } if (currentUrl && currentUrl.startsWith('about:error')) currentTitle = "Error Page"; applyBrowserCloak(); if (currentUrl && !currentUrl.startsWith('about:error') && !currentUrl.startsWith('about:blank')) { addToHistory(currentTitle, currentUrl); } }
        function handleGlobalKeyDown(e) { /* ... (same as original, adjusted) ... */ const targetTagName = e.target.tagName.toLowerCase(); if (targetTagName === 'input' || targetTagName === 'textarea' || targetTagName === 'select' || e.target.isContentEditable) return; if (e.altKey && e.key === 'ArrowLeft') { e.preventDefault(); backButtonEl.click(); } if (e.altKey && e.key === 'ArrowRight') { e.preventDefault(); forwardButtonEl.click(); } if (e.key === 'F5' || ((e.ctrlKey || e.metaKey) && e.key === 'r')) { e.preventDefault(); refreshButtonEl.click(); } if ((e.ctrlKey || e.metaKey) && e.key === 'l') { e.preventDefault(); searchBarEl.focus(); searchBarEl.select(); }}

        function loadBookmarks() { /* ... (same as original, targets bookmarksListPopupEl) ... */ const bms = JSON.parse(localStorage.getItem('vernBookmarks') || '[]'); bookmarksListPopupEl.innerHTML = ''; bms.forEach(bm => renderBookmarkItem(bm)); }
        function saveBookmarks(bms) { /* ... (same as original) ... */ localStorage.setItem('vernBookmarks', JSON.stringify(bms)); }
        function renderBookmarkItem(bm) { /* ... (same as original, targets bookmarksListPopupEl) ... */ const itemFragment = bookmarkItemTemplate.content.cloneNode(true); const li = itemFragment.querySelector('li'); const nameSpan = itemFragment.querySelector('.item-name'); const urlSpan = itemFragment.querySelector('.item-url'); const removeBtn = itemFragment.querySelector('.item-remove-button'); li.dataset.url = bm.url; li.title = `${bm.name}\n${bm.url}`; nameSpan.textContent = bm.name.length > 20 ? bm.name.substring(0,18) + '...' : bm.name; urlSpan.textContent = bm.url.length > 25 ? bm.url.substring(0, 22) + '...' : bm.url; removeBtn.onclick = (e) => { e.stopPropagation(); removeBookmark(bm.url); }; bookmarksListPopupEl.appendChild(li); }
        function handleAddCurrentBookmark() { /* ... (same as original, uses newBookmarkNameInputPopupEl) ... */ if (!currentUrl || currentUrl === 'about:blank' || currentUrl.startsWith('about:')) { alert("Cannot bookmark this page."); return; } const name = newBookmarkNameInputPopupEl.value.trim() || currentTitle || new URL(currentUrl).hostname; const url = currentUrl; let bms = JSON.parse(localStorage.getItem('vernBookmarks') || '[]'); if (bms.some(b => b.url === url)) { alert("This page is already bookmarked."); return; } bms.push({ name, url }); saveBookmarks(bms); renderBookmarkItem({ name, url }); newBookmarkNameInputPopupEl.value = ''; }
        function removeBookmark(urlToRemove) { /* ... (same as original) ... */ let bms = JSON.parse(localStorage.getItem('vernBookmarks') || '[]'); bms = bms.filter(b => b.url !== urlToRemove); saveBookmarks(bms); loadBookmarks(); }
        function handleBookmarkClick(e) { /* ... (same as original, closes bookmarkMenuEl) ... */ const li = e.target.closest('li[data-url]'); if (li && !e.target.closest('.item-remove-button')) { navigateTo(li.dataset.url); bookmarkMenuEl.classList.remove('show'); } }

        function addToHistory(title, url) { /* ... (same as original) ... */ if (!url || url === 'about:blank' || url.startsWith('about:')) return; if (sessionHistory.length > 0 && sessionHistory[sessionHistory.length - 1].url === url && sessionHistory[sessionHistory.length - 1].title === title) return; sessionHistory.push({ title: title || url, url, timestamp: new Date() }); if (sessionHistory.length > MAX_HISTORY_ITEMS) sessionHistory.shift(); renderHistory(); }
        function renderHistory() { /* ... (same as original, targets historyListPopupEl) ... */ historyListPopupEl.innerHTML = ''; [...sessionHistory].reverse().forEach(item => { const itemFragment = historyItemTemplate.content.cloneNode(true); const li = itemFragment.querySelector('li'); const titleSpan = itemFragment.querySelector('.item-name'); const urlSpan = itemFragment.querySelector('.item-url'); li.dataset.url = item.url; li.title = `${item.title}\n${item.url}\n${item.timestamp.toLocaleTimeString()}`; titleSpan.textContent = item.title && item.title.length > 22 ? item.title.substring(0,19) + '...' : item.title || item.url; urlSpan.textContent = item.url.length > 25 ? item.url.substring(0, 22) + '...' : item.url; historyListPopupEl.appendChild(li); }); }
        function handleHistoryClick(e) { /* ... (same as original, closes historyMenuEl) ... */ const li = e.target.closest('li[data-url]'); if (li) { navigateTo(li.dataset.url); historyMenuEl.classList.remove('show'); } }

        function handleClearHistory() {
            if (confirm("Are you sure you want to clear the session history?")) {
                sessionHistory = [];
                renderHistory(); // Re-render the now empty list
                // historyMenuEl.classList.remove('show'); // Optionally close menu
            }
        }

        function positionMenuUnderButton(menuEl, buttonEl) {
            const btnRect = buttonEl.getBoundingClientRect();
            const toolbarRect = toolbarEl.getBoundingClientRect(); // Assuming toolbarEl is globally accessible

            menuEl.style.top = (toolbarRect.height + 5) + 'px'; // Position below toolbar

            // Align menu's right edge with button's right edge
            // This calculation positions the menu so its right edge aligns with the button's right edge relative to the viewport
            menuEl.style.right = (document.documentElement.clientWidth - btnRect.right) + 'px';
            menuEl.style.left = 'auto'; // Ensure left is not conflicting
        }

        function toggleBookmarkMenu() {
            historyMenuEl.classList.remove('show'); // Close other menu
            bookmarkMenuEl.classList.toggle('show');
            if (bookmarkMenuEl.classList.contains('show')) {
                positionMenuUnderButton(bookmarkMenuEl, bookmarkButtonEl);
            }
        }
        function toggleHistoryMenu() {
            bookmarkMenuEl.classList.remove('show'); // Close other menu
            historyMenuEl.classList.toggle('show');
            if (historyMenuEl.classList.contains('show')) {
                positionMenuUnderButton(historyMenuEl, historyButtonEl);
            }
        }

    </script>
</body>
</html>
