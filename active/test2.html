<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' blob:;
        connect-src 'self' https://api.allorigins.win wss:;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data:;
        frame-src 'self' blob: data:;
        object-src 'none';
        base-uri 'none';
        form-action 'none';
    ">

    <meta http-equiv="Permissions-Policy" content="
        accelerometer=(),
        autoplay=(),
        camera=(),
        display-capture=(),
        document-domain=(),
        encrypted-media=(),
        fullscreen=(),
        geolocation=(),
        gyroscope=(),
        magnetometer=(),
        microphone=(),
        midi=(),
        payment=(),
        picture-in-picture=(),
        publickey-credentials-get=(),
        screen-wake-lock=(),
        sync-xhr=(),
        usb=(),
        web-share=(),
        xr-spatial-tracking=()
    ">
    <title>VERN MAX</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link rel="icon" type="image/x-icon" href="../images/favicon.png" id="app-favicon" />
    <style id="custom-styles">
        @import url('https://fonts.googleapis.com/css2?family=Bangers&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Crete+Round&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap');

        /* Core Theme Variables & Component Mappings */
        :root {
            --current-theme-bg: #23272A;
            --current-theme-text: #E0E1DD;
            --current-theme-accent: #7F5AF0;
            --current-theme-neutral: #2C2F33;
            --current-theme-button-text: #FFFFFF;
            --current-theme-shadow-rgb: 0, 0, 0;
            --current-theme-shadow-opacity-strong: 0.4;
            --current-theme-shadow-opacity-medium: 0.25;
            --current-theme-shadow-opacity-light: 0.15;
            --current-theme-focus-ring-color: var(--current-theme-accent);

            --bg-color: var(--current-theme-bg);
            --text-color: var(--current-theme-text);
            --iframe-bg: var(--current-theme-bg);
            --font-family-main: 'PrimaryFont', sans-serif;

            --toolbar-bg: var(--current-theme-neutral);
            --toolbar-shadow: 0 2px 5px rgba(var(--current-theme-shadow-rgb), var(--current-theme-shadow-opacity-medium));
            --toolbar-border-color: color-mix(in srgb, var(--current-theme-neutral) 70%, var(--current-theme-text));

            --button-bg: var(--current-theme-accent);
            --button-hover-bg: color-mix(in srgb, var(--current-theme-accent) 80%, var(--current-theme-text));
            --button-text-color: var(--current-theme-button-text);
            --button-outline-color: color-mix(in srgb, var(--current-theme-accent) 60%, transparent);

            --input-bg: color-mix(in srgb, var(--current-theme-neutral) 90%, var(--current-theme-bg));
            --input-focus-bg: var(--current-theme-bg);
            --input-focus-shadow: 0 0 0 2px color-mix(in srgb, var(--current-theme-focus-ring-color) 50%, transparent);

            --menu-bg: var(--input-bg);
            --menu-item-hover-bg: var(--button-hover-bg);
            --menu-text-color: var(--text-color);
            --menu-shadow: 0 4px 12px rgba(var(--current-theme-shadow-rgb), var(--current-theme-shadow-opacity-strong));
            --menu-border-color: var(--button-outline-color);
           }

        /* Base Styles */
        html, body {
            margin: 0; padding: 0; border: none; box-sizing: border-box;
            width: 100%; height: 100%; overflow: hidden;
            font-family: var(--font-family-main);
            background-color: var(--bg-color); color: var(--text-color);
            display: flex; flex-direction: column;
           }
        canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; display: none; pointer-events: none; }

        /* Toolbar */
        #toolbar {
            display: flex; align-items: center; padding: 8px 10px;
            background-color: var(--toolbar-bg); box-shadow: var(--toolbar-shadow);
            border-bottom: 1px solid var(--toolbar-border-color); z-index: 1000; position: relative;
           }
        .nav-button, .toolbar-button {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            margin-right: 8px; border-radius: 25%; background-color: var(--button-bg);
            cursor: pointer; color: var(--button-text-color); transition: background-color 0.2s, color 0.2s;
            box-shadow: 0 0 0 1px var(--button-outline-color); font-size: 20px;
            position: relative; flex-shrink: 0;
           }
        .nav-button:hover, .toolbar-button:hover { background-color: var(--button-hover-bg); }
        .nav-button .icon-img, .toolbar-button .icon-img {
            width: 20px; height: 20px; user-select: none; pointer-events: none;
           }
        #search-bar-container { flex: 1; position: relative; margin-right: 8px; }
        #search-bar {
            width: 100%; height: 36px; border-radius: 8px; border: none; background-color: var(--input-bg);
            color: var(--text-color); padding: 0 15px; font-size: 14px;
            box-shadow: 0 0 0 1px var(--button-outline-color); font-family: var(--font-family-main);
            box-sizing: border-box;
           }
        #search-bar:focus { outline: none; background-color: var(--input-focus-bg); box-shadow: var(--input-focus-shadow); }
        #settings-button { margin-right: 0; }

        /* Menus */
        .mini-menu {
            position: absolute; background-color: var(--menu-bg);
            border: 1px solid var(--menu-border-color); border-radius: 16px;
            box-shadow: var(--menu-shadow); z-index: 1005; 
            min-width: 330px; max-width: 400px; max-height: 500px;
            overflow-y: auto; padding: 10px;
            color: var(--menu-text-color); opacity: 0; visibility: hidden;
            transform: translateY(-10px) scale(0.98);
            transition: opacity 0.25s ease-out, transform 0.25s ease-out, visibility 0s linear 0.25s;
           }
        .mini-menu.show {
            opacity: 1; visibility: visible; transform: translateY(0) scale(1);
            transition: opacity 0.25s ease-out, transform 0.25s ease-out, visibility 0s linear 0s;
           }
        .mini-menu h3 {
            margin-top: 0; margin-bottom: 10px; font-size: 1.1em;
            border-bottom: 1px solid var(--toolbar-border-color); padding-bottom: 8px;
            font-weight: 600; display: flex; align-items: center; gap: 8px;
           }
        .mini-menu ul { list-style: none; padding: 0; margin: 0; }
        .mini-menu::-webkit-scrollbar, .mini-menu ul::-webkit-scrollbar { width: 5px; }
        .mini-menu::-webkit-scrollbar-thumb, .mini-menu ul::-webkit-scrollbar-thumb { background-color: var(--button-outline-color); border-radius: 8px; }

        /* Menu Items & Controls */
        .mini-menu li {
            padding: 9px 15px; margin-bottom: 7px; border-radius: 12px;
            cursor: pointer; font-size: 0.9em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            transition: background-color 0.2s ease, color 0.2s ease;
            background-color: color-mix(in srgb, var(--current-theme-neutral) 70%, var(--current-theme-bg));
            color: var(--text-color); position: relative;
           }
        .mini-menu li:hover { background-color: var(--menu-item-hover-bg); color: var(--button-text-color); }
        .mini-menu li .item-url { font-size: 0.75em; opacity: 0.7; display: block; margin-top: 2px; }
        .mini-menu .item-remove-button {
            position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; padding: 5px;
            opacity: 0.7; display:inline-flex; align-items:center; justify-content:center;
            background: none; border: none; color: inherit;
           }
        .mini-menu .item-remove-button:hover { opacity: 1; background-color: rgba(var(--current-theme-shadow-rgb),0.1); border-radius: 50%; }
        .mini-menu .item-remove-icon { width: 12px; height: 12px; display: block; }
        .history-group-header {
            font-size: 0.8em; font-weight: bold; color: var(--text-color);
            opacity: 0.7; padding: 10px 15px 5px; text-transform: uppercase;
           }
        .mini-menu .menu-action-bar { margin-top:15px; padding-top:10px; border-top: 1px solid var(--toolbar-border-color); }
        .mini-menu .menu-input, .mini-menu .menu-select {
            width: 100%; height: 38px; padding: 0 15px; margin-bottom: 10px;
            background-color: var(--input-bg); color: var(--text-color);
            border: none; border-radius: 12px; font-family: var(--font-family-main);
            box-sizing: border-box; box-shadow: 0 0 0 1px var(--button-outline-color); font-size: 0.9em;
           }
        .mini-menu .menu-input:focus, .mini-menu .menu-select:focus { outline: none; background-color: var(--input-focus-bg); box-shadow: var(--input-focus-shadow); }
        .mini-menu .menu-button {
            width: 100%; height: 38px; padding: 0 15px; background-color: var(--button-bg);
            color: var(--button-text-color); border: none; border-radius: 12px; cursor: pointer;
            transition: background-color 0.2s ease; font-family: var(--font-family-main);
            box-shadow: 0 0 0 1px var(--button-outline-color); display: flex;
            align-items: center; justify-content: center; font-size: 0.9em; font-weight: 500;
           }
        .mini-menu .menu-button:hover { background-color: var(--button-hover-bg); }
        .mini-menu .menu-button .icon-img { width: 16px; height: 16px; margin-right: 8px; }
        .mini-menu .menu-button.clear-button { background-color: color-mix(in srgb, var(--current-theme-accent) 60%, #c0392b); }
        .mini-menu .menu-button.clear-button:hover { background-color: #c0392b; }

        /* Settings Menu */
        .menu-setting-item { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
        .menu-setting-item label { font-size: 0.85em; opacity: 0.8; padding-left: 5px; }
        .menu-setting-item.with-details { flex-direction: row; align-items: center; justify-content: space-between; }
        .menu-setting-item.with-details .menu-select { flex-grow: 1; }
        .details-button {
            flex-shrink: 0; width: 28px; height: 28px; margin-left: 10px;
            background-color: color-mix(in srgb, var(--current-theme-neutral) 70%, var(--current-theme-bg));
            border: 1px solid var(--button-outline-color); color: var(--text-color);
            border-radius: 50%; cursor: pointer; font-size: 16px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
           }
        .details-button:hover { background-color: var(--current-theme-neutral); }

        /* Toggle Switch Styles */
        .menu-setting-item.toggle-item {
            flex-direction: row; justify-content: space-between; align-items: center; padding: 4px 5px;
           }
        .toggle-label-container { display: flex; flex-direction: column; gap: 4px; margin-right: 10px; }
        .menu-setting-item.toggle-item .toggle-label-container label { padding-left: 0; margin-bottom: 0; cursor: pointer; }
        .toggle-description { font-size: 0.8em; opacity: 0.7; pointer-events: none; }
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-switch .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: color-mix(in srgb, var(--current-theme-neutral) 70%, var(--current-theme-bg));
            transition: .3s; border-radius: 24px; border: 1px solid var(--button-outline-color);
           }
        .toggle-switch .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px;
            background-color: var(--text-color); transition: .3s; border-radius: 50%;
           }
        .toggle-switch input:checked + .slider { background-color: var(--current-theme-accent); }
        .toggle-switch input:checked + .slider:before { transform: translateX(20px); background-color: var(--current-theme-button-text); }
        #save-timestamp { font-size: 0.8em; opacity: 0.8; margin-left: 8px; }
        
        /* Conditional Custom Sections */
        #custom-theme-settings-container,
        #custom-history-days-container {
            opacity: 0; max-height: 0; overflow: hidden; margin-top: 0; padding-top: 0; border-top: none;
            transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out, margin-top 0.3s, padding-top 0.3s, border-top 0.3s;
           }
        #custom-theme-settings-container.visible,
        #custom-history-days-container.visible {
            opacity: 1; max-height: 500px; margin-top: 15px; padding-top: 10px;
            border-top: 1px solid var(--toolbar-border-color);
           }
        
        /* Style for color inputs to match other inputs */
        .mini-menu .menu-input[type="color"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 100%; height: 38px; padding: 0; border: none; background: transparent; cursor: pointer;
           }
        .mini-menu .menu-input[type="color"]::-webkit-color-swatch-wrapper { padding: 4px; }
        .mini-menu .menu-input[type="color"]::-webkit-color-swatch { border: none; border-radius: 8px; }
        .mini-menu .menu-input[type="color"]::-moz-color-swatch { border: none; border-radius: 8px; }

        /* Main Content */
        #content-container { flex: 1; position: relative; background-color: var(--iframe-bg); overflow: hidden; }
        #content-iframe { width: 100%; height: 100%; border: none; display: block; }
        #refresh-button .icon-img.spinning { animation: spinRefreshIcon 0.7s linear infinite; }
        @keyframes spinRefreshIcon { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        body.app-ui-hidden #toolbar { display: none !important; }

        /* Homepage Styles */
        #homepage {
            display: none; flex-direction: column; justify-content: center; align-items: center;
            height: 100%; text-align: center; background-color: var(--bg-color);
            padding: 20px; box-sizing: border-box;
           }
        #homepage-logo { max-width: 280px; height: auto; margin-bottom: 30px; }
        #homepage-search-container {
            position: relative; width: 100%; max-width: 584px; height: 38px;
            display: flex; align-items: center; border-radius: 8px;
            background-color: var(--input-bg); border: none;
            box-shadow: 0 0 0 1px var(--button-outline-color); transition: background-color 0.2s, box-shadow 0.2s;
           }
        #homepage-search-container:focus-within { background-color: var(--input-focus-bg); box-shadow: var(--input-focus-shadow); }
        #homepage-search-bar {
            flex: 1; height: 36px; border: none; background: transparent; color: var(--text-color);
            padding: 0 15px; font-size: 14px; box-sizing: border-box; outline: none; font-family: var(--font-family-main);
           }
        #homepage-search-icon {
            width: 18px; height: 18px; padding: 9px; border-radius: 50%;
            margin-right: 5px; cursor: pointer; transition: background-color 0.2s;
           }
        #homepage-search-icon:hover { background-color: rgba(var(--current-theme-shadow-rgb), 0.1); }
        
        /* Search Suggestions & Explanations */
        .search-suggestions-list {
            display: none; position: absolute; top: calc(100% + 5px); left: 0; right: 0;
            background-color: var(--menu-bg); border: 1px solid var(--menu-border-color); border-radius: 12px;
            list-style: none; padding: 10px 0; margin: 0; text-align: left; z-index: 1010; box-shadow: var(--menu-shadow);
           }
        .search-suggestions-list li { padding: 10px 20px; cursor: pointer; color: var(--text-color); }
        .search-suggestions-list li:hover { background-color: var(--menu-item-hover-bg); color: var(--button-text-color); }
        .search-engine-explanation, .setting-explanation {
            font-size: 0.8em; color: var(--text-color); opacity: 0.7;
            margin-top: -8px; margin-bottom: 10px; padding-left: 5px;
           }

        /* Settings Sections */
        .settings-section {
            margin-bottom: 20px; padding-top: 10px; border-top: 1px solid var(--toolbar-border-color);
           }
        .settings-section:first-child { border-top: none; padding-top: 0; }
        .settings-section h3 {
            margin-top: 0; margin-bottom: 10px; font-size: 1.1em; border-bottom: none;
            padding-bottom: 0; display: flex; align-items: center; gap: 8px; padding-left: 5px;
           }
        #settings-menu .menu-setting-item,
        #settings-menu .menu-action-bar {
            padding: 8px 10px; border-radius: 8px;
            background-color: color-mix(in srgb, var(--current-theme-neutral) 50%, var(--current-theme-bg) 20%);
            margin-bottom: 10px;
           }
        #settings-menu .menu-setting-item:last-child { margin-bottom: 0; }
        
        /* Ad Block Counter & Details Modal */
        #ad-block-counter-container {
            margin-top: 15px; padding: 12px 15px; border-radius: 12px;
            background-color: color-mix(in srgb, var(--current-theme-accent) 20%, transparent);
            border: 1px solid var(--button-outline-color); text-align: center; font-size: 0.9em;
            display: none; color: color-mix(in srgb, var(--text-color) 80%, transparent);
           }
        #ad-block-counter-container .blocked-count {
            color: var(--text-color); font-weight: 600; font-size: 1.1em;
           }
        #ad-blocker-details-modal {
            display: none; position: fixed; z-index: 9998; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(var(--current-theme-shadow-rgb), 0.6);
            backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
           }
        .ad-blocker-details-content {
            background-color: var(--current-theme-bg); margin: 10% auto; padding: 25px;
            border: 1px solid var(--button-outline-color); border-radius: 16px;
            width: 80%; max-width: 550px; box-shadow: var(--menu-shadow);
           }
        .ad-blocker-details-content h4 { margin-top: 0; color: var(--current-theme-accent); }
        .ad-blocker-details-content p { font-size: 0.9em; line-height: 1.5; }
        .ad-blocker-details-content ul { list-style: disc; padding-left: 20px; }
        .ad-blocker-details-content li { font-size: 0.85em; margin-bottom: 5px; }
        .ad-blocker-details-close {
            color: var(--text-color); float: right; font-size: 28px; font-weight: bold;
            line-height: 1; cursor: pointer; transition: color 0.3s;
           }
        .ad-blocker-details-close:hover, .ad-blocker-details-close:focus { color: var(--current-theme-accent); text-decoration: none; }
        .details-list-heading { font-weight: bold; margin-top: 15px; margin-bottom: 5px; opacity: 0.9; }

        /* Error Page */
        #error-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); color: var(--text-color);
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; z-index: 2000; padding: 20px; box-sizing: border-box;
           }
        #error-overlay h2 { font-size: 2em; margin-bottom: 15px; color: var(--current-theme-accent); }
        #error-overlay p { font-size: 1.1em; margin-bottom: 30px; }
        #error-home-button {
             height: 42px; padding: 0 25px; background-color: var(--button-bg);
            color: var(--button-text-color); border: none; border-radius: 12px; cursor: pointer;
            transition: background-color 0.2s ease; font-family: var(--font-family-main);
            box-shadow: 0 0 0 1px var(--button-outline-color);
            align-items: center; justify-content: center; font-size: 1em; font-weight: 500;
           }
           #error-home-button:hover { background-color: var(--button-hover-bg); }

    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <template id="bookmark-item-template">
        <li>
            <span class="item-name"></span><span class="item-url"></span>
            <button class="item-remove-button" title="Remove Bookmark"><img src="../images/cross-white.png" alt="Remove" class="item-remove-icon"></button>
        </li>
    </template>
    <template id="history-item-template">
        <li>
            <span class="item-name"></span><span class="item-url"></span>
            <button class="item-remove-button" title="Remove From History"><img src="../images/cross-white.png" alt="Remove" class="item-remove-icon"></button>
        </li>
    </template>
    <template id="history-group-template">
        <div class="history-group-header"></div>
    </template>

    <div id="toolbar">
        <div class="nav-button" id="home-button" title="Home"><img src="../images/home-white.png" alt="Home" class="icon-img"></div>
        <div class="nav-button" id="back-button" title="Back"><img src="../images/arrow-left-white.png" alt="Back" class="icon-img"></div>
        <div class="nav-button" id="forward-button" title="Forward"><img src="../images/arrow-right-white.png" alt="Forward" class="icon-img"></div>
        <div class="nav-button" id="refresh-button" title="Refresh"><img src="../images/refresh-white.png" alt="Refresh" class="icon-img"></div>
        <div id="search-bar-container">
            <input type="text" id="search-bar" placeholder="Search or type a URL">
            <ul id="top-search-suggestions" class="search-suggestions-list"></ul>
        </div>
        
        <div class="toolbar-button" id="fullscreen-button" title="Toggle Fullscreen"><img src="../images/zoom-in-white.png" alt="Toggle Fullscreen" id="fullscreen-icon-img" class="icon-img"></div>
        <div class="toolbar-button" id="bookmark-button" title="Bookmarks"><img src="../images/star-white.png" alt="Bookmarks" class="icon-img"></div>
        <div class="toolbar-button" id="history-button" title="History"><img src="../images/clock-white.png" alt="History" class="icon-img"></div>
        <div class="toolbar-button" id="settings-button" title="Settings"><img src="../images/gear-white.png" alt="Settings" class="icon-img"></div>
    </div>

    <div id="bookmark-menu" class="mini-menu">
        <h3>Bookmarks</h3>
        <ul id="bookmarks-list-popup"></ul>
        <div class="menu-action-bar">
            <input type="text" id="new-bookmark-name-popup" class="menu-input" placeholder="Bookmark Name (optional)">
            <button id="add-current-bookmark-button-popup" class="menu-button"><img src="../images/plus-symbol-white.png" alt="Add" class="icon-img">Bookmark Current Page</button>
        </div>
    </div>
    
    <div id="history-menu" class="mini-menu">
        <h3>History</h3>
        <input type="text" id="history-search-bar" class="menu-input" placeholder="Search history...">
        <ul id="history-list-popup"></ul>
        <div class="menu-action-bar">
             <button id="clear-all-history-button" class="menu-button clear-button">Clear All History</button>
        </div>
    </div>

    <div id="settings-menu" class="mini-menu">
        <h3>Settings</h3>
        
        <div class="settings-section">
            <h3>Appearance</h3>
            <div class="menu-setting-item">
                <label for="theme-selector">Theme</label>
                <select id="theme-selector" class="menu-select"></select>
            </div>
            
            <div id="custom-theme-settings-container">
                <h3>Smart Theme Generator</h3>
                <p style="font-size: 0.8em; opacity: 0.8; margin: -5px 5px 15px 5px; text-align: center;">Pick two colors, and the app will intelligently create a full theme for you.</p>
                <div class="menu-setting-item">
                    <label for="custom-theme-bg-base">Background Color</label>
                    <input type="color" id="custom-theme-bg-base" class="menu-input" value="#23272A">
                </div>
                <div class="menu-setting-item">
                    <label for="custom-theme-accent-base">Accent Color</label>
                    <input type="color" id="custom-theme-accent-base" class="menu-input" value="#7F5AF0">
                </div>
                <button id="apply-custom-theme-button" class="menu-button" style="margin-top:10px;">Apply & Save Smart Theme</button>
            </div>
        </div>

        <div class="settings-section">
            <h3>General</h3>
            <div class="menu-setting-item">
                <label for="search-engine-selector">Search Engine</label>
                <select id="search-engine-selector" class="menu-select"></select>
                <p class="search-engine-explanation">Google cannot be used due to security restrictions when using a proxy.</p>
            </div>

            <div class="menu-setting-item toggle-item">
                <div class="toggle-label-container">
                    <label for="https-enforce-toggle" style="cursor: pointer;">Always Use HTTPS</label>
                    <small class="toggle-description">Attempts to force HTTPS for all navigated URLs.</small>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="https-enforce-toggle">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="menu-setting-item">
                <label for="homepage-url-input">Custom Homepage</label>
                <input type="text" id="homepage-url-input" class="menu-input" placeholder="e.g., about:blank or a URL">
                <button id="set-current-page-as-homepage-button" class="menu-button" style="margin-top:-5px;">Set Current Page as Homepage</button>
                <button id="reset-homepage-button" class="menu-button clear-button" style="margin-top:5px;">Reset Homepage</button>
            </div>

            <div class="menu-setting-item toggle-item">
                <div class="toggle-label-container">
                    <label for="restore-session-toggle" style="cursor: pointer;">Restore Last Session</label>
                    <small class="toggle-description">Opens your last visited page when the app starts.</small>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="restore-session-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="settings-section">
            <h3>Privacy</h3>
            <div class="menu-setting-item">
                <label for="ad-block-level-selector">Smart Ad-Free</label>
                <div class="menu-setting-item with-details">
                    <select id="ad-block-level-selector" class="menu-select">
                        <option value="off">Off</option>
                        <option value="standard">Standard</option>
                        <option value="aggressive">Aggressive</option>
                        <option value="annihilator">Ad Annihilator</option>
                    </select>
                    <button id="ad-blocker-details-button" class="details-button" title="Learn more about blocking levels">?</button>
                </div>
            </div>

            <div id="ad-block-counter-container">
                VERN MAX has blocked <span class="blocked-count">0</span> ads & trackers on this page!
            </div>

            <div class="menu-setting-item toggle-item">
                <div class="toggle-label-container">
                    <label for="pause-history-toggle" style="cursor: pointer;">Pause Search History</label>
                    <small class="toggle-description">Stops recording new pages in your history.</small>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="pause-history-toggle">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="menu-setting-item">
                <label for="history-lifespan-selector">Clear History After</label>
                <select id="history-lifespan-selector" class="menu-select">
                    <option value="0">Never</option>
                    <option value="1">1 Day</option>
                    <option value="3">3 Days</option>
                    <option value="7">7 Days</option>
                    <option value="14">14 Days</option>
                    <option value="custom">Custom...</option>
                </select>
            </div>

            <div id="custom-history-days-container">
                <h3>Custom Lifespan</h3>
                <div class="menu-setting-item">
                    <label for="custom-history-days-input">Days (0-14)</label>
                    <input type="number" id="custom-history-days-input" class="menu-input" min="0" max="14" placeholder="e.g., 5">
                </div>
                <button id="apply-custom-history-days-button" class="menu-button">Set Custom Days</button>
           </div>

            <div class="menu-action-bar" id="cookie-management-container">
                <h3>Cookie Management</h3>
                <button id="clear-current-site-cookies-button" class="menu-button">Clear Current Site Cookies</button>
                <button id="clear-all-browser-cookies-button" class="menu-button clear-button" style="margin-top:10px;">Clear All Browser Cookies</button>
                <div class="menu-setting-item toggle-item" style="margin-top: 15px;">
                    <div class="toggle-label-container">
                        <label for="block-third-party-cookies-toggle" style="cursor: pointer;">Block Third-Party Cookies</label>
                        <small class="toggle-description">Prevents third-party sites from setting cookies.</small>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="block-third-party-cookies-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
        </div>

        <div class="settings-section">
            <h3>Data Management</h3>
            <div class="menu-action-bar">
                <button id="save-config-button" class="menu-button">Save Configuration <span id="save-timestamp"></span></button>
            </div>
            <button id="clear-browser-data-button" class="menu-button clear-button">Clear All Browser Data</button>
        </div>
    </div>
    
    <div id="ad-blocker-details-modal">
        <div class="ad-blocker-details-content">
            <span class="ad-blocker-details-close">&times;</span>
            <div id="ad-blocker-details-text"></div>
        </div>
    </div>


    <div id="content-container">
        <div id="homepage">
            <img id="homepage-logo" src="../images/title.png" alt="VERN MAX">
            <div id="homepage-search-container">
                <input type="text" id="homepage-search-bar" placeholder="Search or type a URL">
                <img id="homepage-search-icon" src="../images/magnify-white.png" alt="Search">
                <ul id="search-suggestions" class="search-suggestions-list"></ul>
            </div>
        </div>
        <iframe id="content-iframe" title="Content View" sandbox="allow-forms allow-modals allow-pointer-lock allow-popups allow-presentation allow-same-origin allow-scripts allow-downloads"></iframe>
        <div id="error-overlay">
            <h2>Oops! Something went wrong.</h2>
            <p>We couldn't load the page you requested. It might be down or blocking proxy access.</p>
            <button id="error-home-button">Return to Home</button>
        </div>
    </div>

    <script src="uv/uv.bundle.js" defer></script>
    <script src="uv/uv.config.js" defer></script>
    <script src="register-sw.js" defer></script>
    <script>
        // --- CONTEXT & STATE VARIABLES ---
        let currentUrl = 'about:blank';
        let currentTitle = 'New Tab';
        let isLoading = false;
        let isRefreshing = false;
        let adBlockerInterval = null;
        let adBlockerObserver = null;
        let vernBlockedItems = 0;


        const searchEngines = {
            'duckduckgo': { name: 'DuckDuckGo', url: 'https://duckduckgo.com/?q=%s' },
            'bing': { name: 'Bing', url: 'https://www.bing.com/search?q=%s' },
            'brave': { name: 'Brave Search', url: 'https://search.brave.com/search?q=%s' },
            'yahoo': { name: 'Yahoo', url: 'https://search.yahoo.com/search?p=%s' }
        };
        let currentSearchEngineKey = 'duckduckgo';

        const THEMES = {
            main: { name: "Main (Default)", colors: { bg: '#23272A', text: '#E0E1DD', accent: '#7F5AF0', neutral: '#2C2F33', btnText: '#FFFFFF' } },
            '4sp_purple': { name: "4SP Purple", colors: { bg: '#100D14', text: '#EAEAEA', accent: '#6720BD', neutral: '#1C1A21', btnText: '#FFFFFF' } },
            light: { name: "Light", colors: { bg: '#FFFFFF', text: '#222222', accent: '#EAEAEA', neutral: '#F5F5F5', btnText: '#222222' } },
            dark: { name: "Dark", colors: { bg: '#000000', text: '#EAEAEA', accent: '#222222', neutral: '#111111', btnText: '#EAEAEA' } },  
            oceanic: { name: "Serene Coast", colors: { bg: '#F0F4F8', text: '#334E68', accent: '#48BB78', neutral: '#E2E8F0', btnText: '#FFFFFF' } },
            sunset: { name: "Amber Twilight", colors: { bg: '#4C1D42', text: '#FDECB7', accent: '#F56565', neutral: '#6B315B', btnText: '#FFFFFF' } },
            forest: { name: "Evergreen", colors: { bg: '#2F4858', text: '#F7FAFC', accent: '#38A169', neutral: '#3A5B70', btnText: '#FFFFFF' } },
            rose: { name: "Sakura", colors: { bg: '#FFF5F7', text: '#702459', accent: '#ED64A6', neutral: '#FED7E2', btnText: '#FFFFFF' } },
            coffee: { name: "Latte", colors: { bg: '#F7F2ED', text: '#694A37', accent: '#A88B79', neutral: '#EFEAE4', btnText: '#FFFFFF' } },
            matrix: { name: "Terminal", colors: { bg: '#0A192F', text: '#64FFDA', accent: '#64FFDA', neutral: '#172A45', btnText: '#0A192F' } },
            cyberpunk: { name: "Neon District", colors: { bg: '#1A202C', text: '#A0AEC0', accent: '#38B2AC', neutral: '#2D3748', btnText: '#EDF2F7' } },
            dracula: { name: "Midnight", colors: { bg: '#282A36', text: '#F8F8F2', accent: '#BD93F9', neutral: '#44475A', btnText: '#F8F8F2' } },
            nord: { name: "Arctic", colors: { bg: '#2E3440', text: '#D8DEE9', accent: '#88C0D0', neutral: '#3B4252', btnText: '#2E3440' } },
            gruvbox: { name: "Groove", colors: { bg: '#282828', text: '#EBDBB2', accent: '#FABD2F', neutral: '#3C3836', btnText: '#282828' } },
            tokyo: { name: "Tokyo Night", colors: { bg: '#1A1B26', text: '#A9B1D6', accent: '#7AA2F7', neutral: '#292E42', btnText: '#FFFFFF' } },
            maroon: { name: "Maroon", colors: { bg: '#5D0000', text: '#FDE2E2', accent: '#800000', neutral: '#4E0000', btnText: '#FFFFFF' } },
            olive: { name: "Olive", colors: { bg: '#4D5D2E', text: '#F5FBEF', accent: '#6B8E23', neutral: '#3E4A2A', btnText: '#FFFFFF' } },
            teal: { name: "Teal", colors: { bg: '#004D4D', text: '#D6F5F5', accent: '#008080', neutral: '#003838', btnText: '#FFFFFF' } },
            slate: { name: "Slate", colors: { bg: '#2F3T4F', text: '#EAEAEA', accent: '#708090', neutral: '#36454F', btnText: '#FFFFFF' } },
            indigo: { name: "Indigo", colors: { bg: '#1A1B36', text: '#C5C8E6', accent: '#6A79F7', neutral: '#292E52', btnText: '#FFFFFF' } },
            black_coffee: { name: "Black Coffee", colors: { bg: '#14100C', text: '#D7D3D1', accent: '#3C3531', neutral: '#25201D', btnText: '#D7D3D1' } },
            ocean_breeze: { name: "Ocean Breeze", colors: { bg: '#F0F8FF', text: '#2F4F4F', accent: '#87CEEB', neutral: '#E6F2FF', btnText: '#FFFFFF' } },
            mint_chocolate: { name: "Mint Chocolate", colors: { bg: '#3D2B1F', text: '#F0FFF0', accent: '#98FF98', neutral: '#4E3A2B', btnText: '#3D2B1F' } },
            heinz_red: { name: "Heinz Red", colors: { bg: '#4B0000', text: '#FFF0F0', accent: '#DA291C', neutral: '#8B0000', btnText: '#FFF0F0' } },
            mustard_yellow: { name: "Mustard Yellow", colors: { bg: '#5D4B00', text: '#3B2F00', accent: '#D4A017', neutral: '#7A6300', btnText: '#3B2F00' } },
        };

        // --- AD BLOCKER BLOCKLISTS (MASSIVELY EXPANDED) ---
        const blockedDomains = [
            // Major Ad Networks & Trackers
            'doubleclick.net', 'adservice.google.com', 'googleadservices.com', 'googlesyndication.com', 'google-analytics.com', 'googletagmanager.com',
            'adnxs.com', 'adroll.com', 'criteo.com', 'pubmatic.com', 'rubiconproject.com', 'youtube-nocookie.com', 'adobedtm.com', 'facebook.net', 'connect.facebook.net',
            'scorecardresearch.com', 'zedo.com', 'adsrvr.org', 'openx.net', 'yieldmo.com', 'hotjar.com', 'yandex.ru', 'vk.com', 'statcounter.com',
            'taboola.com', 'outbrain.com', 'revcontent.com', 'bidvertiser.com', 'popads.net', 'admeld.com', 'krxd.net',
            'propellerads.com', 'adcash.com', 'yllix.com', 'exoclick.com', 'adsterra.com', 'onclickads.net', 'media.net',
            'sovrn.com', 'infolinks.com', 'contextweb.com', 'chitika.com', 'buysellads.com', 'advertising.com', 'moatads.com',
            'yieldlab.net', 'spotxchange.com', 'smartadserver.com', 'quantserve.com', 'chartbeat.com', 'mixpanel.com', 'optimizely.com',
            'kissmetrics.com', 'crazyegg.com', 'mouseflow.com', 'vwo.com', 'fullstory.com', 'loggly.com', 'newrelic.com',
            // Malicious Ad Domains & Annoyances
            '12ezo5v60.com', 'ybs2ffs7v.com', 'fvcwqkkqmuv.com', 'feed-back.systems', 'feed-back.space', 'onclickgenius.com', 'webrdr.com',
            'crptgate.com', 'coin-hive.com', 'cnhv.co', 'coinhive.com', 'load.gg', 'webmine.pro'
        ];
        const blockedSelectors = [
            // Standard Ad Selectors
            '.ad', '.ads', '.advert', '.advertisement', '.banner-ad', '.google-ad', '.g-ad', 'div[data-google-query-id]',
            '[class*="adsbygoogle"]', '[id*="google_ads"]', '[class*="ad-"]', '[id*="ad-"]', '[class*="-ad-"]', '[id*="-ad-"]',
            '.ad-banner', '.ad-container', '.ad-wrapper', '.advertisement', '.advertising', '[data-ad-slot]', '[id*="ad-slot"]',
            '#google_vignette', 'div[id^="ad_"]', 'ins.adsbygoogle', 'a[href*="/ads/"]', 'a[href*="?ad-id="]', 'a[data-ad-id]',
            'div[data-ad-format]', 'div[data-ad-unit-path]', '[aria-label="advertisement"]', 'div[data-ad-name]',
            // Video Ad Selectors
            '.ytp-ad-module', '.video-ads', '.ytp-ad-player-overlay', '.ytp-ad-skip-button-container', '.ytp-ad-preview-container', '.ytp-ad-text-overlay', '.ytp-ad-overlay',
            '.fluid_ad_com_container',
            // Advanced & Institutional Ad Selectors
            '[id^="div-gpt-ad-"]', '[class*="Display_ad_"]', '.ad-rotator', '.sidebar-ad', '.skyscraper-ad', 'div[id*="sticky_ad"]', '.sticky-ad',
            '[class*="overlay-ad"]', '[class*="ad-overlay"]', '#ad_position_box', '.ad_sponsorship', '.ad-banner-container', '[id*="ad_unit"]',
            '[id^="ad-sense-"]', '.trc_rbox_div', '.OUTBRAIN', 'div[widget-id^="outbrain_widget_"]', '[class*="native-ad"]',
            '.ad-placeholder', '.pub_300x250', '.text-ad', '.sponsored-post', '.sponsored-link', '.ads-box', 'div[aria-label="Ads"]', 'div[data-ad-manager-id]',
            'object[data*="ad.swf"]', 'embed[src*="ad.swf"]', 'div[id*="taboola"]', 'div[data-content-ad]', 'div[class*="ad-blocker-wrapper"]',
            // Popup & Interstitial Selectors
            '[class*="expandable-ad"]', '[class*="interstitial-ad"]', 'div[id*="interstitial"]', 'div[class*="pop-up-ad"]', 'div[class*="popup"]',
            'div.pn-widget', '#inpage-push', '[class*="push-prompt"]', '[id*="notification-prompt"]', '#onesignal-slidedown-container', '[class*="modal-dialog"]'
        ];
        const antiAdBlockerSelectors = [
            'div[class*="adblock"]', 'div[class*="ad-block"]', 'div[id*="adblock"]', 'div[id*="ad-block"]',
            '.adblock-overlay', '.adblock-message', '.ad-blocker-detection', '.blocker-notice', '#prebid-ad',
            '#please-disable-adblock', 'div[class*="FuckAdBlock"]', 'div[class*="BlockAdBlock"]', 'div[class*="NoAdBlock"]', 'div[class*="stopadblock"]',
            'div[style*="z-index: 9999"]', 'div[class*="modal-dialog"][id*="adblock"]', 'div[id="adblock-detect"]'
        ];
        const blockedScriptKeywords = [
            // Anti-Adblock Scripts
            'fuckadblock.js', 'blockadblock.js', 'adblock-detector.js', 'advertisement.js', 'ad-reblock.js', 'sniff.js', 'adblock-notify.js', 'detectadblock.js',
            // Analytics & Tracking Scripts
            'google-analytics.com/analytics.js', 'googletagmanager.com/gtm.js', 'hotjar.com', 'yandex.ru/metrika', 'matomo.js',
            'mixpanel.js', 'optimizely.js', 'chartbeat.js', 'quantserve.com/quant.js', 'scorecardresearch.com/beacon.js',
            // Fingerprinting & Malicious Scripts
            'fingerprint.js', 'client.js', 'webmine.js', 'coinhive.min.js', 'ad.js'
        ];

        // --- DOM ELEMENT REFERENCES ---
        let contentIframeEl, searchBarEl, homeButtonEl, backButtonEl, forwardButtonEl, refreshButtonEl,
            fullscreenButtonEl, settingsButtonEl, bookmarkButtonEl, historyButtonEl, bookmarkMenuEl, 
            historyMenuEl, settingsMenuEl, bookmarksListPopupEl, newBookmarkNameInputPopupEl, 
            addCurrentBookmarkButtonPopupEl, historyListPopupEl, toolbarEl, 
            themeSelectorEl, searchEngineSelectorEl, historyLifespanSelectorEl, clearBrowserDataButtonEl, historySearchBarEl,
            homepageEl, homepageSearchBarEl, searchSuggestionsEl,
            homepageSearchIconEl, adBlockLevelSelectorEl, saveConfigButtonEl, saveTimestampEl,
            customThemeSettingsContainerEl, customThemeBgBaseEl, customThemeAccentBaseEl, applyCustomThemeButtonEl,
            customHistoryDaysContainerEl, customHistoryDaysInputEl, applyCustomHistoryDaysButtonEl,
            httpsEnforceToggleEl, homepageUrlInputEl, setCurrentPageAsHomepageButtonEl, resetHomepageButtonEl,
            restoreSessionToggleEl, clearCurrentSiteCookiesButtonEl, clearAllBrowserCookiesButtonEl,
            blockThirdPartyCookiesToggleEl, cookieManagementContainerEl,
            topSearchSuggestionsEl, errorOverlayEl, errorHomeButtonEl, adBlockCounterContainerEl,
            adBlockerDetailsButtonEl, adBlockerDetailsModalEl, adBlockerDetailsCloseEl, adBlockerDetailsTextEl,
            pauseHistoryToggleEl, clearAllHistoryButtonEl;

        let bookmarkItemTemplate, historyItemTemplate, historyGroupTemplate;
        
        // --- AD BLOCKER ENGINE (OVERHAULED) ---
        function findAndDestroyAdContainer(element) {
            if (!element) return false;
            let current = element;
            let containerFound = false;
            // Traverse up the DOM tree a significant number of levels to find the full container
            for (let i = 0; i < 10 && current.parentElement; i++) {
                const id = (current.id || '').toLowerCase();
                const className = (current.className || '').toLowerCase();
                 if (id.includes('ad') || className.includes('ad') || id.includes('banner') || className.includes('banner') || id.includes('sponsor') || className.includes('sponsor') || id.includes('interstitial') || className.includes('interstitial') || id.includes('promo') || className.includes('promo') || id.includes('popup') || className.includes('popup')) {
                    containerFound = true;
                    break;
                }
                current = current.parentElement;
            }
            const targetToRemove = containerFound ? current : element;
            return forcefullyRemoveElement(targetToRemove);
        }

        function forcefullyRemoveElement(element) {
            // Check if the element is valid and hasn't already been processed
            if (!element || element.classList.contains('vern-removed')) return false;
            try {
                // Apply aggressive CSS to hide the element immediately
                element.style.setProperty('display', 'none', 'important');
                element.style.setProperty('visibility', 'hidden', 'important');
                element.style.setProperty('height', '0', 'important');
                element.style.setProperty('max-height', '0', 'important');
                element.style.setProperty('overflow', 'hidden', 'important');
                element.style.setProperty('pointer-events', 'none', 'important');
                element.classList.add('vern-removed'); // Mark as processed
                // Physically remove from the DOM
                if (element.parentNode) {
                    element.parentNode.removeChild(element);
                }
                return true;
            } catch (e) { return false; }
        }
        
        function updateBlockCounterDisplay() {
            if (!adBlockCounterContainerEl) return;
            const adBlockLevel = localStorage.getItem('vernAdBlockLevel') || 'standard';
            if (adBlockLevel === 'off') {
                adBlockCounterContainerEl.style.display = 'none';
                return;
            }
            adBlockCounterContainerEl.style.display = 'block';
            adBlockCounterContainerEl.innerHTML = `VERN MAX has blocked <span class="blocked-count">${vernBlockedItems}</span> ads & trackers on this page!`;
        }

        function scanAndRemoveAds(doc) {
            if (!doc || !doc.body) return;
            let newlyRemoved = 0;
            const allSelectors = [...blockedSelectors, ...antiAdBlockerSelectors];

            // Scan for and remove elements matching the blocklists
            allSelectors.forEach(selector => {
                try {
                    doc.querySelectorAll(selector + ':not(.vern-removed)').forEach(el => {
                        if (findAndDestroyAdContainer(el)) newlyRemoved++;
                    });
                } catch (e) { /* ignore errors from invalid selectors on certain pages */ }
            });
            
            // For more aggressive modes, also block known ad scripts
            const adBlockLevel = localStorage.getItem('vernAdBlockLevel');
            if(adBlockLevel === 'aggressive' || adBlockLevel === 'annihilator') {
                 doc.querySelectorAll('script:not(.vern-removed)').forEach(script => {
                    const scriptSrc = script.src || '';
                    if (blockedScriptKeywords.some(keyword => scriptSrc.includes(keyword) || blockedDomains.some(domain => scriptSrc.includes(domain)) )) {
                        if (forcefullyRemoveElement(script)) newlyRemoved++;
                    }
                });
            }

            // Attempt to fix pages broken by adblocker-blockers
            if (doc.body && doc.body.style.overflow === 'hidden') {
                doc.body.style.setProperty('overflow', 'auto', 'important');
                newlyRemoved++; // Count this as a "blocked" item as it's an anti-adblock measure.
            }
            if (doc.documentElement && doc.documentElement.style.overflow === 'hidden') {
                doc.documentElement.style.setProperty('overflow', 'auto', 'important');
            }
            
            if (newlyRemoved > 0) {
                vernBlockedItems += newlyRemoved;
                updateBlockCounterDisplay();
            }
        }

        function initializeAdBlocker(iframe) {
            const adBlockLevel = localStorage.getItem('vernAdBlockLevel') || 'standard';
            if (adBlockLevel === 'off') {
                updateBlockCounterDisplay();
                return;
            }
            try {
                const doc = iframe.contentDocument;
                if (!doc || !doc.body) return;

                // Disconnect any previous observer to prevent duplicates
                if (adBlockerObserver) adBlockerObserver.disconnect();
                // Use MutationObserver to react to dynamically added ads
                adBlockerObserver = new MutationObserver(() => scanAndRemoveAds(doc));
                adBlockerObserver.observe(doc.body, { childList: true, subtree: true });

                // Run an initial scan as soon as the page is ready
                scanAndRemoveAds(doc);

                // For the most aggressive modes, also run a timed, repeating scan
                if (adBlockLevel === 'annihilator') {
                    adBlockerInterval = setInterval(() => scanAndRemoveAds(doc), 100); // Hyper-aggressive check
                } else if (adBlockLevel === 'aggressive') {
                    adBlockerInterval = setInterval(() => scanAndRemoveAds(doc), 250); // Aggressive check
                }
            } catch (e) {
                console.warn("Ad blocker could not access iframe content.", e);
            }
        }
        
        function stopAdBlockerInstances() {
            if (adBlockerInterval) {
                clearInterval(adBlockerInterval);
                adBlockerInterval = null;
            }
            if (adBlockerObserver) {
                adBlockerObserver.disconnect();
                adBlockerObserver = null;
            }
            vernBlockedItems = 0;
        }

        // --- CORE LOGIC ---
        document.addEventListener('DOMContentLoaded', async () => {
            assignDOMElements();
            populateThemeSelector();
            populateSearchEngineSelector();
            await initUV();
            loadSettings();
            setupEventListeners();
            pruneHistory();
            loadBookmarks();
            loadHistory();
            updateSaveButtonText();
            
            const restoreSession = localStorage.getItem('vernRestoreSession') === 'true';
            const lastUrl = localStorage.getItem('vernLastUrl');
            if (restoreSession && lastUrl && lastUrl !== 'about:blank' && lastUrl !== 'about:blank#') {
                navigateTo(lastUrl);
            } else {
                navigateTo(getHomepageUrl());
            }

            window.addEventListener('beforeunload', saveSession);
        });

        function assignDOMElements() {
            toolbarEl = document.getElementById('toolbar'); contentIframeEl = document.getElementById('content-iframe'); searchBarEl = document.getElementById('search-bar'); homeButtonEl = document.getElementById('home-button'); backButtonEl = document.getElementById('back-button'); forwardButtonEl = document.getElementById('forward-button'); refreshButtonEl = document.getElementById('refresh-button'); fullscreenButtonEl = document.getElementById('fullscreen-button'); settingsButtonEl = document.getElementById('settings-button'); bookmarkButtonEl = document.getElementById('bookmark-button'); historyButtonEl = document.getElementById('history-button');
            bookmarkMenuEl = document.getElementById('bookmark-menu'); historyMenuEl = document.getElementById('history-menu'); settingsMenuEl = document.getElementById('settings-menu');
            bookmarksListPopupEl = document.getElementById('bookmarks-list-popup'); newBookmarkNameInputPopupEl = document.getElementById('new-bookmark-name-popup'); addCurrentBookmarkButtonPopupEl = document.getElementById('add-current-bookmark-button-popup');
            historyListPopupEl = document.getElementById('history-list-popup'); historySearchBarEl = document.getElementById('history-search-bar'); clearAllHistoryButtonEl = document.getElementById('clear-all-history-button');
            themeSelectorEl = document.getElementById('theme-selector'); searchEngineSelectorEl = document.getElementById('search-engine-selector'); historyLifespanSelectorEl = document.getElementById('history-lifespan-selector');
            clearBrowserDataButtonEl = document.getElementById('clear-browser-data-button');
            bookmarkItemTemplate = document.getElementById('bookmark-item-template'); historyItemTemplate = document.getElementById('history-item-template'); historyGroupTemplate = document.getElementById('history-group-template');
            homepageEl = document.getElementById('homepage'); homepageSearchBarEl = document.getElementById('homepage-search-bar'); searchSuggestionsEl = document.getElementById('search-suggestions');
            topSearchSuggestionsEl = document.getElementById('top-search-suggestions');
            homepageSearchIconEl = document.getElementById('homepage-search-icon');
            adBlockLevelSelectorEl = document.getElementById('ad-block-level-selector');
            adBlockCounterContainerEl = document.getElementById('ad-block-counter-container');
            adBlockerDetailsButtonEl = document.getElementById('ad-blocker-details-button');
            adBlockerDetailsModalEl = document.getElementById('ad-blocker-details-modal');
            adBlockerDetailsCloseEl = document.querySelector('.ad-blocker-details-close');
            adBlockerDetailsTextEl = document.getElementById('ad-blocker-details-text');
            saveConfigButtonEl = document.getElementById('save-config-button'); saveTimestampEl = document.getElementById('save-timestamp');
            customThemeSettingsContainerEl = document.getElementById('custom-theme-settings-container');
            customThemeBgBaseEl = document.getElementById('custom-theme-bg-base'); customThemeAccentBaseEl = document.getElementById('custom-theme-accent-base'); applyCustomThemeButtonEl = document.getElementById('apply-custom-theme-button');
            customHistoryDaysContainerEl = document.getElementById('custom-history-days-container'); customHistoryDaysInputEl = document.getElementById('custom-history-days-input'); applyCustomHistoryDaysButtonEl = document.getElementById('apply-custom-history-days-button');
            httpsEnforceToggleEl = document.getElementById('https-enforce-toggle');
            homepageUrlInputEl = document.getElementById('homepage-url-input');
            setCurrentPageAsHomepageButtonEl = document.getElementById('set-current-page-as-homepage-button');
            resetHomepageButtonEl = document.getElementById('reset-homepage-button');
            restoreSessionToggleEl = document.getElementById('restore-session-toggle');
            pauseHistoryToggleEl = document.getElementById('pause-history-toggle');
            clearCurrentSiteCookiesButtonEl = document.getElementById('clear-current-site-cookies-button');
            clearAllBrowserCookiesButtonEl = document.getElementById('clear-all-browser-cookies-button');
            blockThirdPartyCookiesToggleEl = document.getElementById('block-third-party-cookies-toggle');
            cookieManagementContainerEl = document.getElementById('cookie-management-container');
            errorOverlayEl = document.getElementById('error-overlay');
            errorHomeButtonEl = document.getElementById('error-home-button');
        }
        
        async function initUV() { try { await registerSW(); } catch (err) { console.error("SW registration failed:", err); }}
        
        function loadSettings() {
            const savedTheme = localStorage.getItem('vernTheme') || 'main';
            applyTheme(savedTheme);
            themeSelectorEl.value = savedTheme;
            toggleCustomThemeView(savedTheme === 'custom');
            customThemeBgBaseEl.value = localStorage.getItem('vernCustomThemeBaseBg') || '#23272A';
            customThemeAccentBaseEl.value = localStorage.getItem('vernCustomThemeBaseAccent') || '#7F5AF0';
            currentSearchEngineKey = localStorage.getItem('vernSearchEngine') || 'duckduckgo';
            searchEngineSelectorEl.value = currentSearchEngineKey;
            httpsEnforceToggleEl.checked = localStorage.getItem('vernHttpsEnforce') === 'true';
            homepageUrlInputEl.value = localStorage.getItem('vernCustomHomepage') || '';
            restoreSessionToggleEl.checked = localStorage.getItem('vernRestoreSession') === 'true';
            pauseHistoryToggleEl.checked = localStorage.getItem('vernHistoryPaused') === 'true';
            const savedLifespan = localStorage.getItem('vernHistoryLifespan') || '14';
            const standardLifespans = ['0', '1', '3', '7', '14'];
            if (standardLifespans.includes(savedLifespan)) {
                historyLifespanSelectorEl.value = savedLifespan;
                toggleCustomHistoryView(false);
            } else {
                historyLifespanSelectorEl.value = 'custom';
                customHistoryDaysInputEl.value = savedLifespan;
                toggleCustomHistoryView(true);
            }
            adBlockLevelSelectorEl.value = localStorage.getItem('vernAdBlockLevel') || 'standard';
            blockThirdPartyCookiesToggleEl.checked = localStorage.getItem('vernBlockThirdPartyCookies') === 'true';
            document.title = 'VERN MAX';
            updateBlockCounterDisplay();
        }

        function setupEventListeners() {
            fullscreenButtonEl.addEventListener('click', toggleIframeFullscreen); document.addEventListener('fullscreenchange', handleFullscreenChange);
            searchBarEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { navigateTo(e.target.value); topSearchSuggestionsEl.style.display = 'none'; } });
            searchBarEl.addEventListener('input', () => handleSearchInput(searchBarEl, topSearchSuggestionsEl));
            homeButtonEl.addEventListener('click', () => navigateTo(getHomepageUrl()));
            backButtonEl.addEventListener('click', () => contentIframeEl.contentWindow.history.back()); forwardButtonEl.addEventListener('click', () => contentIframeEl.contentWindow.history.forward());
            refreshButtonEl.addEventListener('click', () => { if (contentIframeEl.src !== 'about:blank' && !contentIframeEl.src.endsWith('#')) { const icon = refreshButtonEl.querySelector('.icon-img'); icon.classList.add('spinning'); isRefreshing = true; contentIframeEl.contentWindow.location.reload(true); } });
            contentIframeEl.addEventListener('load', handleIframeLoad);
            settingsButtonEl.addEventListener('click', (e) => { e.stopPropagation(); toggleSettingsMenu(); });
            bookmarkButtonEl.addEventListener('click', (e) => { e.stopPropagation(); toggleBookmarkMenu(); });
            historyButtonEl.addEventListener('click', (e) => { e.stopPropagation(); toggleHistoryMenu(); });
            document.addEventListener('click', (e) => {
                closeAllMenus(e);
                if (homepageSearchBarEl && !homepageSearchBarEl.contains(e.target)) searchSuggestionsEl.style.display = 'none';
                if (!searchBarEl.contains(e.target)) topSearchSuggestionsEl.style.display = 'none';
            });
            addCurrentBookmarkButtonPopupEl.addEventListener('click', handleAddCurrentBookmark);
            bookmarksListPopupEl.addEventListener('click', handleBookmarkClick);
            historyListPopupEl.addEventListener('click', handleHistoryClick);
            historySearchBarEl.addEventListener('input', () => loadHistory(historySearchBarEl.value));
            clearAllHistoryButtonEl.addEventListener('click', clearAllHistory);
            themeSelectorEl.addEventListener('change', (e) => {
                const themeKey = e.target.value;
                applyTheme(themeKey);
                localStorage.setItem('vernTheme', themeKey);
                toggleCustomThemeView(themeKey === 'custom');
            });
            searchEngineSelectorEl.addEventListener('change', (e) => { currentSearchEngineKey = e.target.value; localStorage.setItem('vernSearchEngine', e.target.value); });
            historyLifespanSelectorEl.addEventListener('change', (e) => {
                const value = e.target.value;
                toggleCustomHistoryView(value === 'custom');
                if (value !== 'custom') {
                    localStorage.setItem('vernHistoryLifespan', value);
                    pruneHistory();
                    loadHistory();
                }
            });
            adBlockLevelSelectorEl.addEventListener('change', (e) => { 
                localStorage.setItem('vernAdBlockLevel', e.target.value);
                if (currentUrl && !currentUrl.startsWith('about:')) contentIframeEl.contentWindow.location.reload(true);
                updateBlockCounterDisplay();
               });
             adBlockerDetailsButtonEl.addEventListener('click', showBlockerDetails);
             adBlockerDetailsCloseEl.addEventListener('click', (event) => {
                 event.stopPropagation(); // Prevents document click listener from firing
                 adBlockerDetailsModalEl.style.display = "none";
            });
             window.addEventListener('click', (event) => {
                 if (event.target == adBlockerDetailsModalEl) {
                     event.stopPropagation(); // Prevents document click listener from firing
                     adBlockerDetailsModalEl.style.display = "none";
                 }
            });
            applyCustomThemeButtonEl.addEventListener('click', applyAndSaveCustomTheme);
            applyCustomHistoryDaysButtonEl.addEventListener('click', applyAndSaveCustomHistoryDays);
            clearBrowserDataButtonEl.addEventListener('click', clearAllData);
            saveConfigButtonEl.addEventListener('click', saveConfiguration);
            homepageSearchBarEl.addEventListener('input', () => handleSearchInput(homepageSearchBarEl, searchSuggestionsEl));
            homepageSearchBarEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') navigateTo(e.target.value); });
            homepageSearchIconEl.addEventListener('click', () => navigateTo(homepageSearchBarEl.value));
            searchSuggestionsEl.addEventListener('mousedown', (e) => { if (e.target.tagName === 'LI') navigateTo(e.target.textContent); });
            topSearchSuggestionsEl.addEventListener('mousedown', (e) => { if (e.target.tagName === 'LI') navigateTo(e.target.textContent); });
            document.addEventListener('keydown', handleGlobalKeyDown);
            window.addEventListener('resize', () => { if (document.querySelector('.mini-menu.show')) closeAllMenus(new MouseEvent('click')); });
            httpsEnforceToggleEl.addEventListener('change', (e) => { localStorage.setItem('vernHttpsEnforce', e.target.checked); });
            homepageUrlInputEl.addEventListener('input', () => { localStorage.setItem('vernCustomHomepage', homepageUrlInputEl.value.trim()); });
            setCurrentPageAsHomepageButtonEl.addEventListener('click', () => {
                if (currentUrl && currentUrl !== 'about:blank' && currentUrl !== 'about:blank#') {
                    homepageUrlInputEl.value = currentUrl;
                    localStorage.setItem('vernCustomHomepage', currentUrl);
                    alert('Current page set as homepage!');
                } else {
                    alert('Cannot set this page as homepage.');
                }
            });
            resetHomepageButtonEl.addEventListener('click', () => {
                homepageUrlInputEl.value = '';
                localStorage.removeItem('vernCustomHomepage');
                alert('Homepage reset to default.');
            });
            restoreSessionToggleEl.addEventListener('change', (e) => { localStorage.setItem('vernRestoreSession', e.target.checked); });
            pauseHistoryToggleEl.addEventListener('change', (e) => { localStorage.setItem('vernHistoryPaused', e.target.checked); });
            errorHomeButtonEl.addEventListener('click', () => navigateTo(getHomepageUrl()));
            clearCurrentSiteCookiesButtonEl.addEventListener('click', () => {
                if (confirm("Are you sure you want to clear cookies for the current site?")) {
                    clearCookiesForCurrentSite();
                    alert("Attempted to clear cookies for the current site.");
                }
            });
            clearAllBrowserCookiesButtonEl.addEventListener('click', () => {
                if (confirm("Are you sure you want to clear ALL browser cookies?")) {
                    clearAllBrowserCookies();
                    alert("All browser cookies cleared.");
                }
            });
            blockThirdPartyCookiesToggleEl.addEventListener('change', (e) => { localStorage.setItem('vernBlockThirdPartyCookies', e.target.checked); });
        }

        function showBlockerDetails() {
            const level = adBlockLevelSelectorEl.value;
            let content = '';
            switch(level) {
                case 'off':
                    content = `<h4>Mode: Off</h4><p>No ads or trackers are being blocked. The web is unfiltered.</p>`;
                    break;
                case 'standard':
                    content = `<h4>Mode: Standard</h4><p>Provides basic, lightweight blocking. It hides the most common types of ads without affecting page performance. This mode is always running via a MutationObserver.</p>
                                <p class="details-list-heading">What it blocks:</p>
                                <ul><li>Common banner and sidebar ads</li><li>Basic pop-up ads</li></ul>`;
                    break;
                case 'aggressive':
                    content = `<h4>Mode: Aggressive</h4><p>A strong, persistent blocker that removes a wide range of ads and trackers. It actively removes ad containers to prevent them from reappearing and runs on a constant quarter-second timer.</p>
                                <p class="details-list-heading">What it blocks:</p>
                                <ul><li>All 'Standard' targets</li><li>Video ads (pre-roll, mid-roll)</li><li>Sticky and floating ads</li><li>Most anti-ad-block scripts</li><li>Many analytics trackers</li></ul>`;
                    break;
                case 'annihilator':
                    content = `<h4>Mode: Ad Annihilator</h4><p>The most extreme level of blocking. This mode uses a hyper-aggressive, constant scan to find and destroy almost all forms of advertising, trackers, and annoyances at the centisecond level (100 times per second).</p>
                                <p><b>Warning:</b> This mode is very powerful and may cause some websites to load or function incorrectly.</p>
                                <p class="details-list-heading">Simple Ads Blocked:</p>
                                <ul><li>Banner, sidebar, footer, header, pop-up, pop-under, interstitial, in-page text, search engine, and all forms of video ads (pre-roll, mid-roll, post-roll, overlay).</li></ul>
                                <p class="details-list-heading">Advanced Ads Blocked:</p>
                                <ul><li>Floating, sticky, expandable, collapsible, native ads, sponsored articles, promoted posts/tweets, suggested video ads, and all types of in-app and in-feed mobile ads.</li></ul>
                                <p class="details-list-heading">Extreme Threats Targeted:</p>
                                <ul><li>Scripts associated with server-side ads, programmatic ad channels, and user fingerprinting.</li><li>Patterns of CDN-injected content and known ad-related WebRTC streams.</li><li><b>Note:</b> True DNS hijacking or P2P injection are network-level threats and cannot be fully blocked by a webpage alone, but this mode blocks their known patterns and scripts.</li></ul>`;
                    break;
            }
            adBlockerDetailsTextEl.innerHTML = content;
            adBlockerDetailsModalEl.style.display = "block";
        }

        function navigateTo(urlInput) {
            stopAdBlockerInstances();
            isLoading = true;
            errorOverlayEl.style.display = 'none';
            searchSuggestionsEl.style.display = 'none';
            topSearchSuggestionsEl.style.display = 'none';

            let targetUrl = urlInput ? urlInput.trim() : '';
            const adBlockLevel = localStorage.getItem('vernAdBlockLevel') || 'standard';

            if (adBlockLevel !== 'off' && targetUrl) {
                try {
                    const urlHostname = new URL(formatUrlInput(targetUrl) || targetUrl).hostname;
                    if (blockedDomains.some(domain => urlHostname.includes(domain))) {
                        console.log(`[AdBlock] Blocked navigation to ad/tracker domain: ${targetUrl}`);
                        isLoading = false;
                        return;
                    }
                } catch (e) {}
            }

            if (localStorage.getItem('vernHttpsEnforce') === 'true' && targetUrl.startsWith('http://')) {
                targetUrl = 'https://' + targetUrl.substring(7);
            }
            
            if (targetUrl && !targetUrl.startsWith('about:')) {
                const formatted = formatUrlInput(targetUrl);
                targetUrl = formatted ? formatted : searchEngines[currentSearchEngineKey].url.replace('%s', encodeURIComponent(targetUrl));
            }
            
            if (!targetUrl || targetUrl.startsWith('about:')) {
                showHomepage();
                searchBarEl.value = '';
                currentUrl = 'about:blank';
            } else {
                hideHomepage();
                contentIframeEl.src = proxyUrl(targetUrl);
            }
        }

        function handleIframeLoad() {
            stopAdBlockerInstances();
            isLoading = false;
            if (isRefreshing) { refreshButtonEl.querySelector('.icon-img').classList.remove('spinning'); isRefreshing = false; }
            
            let finalUrl = 'about:blank', finalTitle = 'New Tab';
            try {
                if(contentIframeEl.contentWindow.location.href === "about:blank" || contentIframeEl.contentWindow.location.href === "about:srcdoc") throw new Error("Blank page loaded");
                if (contentIframeEl.contentWindow && contentIframeEl.contentWindow.__uv && contentIframeEl.contentWindow.__uv.location.href !== 'about:blank') {
                    finalUrl = contentIframeEl.contentWindow.__uv.location.href;
                    finalTitle = contentIframeEl.contentDocument.title || new URL(finalUrl).hostname;
                } else {
                     throw new Error("Proxy location not found");
                }
            } catch (e) { 
                if(currentUrl !== 'about:blank' && !contentIframeEl.src.startsWith('about:blank')){
                    showErrorPage();
                    return;
                }
                finalUrl = 'about:blank';
                finalTitle = 'New Tab';
            }

            const adBlockLevel = localStorage.getItem('vernAdBlockLevel') || 'standard';
            if (adBlockLevel !== 'off' && finalUrl.includes('#google_vignette')) {
                navigateTo(finalUrl.split('#google_vignette')[0]);
                return;
            }
            
            if(finalUrl === 'about:blank' || contentIframeEl.src.endsWith('#')){
                showHomepage();
                searchBarEl.value = '';
                currentUrl = 'about:blank';
            } else {
                hideHomepage();
                currentUrl = finalUrl;
                searchBarEl.value = finalUrl;
            }

            currentTitle = finalTitle;
            if (localStorage.getItem('vernRestoreSession') === 'true') localStorage.setItem('vernLastUrl', currentUrl);
            if (currentUrl && !currentUrl.startsWith('about:')) addToHistory(currentTitle, currentUrl);
            if (adBlockLevel !== 'off' && finalUrl !== 'about:blank') {
                setTimeout(() => initializeAdBlocker(contentIframeEl), 150);
            }
            updateBlockCounterDisplay();
        }

        function proxyUrl(urlToProxy) {
            if (!urlToProxy || typeof urlToProxy !== 'string' || urlToProxy.trim() === '') return null;
            if (urlToProxy.startsWith('data:')) return urlToProxy;
            if (typeof __uv$config === 'undefined') return urlToProxy;
            try { return self.location.origin + __uv$config.prefix + __uv$config.encodeUrl(urlToProxy); } 
            catch (e) { return urlToProxy; }
        }
        
        function formatUrlInput(input) { const trimmed = input.trim(); if (/^(?:[a-z]+:)?\/\//i.test(trimmed)) return trimmed; if (/^([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(\/.*)*$/.test(trimmed)) return 'https://' + trimmed; return null; }
        function getHomepageUrl() { const customHomepage = localStorage.getItem('vernCustomHomepage'); return customHomepage && customHomepage.trim() !== '' ? customHomepage : 'about:blank'; }
        function saveSession() { if (localStorage.getItem('vernRestoreSession') === 'true') localStorage.setItem('vernLastUrl', currentUrl); }

        function showHomepage() {
            homepageEl.style.display = 'flex';
            contentIframeEl.style.display = 'none';
            errorOverlayEl.style.display = 'none';
            if(contentIframeEl.src !== 'about:blank#') contentIframeEl.src = 'about:blank#';
        }
        function hideHomepage() {
            homepageEl.style.display = 'none';
            contentIframeEl.style.display = 'block';
            errorOverlayEl.style.display = 'none';
        }
        function showErrorPage() {
            homepageEl.style.display = 'none';
            contentIframeEl.style.display = 'none';
            errorOverlayEl.style.display = 'flex';
        }
        function handleSearchInput(inputElement, suggestionsElement) {
            const query = inputElement.value;
            if (query.length > 0) {
                fetch(`https://api.allorigins.win/raw?url=https://duckduckgo.com/ac/?q=${encodeURIComponent(query)}&type=json`)
                    .then(response => response.ok ? response.json() : Promise.reject('Network error'))
                    .then(data => {
                        const suggestions = data.map(item => item.phrase);
                        suggestionsElement.innerHTML = '';
                        suggestions.forEach(suggestion => {
                            const li = document.createElement('li');
                            li.textContent = suggestion;
                            suggestionsElement.appendChild(li);
                        });
                        suggestionsElement.style.display = 'block';
                    }).catch(error => {
                        console.warn("Could not fetch search suggestions:", error);
                        suggestionsElement.style.display = 'none';
                    });
            } else {
                suggestionsElement.style.display = 'none';
            }
        }
        function getHistory() { return JSON.parse(localStorage.getItem('vernHistory') || '[]'); }
        function saveHistory(history) { localStorage.setItem('vernHistory', JSON.stringify(history)); }
        function addToHistory(title, url) {
            if (localStorage.getItem('vernHistoryPaused') === 'true') return;
            if (localStorage.getItem('vernHistoryLifespan') === '0') return;
            let history = getHistory();
            if (history.length > 0 && history[history.length - 1].url === url) return;
            history.push({ title: title || url, url, timestamp: new Date().toISOString() });
            saveHistory(history);
            loadHistory(historySearchBarEl.value);
        }
        function removeHistoryItem(timestamp) {
            let history = getHistory();
            const newHistory = history.filter(item => item.timestamp !== timestamp);
            saveHistory(newHistory);
            loadHistory(historySearchBarEl.value); // Refresh the visible list
        }
        function clearAllHistory() {
            if (confirm("Are you sure you want to clear your entire search history? This cannot be undone.")) {
                saveHistory([]);
                loadHistory(); // Refresh the visible list
            }
        }
        function loadHistory(searchTerm = '') {
            const filtered = getHistory().filter(item => searchTerm ? ((item.title && item.title.toLowerCase().includes(searchTerm.toLowerCase())) || (item.url && item.url.toLowerCase().includes(searchTerm.toLowerCase()))) : true);
            renderHistory(filtered);
        }
        function renderHistory(history) {
            const fragment = document.createDocumentFragment();
            if (history.length === 0) { const li = document.createElement('li'); li.textContent = 'No history found.'; li.style.cssText = 'cursor: default; text-align: center; opacity: 0.7;'; fragment.appendChild(li); } 
            else { const grouped = {}; [...history].reverse().forEach(item => { const groupKey = new Date(item.timestamp).toDateString(); if (!grouped[groupKey]) grouped[groupKey] = []; grouped[groupKey].push(item); });
                for (const groupKey in grouped) { const headerTpl = historyGroupTemplate.content.cloneNode(true); headerTpl.querySelector('.history-group-header').textContent = groupKey; fragment.appendChild(headerTpl); 
                    grouped[groupKey].forEach(item => { 
                        const itemTpl = historyItemTemplate.content.cloneNode(true); 
                        const li = itemTpl.querySelector('li'); 
                        li.dataset.url = item.url;
                        li.dataset.timestamp = item.timestamp; // Use timestamp for unique identification
                        li.title = `${item.title}\n${item.url}`; 
                        li.querySelector('.item-name').textContent = item.title; 
                        li.querySelector('.item-url').textContent = item.url;
                        // Add click handler for the new remove button
                        li.querySelector('.item-remove-button').onclick = (e) => {
                            e.stopPropagation();
                            removeHistoryItem(item.timestamp);
                        };
                        fragment.appendChild(itemTpl); 
                    }); 
                }
            }
            historyListPopupEl.innerHTML = ''; historyListPopupEl.appendChild(fragment);
        }
        function pruneHistory() {
            const lifespanDays = Number(localStorage.getItem('vernHistoryLifespan') || 14);
            if (lifespanDays === 0) return;
            const cutoffDate = new Date(); cutoffDate.setDate(cutoffDate.getDate() - lifespanDays);
            saveHistory(getHistory().filter(item => new Date(item.timestamp) >= cutoffDate));
        }
        function loadBookmarks() { const bms = JSON.parse(localStorage.getItem('vernBookmarks') || '[]'); bookmarksListPopupEl.innerHTML = ''; bms.forEach(renderBookmarkItem); }
        function saveBookmarks(bms) { localStorage.setItem('vernBookmarks', JSON.stringify(bms)); }
        function renderBookmarkItem(bm) { const li = bookmarkItemTemplate.content.cloneNode(true).firstElementChild; li.dataset.url = bm.url; li.title = `${bm.name}\n${bm.url}`; li.querySelector('.item-name').textContent = bm.name; li.querySelector('.item-url').textContent = bm.url; li.querySelector('.item-remove-button').onclick = (e) => { e.stopPropagation(); removeBookmark(bm.url); }; bookmarksListPopupEl.appendChild(li); }
        function handleAddCurrentBookmark() { if (!currentUrl || currentUrl.startsWith('about:')) return alert("Cannot bookmark this page."); const name = newBookmarkNameInputPopupEl.value.trim() || currentTitle; let bms = JSON.parse(localStorage.getItem('vernBookmarks') || '[]'); if (bms.some(b => b.url === currentUrl)) return alert("This page is already bookmarked."); bms.push({ name, url: currentUrl }); saveBookmarks(bms); renderBookmarkItem({ name, url: currentUrl }); newBookmarkNameInputPopupEl.value = ''; }
        function removeBookmark(url) { let bms = JSON.parse(localStorage.getItem('vernBookmarks') || '[]'); saveBookmarks(bms.filter(b => b.url !== url)); loadBookmarks(); }
        function clearAllData() {
            if (confirm("Are you sure you want to clear ALL browser data? This will delete all bookmarks, history, and settings and cannot be undone.")) {
                Object.keys(localStorage).filter(k => k.startsWith('vern')).forEach(k => localStorage.removeItem(k));
                alert("All browser data has been cleared."); window.location.reload();
            }
        }
        function clearCookiesForCurrentSite() {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i]; const eqPos = cookie.indexOf("="); const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
            }
            if (contentIframeEl.contentWindow && contentIframeEl.contentWindow.location.href !== 'about:blank') {
                try {
                    contentIframeEl.contentWindow.document.cookie.split(';').forEach(function(c) {
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                    });
                    contentIframeEl.contentWindow.location.reload(true);
                } catch (e) { console.warn("Could not directly clear iframe cookies due to security restrictions:", e); }
            }
        }
        function clearAllBrowserCookies() {
            const allCookies = document.cookie.split(';');
            for (let i = 0; i < allCookies.length; i++) { document.cookie = allCookies[i].split('=')[0] + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/"; }
            window.location.reload();
        }
        function hexToRgb(hex) {
            let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }
        function getLuminance(hex) {
            const rgb = hexToRgb(hex); if (!rgb) return 0;
            const a = [rgb.r, rgb.g, rgb.b].map(v => (v /= 255) <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4));
            return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
        }
        function adjustColor(hex, percent) {
            const rgb = hexToRgb(hex); if(!rgb) return hex;
            const amount = Math.floor(2.55 * percent);
            rgb.r = Math.round(Math.max(0, Math.min(255, rgb.r + amount)));
            rgb.g = Math.round(Math.max(0, Math.min(255, rgb.g + amount)));
            rgb.b = Math.round(Math.max(0, Math.min(255, rgb.b + amount)));
            const toHex = c => ('00' + c.toString(16)).slice(-2);
            return `#${toHex(rgb.r)}${toHex(rgb.g)}${toHex(rgb.b)}`;
        }
        function generateSmartTheme(baseBg, baseAccent) {
            const bgLuminance = getLuminance(baseBg);
            const accentLuminance = getLuminance(baseAccent);
            const neutral = adjustColor(baseBg, bgLuminance < 0.5 ? 8 : -8);
            const textColor = bgLuminance > 0.4 ? '#111111' : '#FFFFFF';
            const btnTextColor = accentLuminance > 0.4 ? '#111111' : '#FFFFFF';
            return { bg: baseBg, text: textColor, accent: baseAccent, neutral: neutral, btnText: btnTextColor };
        }
        function applyAndSaveCustomTheme() {
            localStorage.setItem('vernCustomThemeBaseBg', customThemeBgBaseEl.value);
            localStorage.setItem('vernCustomThemeBaseAccent', customThemeAccentBaseEl.value);
            const generatedColors = generateSmartTheme(customThemeBgBaseEl.value, customThemeAccentBaseEl.value);
            localStorage.setItem('vernCustomThemeColors', JSON.stringify(generatedColors));
            localStorage.setItem('vernTheme', 'custom');
            themeSelectorEl.value = 'custom';
            applyTheme('custom');
            alert('Smart theme applied and saved!');
        }
        function applyAndSaveCustomHistoryDays() {
            const days = parseInt(customHistoryDaysInputEl.value, 10);
            if (isNaN(days) || days < 0 || days > 14) { alert('Please enter a number between 0 and 14.'); return; }
            localStorage.setItem('vernHistoryLifespan', days.toString());
            historyLifespanSelectorEl.value = 'custom';
            pruneHistory();
            loadHistory();
            alert(`History lifespan set to ${days} days.`);
        }
        function saveConfiguration() {
            const now = new Date();
            localStorage.setItem('vernConfigSaveTimestamp', now.toISOString());
            updateSaveButtonText();
            const originalText = saveConfigButtonEl.firstChild.textContent;
            saveConfigButtonEl.firstChild.textContent = 'Configuration Saved! ';
            setTimeout(() => { saveConfigButtonEl.firstChild.textContent = originalText; }, 1500);
        }
        function updateSaveButtonText() {
            const savedTimestampISO = localStorage.getItem('vernConfigSaveTimestamp');
            if (!savedTimestampISO) { saveTimestampEl.textContent = ''; return; }
            const savedDate = new Date(savedTimestampISO);
            const now = new Date();
            const isToday = savedDate.toDateString() === now.toDateString();
            let formattedTimestamp = isToday ? savedDate.toLocaleTimeString() : savedDate.toLocaleDateString();
            saveTimestampEl.textContent = `(${formattedTimestamp})`;
        }
        function toggleCustomThemeView(show) { customThemeSettingsContainerEl.classList.toggle('visible', show); }
        function toggleCustomHistoryView(show) { customHistoryDaysContainerEl.classList.toggle('visible', show); }
        function closeAllMenus(event) {
             if (!event || (bookmarkMenuEl.classList.contains('show') && !bookmarkMenuEl.contains(event?.target) && !bookmarkButtonEl.contains(event?.target))) bookmarkMenuEl.classList.remove('show');
             if (!event || (historyMenuEl.classList.contains('show') && !historyMenuEl.contains(event?.target) && !historyButtonEl.contains(event?.target))) historyMenuEl.classList.remove('show');
             if (!event || (settingsMenuEl.classList.contains('show') && !settingsMenuEl.contains(event?.target) && !settingsButtonEl.contains(event?.target))) settingsMenuEl.classList.remove('show');
        }
        function positionMenuUnderButton(menuEl, buttonEl) {
            const btnRect = buttonEl.getBoundingClientRect();
            menuEl.style.top = (btnRect.bottom + 5) + 'px';
            menuEl.style.right = (document.documentElement.clientWidth - btnRect.right) + 'px';
            menuEl.style.left = 'auto';
        }
        function toggleMenu(menuEl, buttonEl) {
            const isShowing = menuEl.classList.contains('show');
            closeAllMenus();
            if (!isShowing) { menuEl.classList.add('show'); positionMenuUnderButton(menuEl, buttonEl); }
        }
        function toggleBookmarkMenu() { toggleMenu(bookmarkMenuEl, bookmarkButtonEl); }
        function toggleHistoryMenu() { toggleMenu(historyMenuEl, historyButtonEl); if(historyMenuEl.classList.contains('show')) historySearchBarEl.focus(); }
        function toggleSettingsMenu() { toggleMenu(settingsMenuEl, settingsButtonEl); }
        function populateThemeSelector() {
            themeSelectorEl.innerHTML = '';
            const customThemesGroup = document.createElement('optgroup');
            customThemesGroup.label = 'Custom';
            customThemesGroup.appendChild(new Option('Custom Theme', 'custom'));
            themeSelectorEl.appendChild(customThemesGroup);
            const standardThemesGroup = document.createElement('optgroup');
            standardThemesGroup.label = 'Standard Themes';
            Object.keys(THEMES).forEach(key => {
                const theme = THEMES[key];
                const option = new Option(theme.name, key);
                standardThemesGroup.appendChild(option);
            });
            themeSelectorEl.appendChild(standardThemesGroup);
        }
        function applyTheme(themeKey) {
            const r = document.documentElement;
            document.body.className = '';
            let theme;
            if (themeKey === 'custom') {
                const customColorsJSON = localStorage.getItem('vernCustomThemeColors');
                theme = { name: "Custom", colors: customColorsJSON ? JSON.parse(customColorsJSON) : THEMES.main.colors };
            } else {
                theme = THEMES[themeKey] || THEMES.main;
            }
            const colors = theme.colors;
            r.style.setProperty('--current-theme-bg', colors.bg); r.style.setProperty('--current-theme-text', colors.text);
            r.style.setProperty('--current-theme-accent', colors.accent); r.style.setProperty('--current-theme-neutral', colors.neutral);
            r.style.setProperty('--current-theme-button-text', colors.btnText);
        }
        function populateSearchEngineSelector() { 
            searchEngineSelectorEl.innerHTML = '';
            Object.keys(searchEngines).forEach(key => searchEngineSelectorEl.add(new Option(searchEngines[key].name, key))); 
        }
        function handleBookmarkClick(e) { const li = e.target.closest('li[data-url]'); if (li) { navigateTo(li.dataset.url); closeAllMenus(); } }
        function handleHistoryClick(e) { 
            // Ensure clicks on the remove button don't trigger navigation
            if (e.target.closest('.item-remove-button')) return;
            const li = e.target.closest('li[data-url]'); 
            if (li) { navigateTo(li.dataset.url); closeAllMenus(); } 
        }
        function handleGlobalKeyDown(e) { if (e.target.tagName === 'INPUT' || e.target.isContentEditable) return; if (e.altKey && e.key === 'ArrowLeft') backButtonEl.click(); if (e.altKey && e.key === 'ArrowRight') forwardButtonEl.click(); if ((e.ctrlKey || e.metaKey) && e.key === 'r') { e.preventDefault(); refreshButtonEl.click(); } if ((e.ctrlKey || e.metaKey) && e.key === 'l') { e.preventDefault(); searchBarEl.select(); }}
        function toggleIframeFullscreen() { if (!document.fullscreenElement) contentIframeEl.requestFullscreen(); else document.exitFullscreen(); }
        function handleFullscreenChange() {
            const isFullscreen = !!document.fullscreenElement;
            document.body.classList.toggle('app-ui-hidden', isFullscreen);
            document.getElementById('fullscreen-icon-img').src = `../images/zoom-${isFullscreen ? 'out' : 'in'}-white.png`;
        }
    </script>
</body>
</html>
