<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Secure Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #b0b0b0; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .contact.active { background-color: #e0e0e0; }
        #image-input { display: none; }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
        #notification-toast.show {
             animation: fadeInOut 4s ease-in-out forwards;
        }
        /* Hide scrollbar for chat messages but keep functionality */
        #messages-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #messages-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
    </style>
</head>
<body class="bg-white text-black h-full">

    <div id="main-container" class="flex h-full w-full">

        <div class="flex flex-col w-full h-full">

            <div id="contacts-view" class="flex flex-col h-full">
                <div class="p-4 border-b border-neutral-200 flex-shrink-0">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-xl font-bold">Secure Chat</h1>
                             <div id="connection-status" class="text-xs text-neutral-500 mt-1">Status: Disconnected</div>
                        </div>
                        <div class="relative sm:hidden">
                            <button id="mobile-menu-btn" class="p-2 rounded-full hover:bg-neutral-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" /></svg>
                            </button>
                            <div id="mobile-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20">
                                <a href="#" id="mobile-create-temp-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Anonymous Chat</a>
                                <a href="#" id="mobile-join-temp-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Join Chat</a>
                            </div>
                        </div>
                        <div class="hidden sm:flex space-x-2">
                             <button id="create-temp-chat-btn" class="text-sm bg-neutral-100 hover:bg-neutral-200 px-3 py-2 rounded-md">Anonymous Chat</button>
                             <button id="join-temp-chat-btn" class="text-sm bg-black text-white hover:bg-neutral-800 px-3 py-2 rounded-md">Join Chat</button>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="user-name" class="block text-sm font-medium text-neutral-700 mb-1">Your Name (for friends)</label>
                        <input type="text" id="user-name" class="w-full bg-neutral-100 rounded-md p-2 text-sm focus:outline-none focus:ring-2 focus:ring-black" placeholder="Enter your name">
                    </div>
                    <div class="mt-3">
                        <label for="my-peer-id" class="block text-sm font-medium text-neutral-700 mb-1">Your Permanent ID (for friends)</label>
                        <div class="flex items-center bg-neutral-100 p-2 rounded-md">
                            <input id="my-peer-id" type="text" readonly class="bg-transparent w-full text-sm text-neutral-600 focus:outline-none" value="Initializing...">
                            <button id="copy-id-btn" class="ml-2 p-1 text-neutral-500 hover:text-black" title="Copy ID">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="p-2 border-b border-neutral-200 flex-shrink-0">
                     <div class="flex justify-between items-center px-2">
                        <h3 class="font-bold text-lg">Contacts</h3>
                        <button id="add-contact-btn" class="p-2 rounded-full hover:bg-neutral-200" title="Add Contact">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        </button>
                    </div>
                </div>

                <div id="contacts-scroll-area" class="flex-1 overflow-y-auto">
                    <div id="friend-requests-section" class="px-2">
                        <h4 class="px-3 text-xs font-semibold uppercase text-neutral-500 my-2">Friend Requests</h4>
                        <div id="friend-requests-list"></div>
                    </div>
                    <div id="friends-section" class="px-2 mt-4">
                        <h4 class="px-3 text-xs font-semibold uppercase text-neutral-500 my-2">Friends</h4>
                        <div id="contacts-list"></div>
                    </div>
                </div>
            </div>

            <div id="chat-view" class="hidden flex-col h-full">
                <div class="p-3 border-b border-neutral-200 flex items-center justify-between flex-shrink-0">
                    <div class="flex items-center overflow-hidden">
                        <button id="back-to-contacts-btn" class="p-2 rounded-full hover:bg-neutral-200 mr-2 flex-shrink-0" title="Back to Contacts">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                        </button>
                        <h3 id="chat-header-name" class="text-lg font-bold truncate"></h3>
                        <span id="chat-type-indicator" class="text-xs bg-neutral-200 text-neutral-600 px-2 py-0.5 rounded-full ml-3 flex-shrink-0"></span>
                    </div>
                </div>
                <div id="messages-container" class="flex-1 p-4 overflow-y-auto space-y-4"></div>
                <div class="p-2 border-t border-neutral-200 flex-shrink-0">
                    <form id="message-form" class="flex items-center bg-neutral-100 rounded-lg p-1">
                         <label id="attach-image-label" for="image-input" class="p-2 rounded-full hover:bg-neutral-200 text-neutral-600 cursor-pointer" title="Attach Image">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>
                        </label>
                        <input id="image-input" type="file" accept="image/*">
                        <input id="message-input" type="text" placeholder="Type a message..." class="bg-transparent w-full focus:outline-none px-2 text-sm" autocomplete="off">
                        <button type="submit" class="p-2 rounded-full bg-black hover:bg-neutral-800 text-white" title="Send Message">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="add-contact-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Send Friend Request</h3>
            <form id="add-contact-form">
                <div class="mb-4">
                    <label for="contact-id" class="block text-sm font-medium text-neutral-700 mb-1">Contact's Permanent ID</label>
                    <input type="text" id="contact-id" class="w-full bg-neutral-100 rounded-md p-2 text-sm focus:outline-none focus:ring-2 focus:ring-black" required>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="cancel-modal-btn px-4 py-2 rounded-md bg-neutral-200 hover:bg-neutral-300 text-sm">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-black text-white hover:bg-neutral-800 text-sm">Send Request</button>
                </div>
            </form>
        </div>
    </div>

    <div id="temp-chat-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Join Anonymous Chat</h3>
            <form id="join-temp-chat-form">
                <div class="mb-4">
                    <label for="temp-chat-code" class="block text-sm font-medium text-neutral-700 mb-1">Enter 6-Digit Code</label>
                    <input type="text" id="temp-chat-code" class="w-full bg-neutral-100 rounded-md p-2 text-sm focus:outline-none focus:ring-2 focus:ring-black tracking-widest text-center" required placeholder="123-456" maxlength="7" inputmode="numeric">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" class="cancel-modal-btn px-4 py-2 rounded-md bg-neutral-200 hover:bg-neutral-300 text-sm">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded-md bg-black text-white hover:bg-neutral-800 text-sm">Join</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-2">Confirm Deletion</h3>
            <p id="delete-confirm-text" class="mb-4 text-sm text-neutral-600">Are you sure?</p>
            <div class="flex justify-end space-x-2">
                <button type="button" class="cancel-modal-btn px-4 py-2 rounded-md bg-neutral-200 hover:bg-neutral-300 text-sm">Cancel</button>
                <button type="button" id="confirm-delete-btn" class="px-4 py-2 rounded-md bg-red-600 text-white hover:bg-red-700 text-sm">Delete</button>
            </div>
        </div>
    </div>

    <div id="notification-toast" class="fixed bottom-5 right-5 bg-black text-white py-2 px-4 rounded-lg shadow-lg text-sm opacity-0 transition-opacity"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const [
        contactsView, chatView, myPeerIdEl, copyIdBtn, userNameInput,
        connectionStatusEl, contactsListEl, friendRequestsListEl,
        chatHeaderName, chatTypeIndicator, backToContactsBtn,
        messagesContainer, messageForm, messageInput, imageInput,
        attachImageLabel, notificationToast, addContactBtn,
        createTempChatBtn, joinTempChatBtn, addContactModal,
        tempChatModal, deleteConfirmModal, addContactForm, joinTempChatForm,
        confirmDeleteBtn, tempChatCodeInput, contactIdInput, deleteConfirmText,
        mobileMenuBtn, mobileMenuDropdown, mobileCreateBtn, mobileJoinBtn
    ] = [
        'contacts-view', 'chat-view', 'my-peer-id', 'copy-id-btn', 'user-name',
        'connection-status', 'contacts-list', 'friend-requests-list',
        'chat-header-name', 'chat-type-indicator', 'back-to-contacts-btn',
        'messages-container', 'message-form', 'message-input', 'image-input',
        'attach-image-label', 'notification-toast', 'add-contact-btn',
        'create-temp-chat-btn', 'join-temp-chat-btn', 'add-contact-modal',
        'temp-chat-modal', 'delete-confirm-modal', 'add-contact-form', 'join-temp-chat-form',
        'confirm-delete-btn', 'temp-chat-code', 'contact-id', 'delete-confirm-text',
        'mobile-menu-btn', 'mobile-menu-dropdown', 'mobile-create-temp-btn', 'mobile-join-temp-btn'
    ].map(id => document.getElementById(id));
    
    // --- State Variables ---
    let peer = null;
    let tempPeer = null;
    let myPeerId = null, myName = '';
    let contacts = {}, connections = {};
    let tempConnection = null;
    let activeChat = { id: null, type: null, history: [] };
    let peerIdToDelete = null;

    // --- Utils for Memorable IDs ---
    const ADJECTIVES = ['swift', 'silent', 'brave', 'calm', 'bright', 'dark', 'gentle', 'sharp', 'quiet', 'lone', 'red', 'blue', 'green', 'iron', 'gold', 'silver', 'wild', 'clear', 'lost', 'risen'];
    const NOUNS = ['river', 'fox', 'wolf', 'storm', 'sun', 'moon', 'star', 'tree', 'wind', 'shadow', 'blade', 'arrow', 'ember', 'stone', 'echo', 'dust', 'dawn', 'fire', 'peak', 'void'];

    const generateMemorableId = () => {
        const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
        const noun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
        const num = Math.floor(10 + Math.random() * 90);
        return `${adj}-${noun}-${num}`;
    };

    // --- Crypto & Image Utils ---
    const cryptoOps = {
        generateKey: () => window.crypto.subtle.generateKey({ name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']),
        exportKey: (key) => window.crypto.subtle.exportKey('jwk', key),
        importKey: (jwk) => window.crypto.subtle.importKey('jwk', jwk, { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']),
        async encrypt(data, key) {
            const encoded = new TextEncoder().encode(JSON.stringify(data));
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const ciphertext = await window.crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, encoded);
            const combined = new Uint8Array(iv.length + ciphertext.byteLength);
            combined.set(iv, 0);
            combined.set(new Uint8Array(ciphertext), iv.length);
            return btoa(String.fromCharCode.apply(null, combined));
        },
        async decrypt(encryptedData, key) {
            try {
                const combined = new Uint8Array(atob(encryptedData).split('').map(c => c.charCodeAt(0)));
                const iv = combined.slice(0, 12);
                const ciphertext = combined.slice(12);
                const decrypted = await window.crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ciphertext);
                return JSON.parse(new TextDecoder().decode(decrypted));
            } catch (e) {
                console.error("Decryption failed:", e);
                return { type: 'system', content: "⚠️ Could not decrypt message." };
            }
        }
    };
    
    const imageUtils = {
        compress: (file, quality = 0.6, maxWidth = 800) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = Math.min(1, maxWidth / img.width);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = reject;
                img.src = event.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        })
    };

    // --- Local Storage ---
    const PERMANENT_ID_KEY = 'ssc-memorable-id-v1';
    const saveState = () => {
        localStorage.setItem('ssc-contacts-v3', JSON.stringify(contacts));
        localStorage.setItem('ssc-username-v3', myName);
    };
    const loadState = () => {
        contacts = JSON.parse(localStorage.getItem('ssc-contacts-v3') || '{}');
        myName = localStorage.getItem('ssc-username-v3') || '';
        userNameInput.value = myName;
    };
    const getPermanentId = () => localStorage.getItem(PERMANENT_ID_KEY);
    const setPermanentId = (id) => localStorage.setItem(PERMANENT_ID_KEY, id);

    // --- UI Functions ---
    const showToast = (message) => {
        notificationToast.textContent = message;
        notificationToast.classList.add('show');
        notificationToast.style.animation = 'none';
        notificationToast.offsetHeight;
        notificationToast.style.animation = null;
        setTimeout(() => notificationToast.classList.remove('show'), 4000);
    };

    const renderAllLists = () => {
        friendRequestsListEl.innerHTML = '';
        contactsListEl.innerHTML = '';
        let requestsCount = 0, friendsCount = 0;

        Object.entries(contacts).forEach(([peerId, contact]) => {
            if (contact.status === 'needs_approval') { requestsCount++; renderRequest(peerId, contact); } 
            else if (contact.status === 'pending_approval') { requestsCount++; renderPending(peerId, contact); }
            else if (contact.status === 'friends') { friendsCount++; renderFriend(peerId, contact); }
        });

        if (requestsCount === 0) friendRequestsListEl.innerHTML = `<p class="text-center text-neutral-500 text-sm p-3">No pending requests.</p>`;
        if (friendsCount === 0) contactsListEl.innerHTML = `<p class="text-center text-neutral-500 text-sm p-3">No friends yet. Add one to start chatting!</p>`;
    };
    
    const createRequestElement = (peerId, content) => {
        const el = document.createElement('div');
        el.className = 'p-3 flex items-center justify-between bg-neutral-100 rounded-md mx-2 mb-1 text-sm';
        el.innerHTML = content;
        return el;
    }

    const renderRequest = (peerId, contact) => {
        const el = createRequestElement(peerId, `
            <div class="truncate"><p class="font-semibold truncate">${contact.name}</p><p class="text-xs text-neutral-500">Wants to be your friend</p></div>
            <div class="flex-shrink-0 flex space-x-2">
                <button class="accept-request-btn p-2 bg-green-500 hover:bg-green-600 rounded-full text-white" data-peer-id="${peerId}" title="Accept"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></button>
                <button class="decline-request-btn p-2 bg-red-500 hover:bg-red-600 rounded-full text-white" data-peer-id="${peerId}" title="Decline"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>`);
        friendRequestsListEl.appendChild(el);
    };

    const renderPending = (peerId, contact) => {
        const el = createRequestElement(peerId, `
            <div class="truncate"><p class="font-semibold truncate">${contact.name || peerId}</p><p class="text-xs text-neutral-500">Request sent</p></div>
            <button class="cancel-request-btn p-2 bg-neutral-200 hover:bg-neutral-300 rounded-full" data-peer-id="${peerId}" title="Cancel Request"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
        `);
        friendRequestsListEl.appendChild(el);
    };
    
    const renderFriend = (peerId, contact) => {
        const contactEl = document.createElement('div');
        contactEl.className = `contact p-2 flex items-center justify-between cursor-pointer hover:bg-neutral-100 rounded-md mx-2 mb-1 group`;
        contactEl.dataset.peerId = peerId;
        if (activeChat.id === peerId) contactEl.classList.add('active');

        const isOnline = connections[peerId]?.open;
        const statusDot = isOnline ? 'bg-green-500' : 'bg-neutral-400';
        
        contactEl.innerHTML = `
            <div class="flex items-center overflow-hidden">
                <div class="relative flex-shrink-0">
                    <div class="w-10 h-10 bg-black text-white rounded-full flex items-center justify-center font-bold text-lg">${(contact.name || '?').charAt(0).toUpperCase()}</div>
                    <span class="absolute bottom-0 right-0 block h-2.5 w-2.5 ${statusDot} rounded-full border-2 border-white"></span>
                </div>
                <div class="ml-3 truncate"><p class="font-semibold truncate">${contact.name}</p></div>
            </div>
            <div class="flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <button class="details-btn p-2 text-neutral-400 hover:text-black flex-shrink-0" data-peer-id="${peerId}" title="Show Peer ID">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                </button>
                <button class="delete-btn p-2 text-neutral-400 hover:text-red-500 flex-shrink-0" data-peer-id="${peerId}" data-contact-name="${contact.name}" title="Remove Contact">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                </button>
            </div>`;
        contactsListEl.appendChild(contactEl);
    };

    const appendMessage = (msg, align) => {
        const { sender, type, content, timestamp, name } = msg;
        const msgEl = document.createElement('div');
        const isMe = align === 'right';
        const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        let messageContentHTML = '';
        if (type === 'text') {
            const textEl = document.createElement('p'); textEl.className = 'text-sm break-words'; textEl.textContent = content;
            messageContentHTML = textEl.outerHTML;
        } else if (type === 'image') {
            messageContentHTML = `<img src="${content}" alt="Sent image" class="rounded-lg max-w-xs cursor-pointer" onclick="window.open(this.src, '_blank')">`;
        } else if (type === 'system') {
            msgEl.className = 'text-center text-xs text-neutral-500 my-2';
            msgEl.textContent = content;
            messagesContainer.appendChild(msgEl);
            return;
        }

        msgEl.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;
        let displayName = 'You';
        if (!isMe) {
            displayName = activeChat.type === 'permanent' ? name : 'Stranger';
        }

        msgEl.innerHTML = `
            <div class="max-w-sm">
                 <p class="text-xs text-neutral-500 mb-1 px-1 ${isMe ? 'text-right' : 'text-left'}">${displayName}</p>
                <div class="px-3 py-2 rounded-lg ${isMe ? 'bg-black text-white' : 'bg-neutral-200 text-black'}">
                    ${messageContentHTML}
                </div>
                <p class="text-xs text-neutral-500 mt-1 px-1 ${isMe ? 'text-right' : 'text-left'}">${time}</p>
            </div>`;
        messagesContainer.appendChild(msgEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    };
    
    // --- View Management ---
    const showContactsView = () => {
        chatView.classList.add('hidden');
        contactsView.classList.remove('hidden');
        activeChat = { id: null, type: null, history: [] };
        if (tempPeer) { tempPeer.destroy(); tempPeer = null; }
        if (tempConnection) { tempConnection.close(); tempConnection = null; }
        renderAllLists();
    };

    const showChatView = (config) => {
        activeChat = { id: config.id, type: config.type, history: config.history || [] };
        chatHeaderName.textContent = config.name;
        chatTypeIndicator.textContent = config.type;
        attachImageLabel.style.display = config.type === 'permanent' ? 'block' : 'none';

        contactsView.classList.add('hidden');
        chatView.classList.remove('hidden');
        chatView.classList.add('flex');
        
        messagesContainer.innerHTML = '';
        const myCurrentId = activeChat.type === 'anonymous' ? tempPeer?.id : myPeerId;
        activeChat.history.forEach(msg => {
            const align = msg.sender === myCurrentId ? 'right' : 'left';
            const messageName = activeChat.type === 'permanent' ? contacts[msg.sender]?.name : null;
            appendMessage({...msg, name: messageName}, align);
        });
        
        messageInput.focus();
        renderAllLists();
    };

    /**
     * ========================================
     * PERMANENT PEER (FRIENDS) LOGIC
     * ========================================
     */
    const initializePeer = () => {
        let persistentId = getPermanentId();
        if (!persistentId) {
            persistentId = generateMemorableId();
            setPermanentId(persistentId);
        }
        peer = new Peer(persistentId, {});
        
        peer.on('open', id => {
            myPeerId = id;
            myPeerIdEl.value = id;
            if (persistentId !== id) setPermanentId(id);
            connectionStatusEl.textContent = 'Status: Online';
            connectionStatusEl.classList.add('text-green-600');
            Object.keys(contacts).forEach(pid => { if (contacts[pid].status === 'friends') connectToPeer(pid); });
        });
        
        peer.on('connection', conn => setupConnection(conn, connections, true, handlePermanentData));
        
        peer.on('error', err => {
            console.error('PeerJS error:', err);
            connectionStatusEl.textContent = `Status: Error - ${err.type}`;
            connectionStatusEl.classList.remove('text-green-600');
            connectionStatusEl.classList.add('text-red-600');
            if (err.type === 'unavailable-id') {
                showToast('Your saved ID is in use. Getting a new one.');
                localStorage.removeItem(PERMANENT_ID_KEY);
                peer.destroy();
                initializePeer();
            }
        });
    };

    const setupConnection = (conn, connPool, isPermanent, dataHandler) => {
        connPool[conn.peer] = conn;
        renderAllLists();
        conn.on('data', data => dataHandler(conn, data));
        conn.on('close', () => {
            delete connPool[conn.peer];
            if (!isPermanent) { showToast("Stranger disconnected."); showContactsView(); }
            renderAllLists();
        });
        conn.on('error', (err) => {
            console.error("Connection error:", err);
            if (!isPermanent) { showToast("Connection error."); showContactsView(); }
            renderAllLists();
        });
    };

    const connectToPeer = (peerId) => {
        if (!peer || peer.destroyed) { return; }
        if (connections[peerId]?.open) return;
        const conn = peer.connect(peerId, { reliable: true });
        if (conn) {
            setupConnection(conn, connections, true, handlePermanentData);
        }
    };
    
    const sendFriendRequest = (e) => {
        e.preventDefault();
        const targetId = contactIdInput.value.trim();
        if (!myName) { showToast('Please enter your name first.'); userNameInput.focus(); return; }
        if (targetId && targetId !== myPeerId) {
            if (contacts[targetId]) { showToast('Request already pending or you are friends.'); return; }
            
            contacts[targetId] = { name: `ID: ${targetId}`, status: 'pending_approval' };
            saveState();
            renderAllLists();
            
            const conn = peer.connect(targetId, { reliable: true });
            conn.on('open', () => {
                conn.send(JSON.stringify({ type: 'friend-request', payload: { name: myName } }));
            });

            addContactForm.reset();
            addContactModal.classList.add('hidden');
            showToast(`Friend request sent to ${targetId}`);
        }
    };

    async function acceptRequest(peerId) {
        const contact = contacts[peerId];
        if (contact?.status === 'needs_approval') {
            const key = await cryptoOps.generateKey();
            const exportedKey = await cryptoOps.exportKey(key);
            contact.status = 'friends';
            contact.key = exportedKey;
            contact.history = [];

            connectToPeer(peerId);
            
            const checkConnection = setInterval(() => {
                if (connections[peerId] && connections[peerId].open) {
                    clearInterval(checkConnection);
                    connections[peerId].send(JSON.stringify({ type: 'accept-request', payload: { name: myName, key: exportedKey } }));
                    saveState();
                    renderAllLists();
                    showToast(`You are now friends with ${contact.name}!`);
                }
            }, 100);
        }
    }

    const declineOrCancelRequest = (peerId, type) => {
        if (contacts[peerId]) {
            connectToPeer(peerId);
            const checkConnection = setInterval(() => {
                if(connections[peerId] && connections[peerId].open) {
                    clearInterval(checkConnection);
                    connections[peerId].send(JSON.stringify({ type }));
                }
            }, 100);
            delete contacts[peerId];
            saveState();
            renderAllLists();
        }
    }

    const handleDeleteContact = (peerId, options = {}) => {
        if (!options.isNotification && connections[peerId]?.open) {
            sendData(peerId, { type: 'unfriend' }, true);
        }
        if (connections[peerId]) connections[peerId].close();
        delete connections[peerId];
        delete contacts[peerId];
        saveState();
        if (activeChat.id === peerId) showContactsView();
        renderAllLists();
        if (!options.isNotification) showToast("Contact removed.");
    };

    const sendData = async (peerId, payload, isEncrypted) => {
        const conn = connections[peerId];
        if (conn?.open) {
            let dataToSend = payload;
            if(isEncrypted) {
                const key = await cryptoOps.importKey(contacts[peerId].key);
                dataToSend = await cryptoOps.encrypt(payload, key);
            } else {
                dataToSend = JSON.stringify(payload);
            }
            conn.send(dataToSend);
        } else {
            console.error("Cannot send data: No open connection to", peerId);
        }
    };

    /**
     * ========================================
     * ANONYMOUS CHAT LOGIC
     * ========================================
     */
    const cleanupTemp = () => {
        if (tempPeer) { tempPeer.destroy(); tempPeer = null; }
        if (tempConnection) { tempConnection.close(); tempConnection = null; }
    };

    const startTempChatHost = () => {
        cleanupTemp();
        const code = Math.floor(100000 + Math.random() * 900000).toString().replace(/(\d{3})/, '$1-');
        const tempId = `anon-host-${code}`;

        showToast(`Creating Anonymous Chat...`);
        tempPeer = new Peer(tempId, {});

        tempPeer.on('open', () => {
            showChatView({
                id: tempId, name: `Anonymous Chat`, type: 'anonymous',
                history: [{ type: 'system', content: `Share this code with someone: ${code}` }]
            });
        });

        tempPeer.on('connection', conn => {
            if(tempConnection) conn.close(); 
            tempConnection = conn;
            appendMessage({type: 'system', content: 'A stranger has connected. This chat is anonymous and will be deleted when either person leaves.'}, 'left');
            setupConnection(conn, {}, false, handleTempData);
        });

        tempPeer.on('error', (err) => { showToast(`Error: ${err.type}`); showContactsView(); });
    };

    const joinTempChat = (code) => {
        cleanupTemp();
        const targetId = `anon-host-${code.replace('-', '')}`;
        
        showToast(`Joining Anonymous Chat...`);
        tempPeer = new Peer(null, {});

        tempPeer.on('open', id => {
            setTimeout(() => {
                const conn = tempPeer.connect(targetId, { reliable: true });
                tempConnection = conn;
                
                showChatView({
                    id: targetId, name: 'Anonymous Chat', type: 'anonymous',
                    history: [{ type: 'system', content: `Connecting to chat ${code}...` }]
                });

                conn.on('open', () => {
                    appendMessage({type: 'system', content: `Connected! This chat is anonymous and will be deleted when either person leaves.`}, 'left');
                });
                
                setupConnection(conn, {}, false, handleTempData);
            }, 500);
        });
        
        tempPeer.on('error', (err) => { showToast(`Error: ${err.type}`); showContactsView(); });
    };

    // --- Data Handling ---
    const handleTempData = (conn, data) => {
        const message = {
            sender: conn.peer, type: 'text', content: data.content, timestamp: Date.now()
        };
        activeChat.history.push(message);
        appendMessage(message, 'left');
    };

    const handlePermanentData = async (conn, rawData) => {
        const peerId = conn.peer;
        
        let data;
        let isEncrypted = false;
        try {
            data = JSON.parse(rawData);
        } catch(e) {
            isEncrypted = true;
        }

        if (isEncrypted) {
             if (!contacts[peerId]?.key) return;
             data = await cryptoOps.decrypt(rawData, await cryptoOps.importKey(contacts[peerId].key));
        }

        switch (data.type) {
            case 'friend-request':
                if (contacts[peerId]) return;
                contacts[peerId] = { name: data.payload.name, status: 'needs_approval' };
                showToast(`New friend request from ${data.payload.name}`);
                break;
            case 'accept-request':
                 if (contacts[peerId]?.status === 'pending_approval') {
                    contacts[peerId].status = 'friends';
                    contacts[peerId].key = data.payload.key;
                    contacts[peerId].name = data.payload.name;
                    contacts[peerId].history = [];
                    showToast(`${contacts[peerId].name} accepted your request!`);
                }
                break;
            case 'decline-request':
            case 'cancel-request':
                 if (contacts[peerId]) {
                    const contactName = contacts[peerId].name;
                    delete contacts[peerId];
                    showToast(`${contactName || 'A user'} declined your request.`);
                }
                break;
            case 'chat':
                const message = { sender: peerId, ...data.payload, timestamp: Date.now() };
                contacts[peerId].history.push(message);
                if (activeChat.id === peerId) {
                    appendMessage(message, 'left');
                } else {
                    showToast(`New message from ${contacts[peerId].name}`);
                }
                break;
            case 'unfriend':
                if (contacts[peerId]) {
                    showToast(`${contacts[peerId].name} removed you as a friend.`);
                    handleDeleteContact(peerId, { isNotification: true });
                }
                break;
        }
        saveState();
        renderAllLists();
    };
    
    /**
     * ========================================
     * EVENT LISTENERS
     * ========================================
     */
    createTempChatBtn.addEventListener('click', startTempChatHost);
    joinTempChatBtn.addEventListener('click', () => tempChatModal.classList.remove('hidden'));
    addContactBtn.addEventListener('click', () => addContactModal.classList.remove('hidden'));
    backToContactsBtn.addEventListener('click', showContactsView);

    mobileMenuBtn.addEventListener('click', () => mobileMenuDropdown.classList.toggle('hidden'));
    mobileCreateBtn.addEventListener('click', (e) => { e.preventDefault(); startTempChatHost(); mobileMenuDropdown.classList.add('hidden'); });
    mobileJoinBtn.addEventListener('click', (e) => { e.preventDefault(); tempChatModal.classList.remove('hidden'); mobileMenuDropdown.classList.add('hidden'); });


    addContactForm.addEventListener('submit', sendFriendRequest);
    joinTempChatForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const code = tempChatCodeInput.value.trim();
        if (code) {
            joinTempChat(code);
            tempChatModal.classList.add('hidden');
            e.target.reset();
        }
    });
    
    messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (!text || !activeChat.id) return;
        
        const myCurrentId = activeChat.type === 'anonymous' ? tempPeer.id : myPeerId;
        const message = { sender: myCurrentId, type: 'text', content: text, timestamp: Date.now() };
        
        if (activeChat.type === 'anonymous' && tempConnection?.open) {
            tempConnection.send({ content: text });
            activeChat.history.push(message);
            appendMessage(message, 'right');
            messageInput.value = '';
        } else if (activeChat.type === 'permanent' && connections[activeChat.id]?.open) {
            await sendData(activeChat.id, { type: 'chat', payload: { type: 'text', content: text } }, true);
            contacts[activeChat.id].history.push(message);
            saveState();
            appendMessage(message, 'right');
            messageInput.value = '';
        }
    });

    document.querySelectorAll('.cancel-modal-btn').forEach(btn => {
        btn.addEventListener('click', (e) => e.target.closest('.fixed').classList.add('hidden'));
    });
    
    // Delegated listeners for dynamic content
    document.getElementById('contacts-scroll-area').addEventListener('click', (e) => {
        const detailsBtn = e.target.closest('.details-btn');
        if (detailsBtn) {
            const peerId = detailsBtn.dataset.peerId;
            alert(`Peer ID for ${contacts[peerId].name}:\n\n${peerId}`);
            return;
        }

        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
            peerIdToDelete = deleteBtn.dataset.peerId;
            deleteConfirmText.textContent = `Are you sure you want to remove "${deleteBtn.dataset.contactName}"? This will unfriend them.`;
            deleteConfirmModal.classList.remove('hidden');
            return;
        }

        const contactEl = e.target.closest('.contact');
        if(contactEl) {
            const peerId = contactEl.dataset.peerId;
            if (contacts[peerId] && contacts[peerId].status === 'friends') {
                showChatView({
                    id: peerId,
                    name: contacts[peerId].name,
                    type: 'permanent',
                    history: contacts[peerId].history || []
                });
            }
            return;
        }
        
        const acceptBtn = e.target.closest('.accept-request-btn');
        if(acceptBtn) { acceptRequest(acceptBtn.dataset.peerId); return; }
        
        const declineBtn = e.target.closest('.decline-request-btn');
        if(declineBtn) { declineOrCancelRequest(declineBtn.dataset.peerId, 'decline-request'); return; }

        const cancelBtn = e.target.closest('.cancel-request-btn');
        if(cancelBtn) { declineOrCancelRequest(cancelBtn.dataset.peerId, 'cancel-request'); return; }
    });

    confirmDeleteBtn.addEventListener('click', () => {
        if (peerIdToDelete) handleDeleteContact(peerIdToDelete);
        deleteConfirmModal.classList.add('hidden');
        peerIdToDelete = null;
    });

    // Auto-format the temp chat code input
    tempChatCodeInput.addEventListener('input', (e) => {
        let input = e.target.value.replace(/\D/g, '').substring(0,6); // Remove non-digits and limit length
        if (input.length > 3) {
            input = input.substring(0, 3) + '-' + input.substring(3);
        }
        e.target.value = input;
    });

    // --- Initialization ---
    loadState();
    initializePeer();
    renderAllLists();
});
</script>
</body>
</html>
